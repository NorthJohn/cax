[
    {
        "id": "fce55c80ba409b3d",
        "type": "tab",
        "label": "dispatch",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "a39c97029f2c005f",
        "type": "tab",
        "label": "sensors",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "e7fcf1f501be8b60",
        "type": "tab",
        "label": "scheduler",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "ce7503bf65214c43",
        "type": "tab",
        "label": "PID 2024",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "81037ebb658aa24a",
        "type": "tab",
        "label": "PID0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "3187bd06ef664359",
        "type": "tab",
        "label": "dashboard",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "78ad727ff3800ccd",
        "type": "tab",
        "label": "LAE0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d6d8802f46b4aa03",
        "type": "tab",
        "label": "ASHP0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "86219b48706129b6",
        "type": "tab",
        "label": "playspace",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "983d8c26bcee7442",
        "type": "tab",
        "label": "delay tests",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "0b049155917211c7",
        "type": "tab",
        "label": "bridge",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "892c223a74ad0925",
        "type": "tab",
        "label": "recycling bin",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "0ada38113f2dc695",
        "type": "subflow",
        "name": "Process Simulation",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 37,
                "y": 103,
                "wires": [
                    {
                        "id": "5198a3b093941629"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 728.5,
                "y": 294,
                "wires": [
                    {
                        "id": "f7ed1a411069eb16",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99",
        "status": {
            "x": 360,
            "y": 40,
            "wires": []
        }
    },
    {
        "id": "9e36a25803eb28ab",
        "type": "subflow",
        "name": "downsample",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 120,
                "y": 280,
                "wires": [
                    {
                        "id": "c566712146768d0f"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 660,
                "y": 200,
                "wires": [
                    {
                        "id": "c566712146768d0f",
                        "port": 0
                    }
                ]
            },
            {
                "x": 680,
                "y": 260,
                "wires": [
                    {
                        "id": "c566712146768d0f",
                        "port": 1
                    }
                ]
            },
            {
                "x": 640,
                "y": 320,
                "wires": [
                    {
                        "id": "c566712146768d0f",
                        "port": 2
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#FFAAAA",
        "inputLabels": [
            "datastream"
        ],
        "outputLabels": [
            "all output",
            "tracked output",
            "log"
        ],
        "status": {
            "x": 620,
            "y": 380,
            "wires": [
                {
                    "id": "c566712146768d0f",
                    "port": 3
                }
            ]
        }
    },
    {
        "id": "91e4421d067a2d1b",
        "type": "junction",
        "z": "fce55c80ba409b3d",
        "x": 520,
        "y": 60,
        "wires": [
            [
                "6ac4b5a2620be04c"
            ]
        ]
    },
    {
        "id": "2f07922ce4dbc1ad",
        "type": "junction",
        "z": "0b049155917211c7",
        "x": 100,
        "y": 340,
        "wires": [
            [
                "55db0f5201cd5d76",
                "154f1ee8c4c69a62"
            ]
        ]
    },
    {
        "id": "2b42a705743e033e",
        "type": "junction",
        "z": "892c223a74ad0925",
        "x": 380,
        "y": 180,
        "wires": [
            [
                "71fb77d41d8abc20"
            ]
        ]
    },
    {
        "id": "b9e3aea420ead0a3",
        "type": "junction",
        "z": "fce55c80ba409b3d",
        "x": 280,
        "y": 300,
        "wires": [
            [
                "3fff4148fd6087dd"
            ]
        ]
    },
    {
        "id": "06a47b37c2fd940d",
        "type": "junction",
        "z": "86219b48706129b6",
        "x": 240,
        "y": 180,
        "wires": [
            [
                "c8019270b037639a"
            ]
        ]
    },
    {
        "id": "4ccc68756097fca2",
        "type": "junction",
        "z": "3187bd06ef664359",
        "x": 840,
        "y": 520,
        "wires": [
            [
                "911fc6b6c3ef646a"
            ]
        ]
    },
    {
        "id": "911fc6b6c3ef646a",
        "type": "junction",
        "z": "3187bd06ef664359",
        "x": 600,
        "y": 860,
        "wires": [
            [
                "4a3c52fb4dc216b4"
            ]
        ]
    },
    {
        "id": "657e75936deb6112",
        "type": "junction",
        "z": "d6d8802f46b4aa03",
        "x": 540,
        "y": 260,
        "wires": [
            [
                "faf9c12a90fda8f1",
                "0b3d1bb1f851d520",
                "3434c59de55e09c4"
            ]
        ]
    },
    {
        "id": "94e8e29594123b82",
        "type": "junction",
        "z": "81037ebb658aa24a",
        "x": 260,
        "y": 200,
        "wires": [
            [
                "5b3cfcf45023a7d1"
            ]
        ]
    },
    {
        "id": "ceef6f34e224aa7a",
        "type": "junction",
        "z": "81037ebb658aa24a",
        "x": 620,
        "y": 240,
        "wires": [
            [
                "90da587f91c535d6",
                "0d802e41352713c5"
            ]
        ]
    },
    {
        "id": "81578ee3d71ff690",
        "type": "junction",
        "z": "983d8c26bcee7442",
        "x": 240,
        "y": 160,
        "wires": [
            [
                "2270be49ad12dc1b",
                "36f61a65e8c1ea04",
                "ed1964d4c490ee37",
                "a4a6ba226ad8eb31",
                "9fd29026ae963087"
            ]
        ]
    },
    {
        "id": "7abf789ae18304f4",
        "type": "junction",
        "z": "81037ebb658aa24a",
        "x": 520,
        "y": 160,
        "wires": [
            [
                "64ccfd798347cd78",
                "03c2800c0d0d2ece"
            ]
        ]
    },
    {
        "id": "c9a4d057dce73047",
        "type": "junction",
        "z": "fce55c80ba409b3d",
        "x": 280,
        "y": 60,
        "wires": [
            [
                "b71d646d0524d860",
                "06aca66c9580d0d3"
            ]
        ]
    },
    {
        "id": "6d021d84aed87757",
        "type": "junction",
        "z": "fce55c80ba409b3d",
        "x": 480,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "02815d0187518701",
        "type": "junction",
        "z": "983d8c26bcee7442",
        "x": 260,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "6a477d7286614dd4",
        "type": "junction",
        "z": "983d8c26bcee7442",
        "x": 320,
        "y": 760,
        "wires": [
            [
                "770592a223143e5e"
            ]
        ]
    },
    {
        "id": "cf9f8a576daa4234",
        "type": "junction",
        "z": "81037ebb658aa24a",
        "x": 520,
        "y": 60,
        "wires": [
            [
                "bc15fab6318b655e",
                "64ccfd798347cd78"
            ]
        ]
    },
    {
        "id": "8e63039e93edd284",
        "type": "junction",
        "z": "983d8c26bcee7442",
        "x": 520,
        "y": 480,
        "wires": [
            [
                "770592a223143e5e",
                "dd66140fd055bfae"
            ]
        ]
    },
    {
        "id": "03430b95b2adb610",
        "type": "junction",
        "z": "3187bd06ef664359",
        "x": 300,
        "y": 1340,
        "wires": [
            []
        ]
    },
    {
        "id": "b0fe4938ae189f35",
        "type": "junction",
        "z": "3187bd06ef664359",
        "x": 320,
        "y": 1340,
        "wires": [
            []
        ]
    },
    {
        "id": "8b922c8e9c5bfc9a",
        "type": "junction",
        "z": "3187bd06ef664359",
        "x": 520,
        "y": 2060,
        "wires": [
            [
                "911fc6b6c3ef646a"
            ]
        ]
    },
    {
        "id": "7f820c0f9477eb3f",
        "type": "junction",
        "z": "3187bd06ef664359",
        "x": 40,
        "y": 2960,
        "wires": [
            [
                "c60061332293cb39",
                "c46180bd2674fe18",
                "94aac4c5e81fde15"
            ]
        ]
    },
    {
        "id": "2ce60664f6ba7120",
        "type": "mqtt-broker",
        "name": "hivemq-cloud",
        "broker": "mqtts://c07335216ae5441aaa13f083bcff6484.s2.eu.hivemq.cloud",
        "port": "1883",
        "tls": "",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "9d1ae28e263fad2a",
        "type": "mqtt-broker",
        "name": "mosquitto",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "7d7a9bc368fd645d",
        "type": "influxdb",
        "hostname": "127.0.0.1",
        "port": "8086",
        "protocol": "http",
        "database": "database",
        "name": "local-influx",
        "usetls": false,
        "tls": "",
        "influxdbVersion": "1.8-flux",
        "url": "http://localhost:8086",
        "rejectUnauthorized": false
    },
    {
        "id": "6db0e35f8056298a",
        "type": "serial-port",
        "name": "USB0",
        "serialport": "/dev/ttyUSB0",
        "serialbaud": "19200",
        "databits": "8",
        "parity": "none",
        "stopbits": "1",
        "waitfor": "",
        "dtr": "none",
        "rts": "none",
        "cts": "none",
        "dsr": "none",
        "newline": "100",
        "bin": "bin",
        "out": "interbyte",
        "addchar": "",
        "responsetimeout": "10000"
    },
    {
        "id": "c6b56e0744603b80",
        "type": "modbus-client",
        "name": "ashp0-modbus",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": true,
        "failureLogEnabled": true,
        "tcpHost": "192.168.1.240",
        "tcpPort": "502",
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": "9600",
        "serialDatabits": "8",
        "serialStopbits": "1",
        "serialParity": "none",
        "serialConnectionDelay": "100",
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 1,
        "commandDelay": 1,
        "clientTimeout": 10000,
        "reconnectOnTimeout": false,
        "reconnectTimeout": 10000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "ab1ab0d04bdd3b34",
        "type": "influxdb",
        "hostname": "127.0.0.1",
        "port": "8086",
        "protocol": "http",
        "database": "database",
        "name": "caxton30d",
        "usetls": false,
        "tls": "",
        "influxdbVersion": "2.0",
        "url": "https://eu-central-1-1.aws.cloud2.influxdata.com",
        "rejectUnauthorized": true
    },
    {
        "id": "e41c774eeb2b3037",
        "type": "ui-base",
        "name": "Caxton",
        "path": "/dashboard",
        "appIcon": "",
        "includeClientData": true,
        "acceptsClientConfig": [
            "ui-notification",
            "ui-control"
        ],
        "showPathInSidebar": false,
        "navigationStyle": "default",
        "titleBarStyle": "default",
        "showReconnectNotification": true,
        "notificationDisplayTime": "1",
        "showDisconnectNotification": true
    },
    {
        "id": "c35227ba6f0c2fc2",
        "type": "ui-theme",
        "name": "Default Theme",
        "colors": {
            "surface": "#ffffff",
            "primary": "#0094CE",
            "bgPage": "#eeeeee",
            "groupBg": "#ffffff",
            "groupOutline": "#cccccc"
        },
        "sizes": {
            "density": "default",
            "pagePadding": "12px",
            "groupGap": "12px",
            "groupBorderRadius": "4px",
            "widgetGap": "12px"
        }
    },
    {
        "id": "b43082bff9046c6f",
        "type": "ui-page",
        "name": "Heating",
        "ui": "e41c774eeb2b3037",
        "path": "/heat",
        "icon": "home",
        "layout": "grid",
        "theme": "c35227ba6f0c2fc2",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 2,
        "className": "",
        "visible": true,
        "disabled": false
    },
    {
        "id": "20e890f349e38240",
        "type": "ui-page",
        "name": "Temperatures",
        "ui": "e41c774eeb2b3037",
        "path": "/building",
        "icon": "home",
        "layout": "grid",
        "theme": "c35227ba6f0c2fc2",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 1,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "7d2a07e2b30dad87",
        "type": "ui-group",
        "name": "Overall Control",
        "page": "b43082bff9046c6f",
        "width": "6",
        "height": "1",
        "order": 1,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "8a3ca6b2c6028d5b",
        "type": "modbus-client",
        "name": "LAE-AC1-27",
        "clienttype": "serial",
        "bufferCommands": true,
        "stateLogEnabled": true,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "127.0.0.1",
        "tcpPort": "502",
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB0",
        "serialType": "ASCII",
        "serialBaudrate": "9600",
        "serialDatabits": "7",
        "serialStopbits": "1",
        "serialParity": "even",
        "serialConnectionDelay": "100",
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": "1",
        "commandDelay": "1",
        "clientTimeout": "1000",
        "reconnectOnTimeout": true,
        "reconnectTimeout": "2000",
        "parallelUnitIdsAllowed": true,
        "showErrors": true,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "8fddc7545b8b993d",
        "type": "ui-group",
        "name": "Weather Compensation",
        "page": "f91110c2149b7835",
        "width": "6",
        "height": "1",
        "order": 3,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "5e46a3149640b893",
        "type": "ui-group",
        "name": "Flow temperature",
        "page": "b43082bff9046c6f",
        "width": "6",
        "height": "1",
        "order": 7,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "9c62a4b6cf15630d",
        "type": "ui-group",
        "name": "White Box",
        "page": "b43082bff9046c6f",
        "width": "6",
        "height": "1",
        "order": 4,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "eca65edcc34b5a40",
        "type": "ui-group",
        "name": "Load compensation",
        "page": "f91110c2149b7835",
        "width": "6",
        "height": "1",
        "order": 2,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "f91110c2149b7835",
        "type": "ui-page",
        "name": "Tuning",
        "ui": "e41c774eeb2b3037",
        "path": "/tuning",
        "icon": "home",
        "layout": "grid",
        "theme": "c35227ba6f0c2fc2",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 3,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "318d4c5818f432d1",
        "type": "ui-group",
        "name": "1st floor",
        "page": "20e890f349e38240",
        "width": "4",
        "height": "1",
        "order": 2,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "ddb86a924c9cd18d",
        "type": "ui-group",
        "name": "Ground floor",
        "page": "20e890f349e38240",
        "width": "4",
        "height": "1",
        "order": 1,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "6bb44fe3ca0ba894",
        "type": "ui-group",
        "name": "Top floor",
        "page": "20e890f349e38240",
        "width": "4",
        "height": "1",
        "order": 3,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "a89236c6fd618d45",
        "type": "ui-group",
        "name": "Building temperatures",
        "page": "b43082bff9046c6f",
        "width": "6",
        "height": "1",
        "order": 5,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "c8e0ab309895af11",
        "type": "ui-group",
        "name": "tables",
        "page": "4f847d9df6bfbe0e",
        "width": "12",
        "height": "1",
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "4f847d9df6bfbe0e",
        "type": "ui-page",
        "name": "Logs",
        "ui": "e41c774eeb2b3037",
        "path": "/logs",
        "icon": "home",
        "layout": "grid",
        "theme": "c35227ba6f0c2fc2",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 5,
        "className": "",
        "visible": true,
        "disabled": false
    },
    {
        "id": "3b9fea2ad4f5df3c",
        "type": "ui-group",
        "name": "Weekend schedule",
        "page": "b43082bff9046c6f",
        "width": "3",
        "height": "1",
        "order": 3,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "d3987b783abbd512",
        "type": "ui-group",
        "name": "ASHP",
        "page": "b43082bff9046c6f",
        "width": "6",
        "height": "1",
        "order": 6,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "e506712cd9dc5c30",
        "type": "ui-group",
        "name": "Log",
        "page": "b43082bff9046c6f",
        "width": "6",
        "height": "1",
        "order": 8,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "a08f5caa6b7f253a",
        "type": "ui-group",
        "name": "Weekday schedule",
        "page": "b43082bff9046c6f",
        "width": "3",
        "height": "1",
        "order": 2,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "f269bfbfdc438ab8",
        "type": "ui-page",
        "name": "work area",
        "ui": "e41c774eeb2b3037",
        "path": "/work-area",
        "icon": "home",
        "layout": "grid",
        "theme": "c35227ba6f0c2fc2",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 6,
        "className": "",
        "visible": true,
        "disabled": false
    },
    {
        "id": "9ee3507d7e391438",
        "type": "ui-group",
        "name": "work area",
        "page": "f269bfbfdc438ab8",
        "width": "12",
        "height": "8",
        "order": 2,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "848f31b37be373fb",
        "type": "ui-page",
        "name": "Sensors",
        "ui": "e41c774eeb2b3037",
        "path": "/sensors",
        "icon": "",
        "layout": "grid",
        "theme": "c35227ba6f0c2fc2",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 4,
        "className": "",
        "visible": true,
        "disabled": false
    },
    {
        "id": "6b329d717937e322",
        "type": "ui-group",
        "name": "sensors",
        "page": "848f31b37be373fb",
        "width": "12",
        "height": "1",
        "order": 1,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "cab14c5374c0b4bf",
        "type": "ui-group",
        "name": "PID",
        "page": "f91110c2149b7835",
        "width": "6",
        "height": "1",
        "order": 4,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "5e3b78a06771b8f3",
        "type": "ui-group",
        "name": "Calcs",
        "page": "f91110c2149b7835",
        "width": "12",
        "height": "1",
        "order": 1,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "0ab4678ba1f9dae0",
        "type": "ui-group",
        "name": "template test",
        "page": "f269bfbfdc438ab8",
        "width": "8",
        "height": "4",
        "order": 1,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "3bf5edcf0ab1a992",
        "type": "function",
        "z": "0ada38113f2dc695",
        "name": "30 sec RC + 20",
        "func": "// @ts-nocheck\n// Applies a simple RC low pass filter to incoming payload values\nvar tc = 30*1000;       // time constant in milliseconds\n\nvar lastValue = context.get('lastValue');\nif (typeof lastValue == \"undefined\") lastValue = msg.payload;\nvar lastTime = context.get('lastTime') || null;\nvar now = new Date();\nvar currentValue = msg.payload;\nif (lastTime === null) {\n    // first time through\n    newValue = currentValue;\n} \nelse {\n    var dt = now - lastTime;\n    var newValue;\n    \n    if (dt > 0) {\n        var dtotc = dt / tc;\n        newValue = lastValue * (1 - dtotc) + currentValue * dtotc;\n    } else {\n        // no time has elapsed leave output the same as last time\n        newValue = lastValue;\n    }\n}\ncontext.set('lastValue', newValue);\ncontext.set('lastTime', now);\n\nmsg.payload = newValue + 2;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 626.5,
        "y": 207,
        "wires": [
            [
                "f7ed1a411069eb16"
            ]
        ]
    },
    {
        "id": "e94100a68efcf2f1",
        "type": "inject",
        "z": "0ada38113f2dc695",
        "name": "Inject -0.2 at start",
        "props": [
            {
                "p": "payload",
                "v": "-0.2",
                "vt": "num"
            },
            {
                "p": "topic",
                "v": "",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "topic": "",
        "payload": "-0.2",
        "payloadType": "num",
        "x": 134.5,
        "y": 30,
        "wires": [
            [
                "5198a3b093941629"
            ]
        ]
    },
    {
        "id": "93d213fc305f7484",
        "type": "function",
        "z": "0ada38113f2dc695",
        "name": "10 sec RC",
        "func": "// Applies a simple RC low pass filter to incoming payload values\nvar tc = 10*1000;       // time constant in milliseconds\n\nvar lastValue = context.get('lastValue');\nif (typeof lastValue == \"undefined\") lastValue = msg.payload;\nvar lastTime = context.get('lastTime') || null;\nvar now = new Date();\nvar currentValue = msg.payload;\nif (lastTime === null) {\n    // first time through\n    newValue = currentValue;\n} else {\n    var dt = now - lastTime;\n    var newValue;\n    \n    if (dt > 0) {\n        var dtotc = dt / tc;\n        newValue = lastValue * (1 - dtotc) + currentValue * dtotc;\n    } else {\n        // no time has elapsed leave output the same as last time\n        newValue = lastValue;\n    }\n}\ncontext.set('lastValue', newValue);\ncontext.set('lastTime', now);\n\nmsg.payload = newValue;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 451,
        "y": 207,
        "wires": [
            [
                "3bf5edcf0ab1a992"
            ]
        ]
    },
    {
        "id": "5198a3b093941629",
        "type": "delay",
        "z": "0ada38113f2dc695",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "outputs": 1,
        "x": 268,
        "y": 104,
        "wires": [
            [
                "516bbc56d2b3415c"
            ]
        ]
    },
    {
        "id": "7cd9046544592499",
        "type": "function",
        "z": "0ada38113f2dc695",
        "name": "2 msg transport delay",
        "func": "// stores messages in a fifo until the specified number have been received, \n// then releases them as new messages are received.\n// during the filling phase the earliest message is passed on each time \n// a message is received, but it is also left in the fifo\nvar fifoMaxLength = 2;\nvar fifo = context.get('fifo') || [];\n// push the new message onto the top of the array, messages are shifted down and\n// drop off the front\nvar length = fifo.push(msg);  // returns new length\nif (length > fifoMaxLength) {\n    newMsg = fifo.shift();\n} else {\n    // not full yet, make a copy of the msg and pass it on\n    var newMsg = JSON.parse(JSON.stringify(fifo[0]));\n}\ncontext.set('fifo', fifo);\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 258,
        "y": 208,
        "wires": [
            [
                "93d213fc305f7484"
            ]
        ]
    },
    {
        "id": "f7ed1a411069eb16",
        "type": "function",
        "z": "0ada38113f2dc695",
        "name": "Clear all except payload",
        "func": "var msg2 = {payload: msg.payload};\nreturn msg2;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 545,
        "y": 293,
        "wires": [
            []
        ]
    },
    {
        "id": "516bbc56d2b3415c",
        "type": "range",
        "z": "0ada38113f2dc695",
        "minin": "0",
        "maxin": "10",
        "minout": "0",
        "maxout": "10",
        "action": "scale",
        "round": false,
        "property": "payload",
        "name": "10-10",
        "x": 77,
        "y": 208,
        "wires": [
            [
                "7cd9046544592499"
            ]
        ]
    },
    {
        "id": "2e6f37f3def04c18",
        "type": "function",
        "z": "9e36a25803eb28ab",
        "name": "downsampleV1",
        "func": "/** rework so it operates on all fields in the payload */\n\nfunction toFix(num, precision)\n{\n    return (Math.trunc(num * (10 ** precision)))/ (10 ** precision) ;\n}\n\nconst isSet = (o, prop) => Object.hasOwn(o,prop) ? o[prop] : false\n\nconst store0 = {\n    payload: 0.0,\n    lastPayload : 0.0, \n    avg : 0.0,\n    lastAvg : 0.0,\n    numSamples: 0,\n    beginTransition: true\n}\n\nlet nodeStatus = null ;\n\nfunction deliver(msg)\n{\n    let store = context.get(msg.topic) ?? store0 ;\n\n    // led indicates messageClass  red : digest, yellow : update, green : writeThrough  \n    let colour = msg.writeThrough ? 'green' : 'yellow' ;\n    let statusText = `${msg.topic} ${store.payload}`;\n    if (msg.writeThrough || (msg.payload != store.payload))\n    {\n        statusText = `${statusText}=>${msg.payload}`;  \n        store.payload = msg.payload ;\n        context.set(msg.topic, msg); \n        nodeStatus = { fill: colour, shape: \"dot\", text: statusText}; \n    }\n    else\n        msg = null ;\n\n    return msg ;  \n}\n// ver 1.0 checked 22-09-2024\n\nfunction digest(msg) {\n\n    if (msg.reportOnDiff === undefined)\n        msg.reportOnDiff = 1 ; \n    if (msg.windowSize === undefined)\n        msg.windowSize = 10 ;   // arbitrary number\n\n    let store = context.get(msg.topic);\n    if (store === undefined)\n        store = store0;\n\n    const beginTransition = store.beginTransition;\n    store.beginTransition = false;\n\n    const valueDiff = store.numSamples ? Math.abs(msg.payload - store.lastAvg) : 0.0;\n    const percentageDiff = store.numSamples ? (msg.payload - store.lastAvg) * 100 * 2 / (msg.payload + store.lastAvg) : 0.0;\n\n    const endTransition = msg.writeThrough\n                || (valueDiff >= msg.reportOnDiff) \n                || (store.numSamples + 1 >= msg.windowSize);  // write every maxGap  \n    const outputAvg = beginTransition || endTransition;\n\n    store.payload = msg.lastPayload = msg.payload;\n    store.avg = (store.avg * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct? \n    store.avg = toFix(store.avg, 2);\n    store.numSamples += 1;\n    msg.numSamples = store.numSamples;\n\n    const statusText = `${msg.topic} ${msg.payload} avg:${store.avg} num:${store.numSamples}`\n\n    if (isSet(msg,'track') || endTransition ) \n    {\n    }\n    /*\n    node.log(`${msg.topic} ${msg.lastPayload} avg: ${store.avg.toFixed(2)}, `\n        + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n        + `bt ${beginTransition} et ${ endTransition }`);\n    */\n    if (outputAvg) {\n        msg.payload = store.avg;\n        store.numSamples = 0;\n        if (endTransition)\n        {\n            store.lastAvg = store.avg;\n            store.beginTransition = true;\n        }\n    }\n    const colour = store.beginTransition ? 'red' : 'blue'  // broken\n    nodeStatus = { fill: colour, shape: \"dot\", text: statusText}; \n\n    context.set(msg.topic, store);\n    return outputAvg ? msg : null;\n}\n\nconst m = msg.digest ?  digest(msg) : deliver(msg);\n\nconst utils = global.get('utils')\nif (nodeStatus)\n{\n    nodeStatus.text = `${utils.getHHMMSSNow()} ${nodeStatus.text}`;  \n    node.status(nodeStatus)\n}\nconst msgStatus = nodeStatus ? { topic : 'status' , payload : nodeStatus } : null ;\n\nconst logRecord = null ;\n\nreturn [[m], [m && isSet(m,'track') ? m : null], [logRecord], [msgStatus] ]",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 40,
        "wires": [
            [],
            [],
            [],
            []
        ],
        "info": "key process to reduce data"
    },
    {
        "id": "e10a74b38790039e",
        "type": "comment",
        "z": "9e36a25803eb28ab",
        "name": "Get rid of repeating data",
        "info": "",
        "x": 130,
        "y": 80,
        "wires": []
    },
    {
        "id": "c6b375de7335d93d",
        "type": "function",
        "z": "9e36a25803eb28ab",
        "name": "downsampleV2",
        "func": "/**\n * downsample v2 18 Oct 2025 \n */\n\n/** rework so it operates on all fields in the payload */\n\n\nfunction toFix(num, precision)\n{\n    return (Math.trunc(num * (10 ** precision)))/ (10 ** precision) ;\n}\n\nconst isSet = (o, prop) => o[prop] ?? false ;\n\nconst store0 = {\n    payload: 0.0,\n    lastPayload : 0.0, \n    mean : 0.0,\n    lastMean : 0.0,\n    numSamples: 0,\n    beginTransition: true\n}\n\nlet nodeStatus = null ;\n\nfunction deliver(msg)\n{\n    let store = context.get(msg.topic) ?? store0 ;\n\n    // led indicates messageClass  red : digest, yellow : update, green : writeThrough  \n    let colour = msg.writeThrough ? 'green' : 'yellow' ;\n    let statusText = `${msg.topic} ${store.payload}`;\n    if (msg.writeThrough || (msg.payload != store.payload))\n    {\n        statusText = `${statusText}=>${msg.payload}`;  \n        store.payload = msg.payload ;\n        context.set(msg.topic, msg); \n        nodeStatus = { fill: colour, shape: \"dot\", text: statusText}; \n    }\n    else\n        msg = null ;\n\n    return msg ;  \n}\n// ver 1.0 checked 22-09-2024\n\nfunction digest(msg) {\n\n    if (msg.reportOnDiff === undefined)\n        msg.reportOnDiff = 1 ; \n    if (msg.windowSize === undefined)\n        msg.windowSize = 10 ;   // arbitrary number\n\n    let store = context.get(msg.topic);\n    if (store === undefined || msg.reset || isNaN(store.mean) ||  isNaN(store.numSamples))\n        store = store0;    \n\n    const dateNow = Date.now()\n\n    let timeDiff = 0; let timeDiffLog = ''; let timeout = false ;\n\n    // optionally process timestamps if windowPeriod specified\n    if (msg.windowPeriod)\n    {\n        if (store.timestamp === undefined)\n            store.timestamp = dateNow \n        if (msg.timestamp === undefined)\n            msg.timestamp = dateNow;\n        timeDiff = msg.timestamp - store.timestamp ;\n        timeDiffLog = `Δt:${timeDiff}`\n        timeout = timeDiff > msg.windowPeriod ;\n    }\n\n    const beginTransition = store.beginTransition ;\n    store.beginTransition = false;\n\n    const valueDiff = store.numSamples ? Math.abs(msg.payload - store.lastMean) : 0.0;\n    const percentageDiff = store.numSamples ? (msg.payload - store.lastMean) * 100 * 2 / (msg.payload + store.lastMean) : 0.0;\n\n    const endTransition = msg.writeThrough\n                || (valueDiff >= msg.reportOnDiff) \n                || (store.numSamples + 1 >= msg.windowSize)  // write every maxGap  \n                || timeout ;\n \n    const outputMean = ((msg.payload != store.payload) && beginTransition) || endTransition;\n    store.payload = msg.lastPayload = msg.payload;\n    store.mean = (store.mean * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct? \n    const storeMeanView = toFix(store.mean, 2);\n    store.numSamples += 1;\n    msg.numSamples = store.numSamples;\n\n    const statusText = `${msg.topic} ${msg.payload} mean:${storeMeanView} num:${store.numSamples} ${timeDiffLog}`\n    if (isSet(msg,'track') || endTransition ) \n    {\n    }\n    /*\n    node.log(`${msg.topic} ${msg.lastPayload} mean: ${store.mean.toFixed(2)}, `\n        + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n        + `bt ${beginTransition} et ${ endTransition }`);\n    */\n    if (outputMean) {\n        msg.payload = storeMeanView ;\n        store.numSamples = 0;\n        if (endTransition)\n        {\n            store.lastMean = store.mean ; \n            store.beginTransition = true;\n            store.timestamp = dateNow ;\n        }\n    }\n    const colour = store.beginTransition ? 'red' : 'blue'  // broken\n    nodeStatus = { fill: colour, shape: \"dot\", text: statusText}; \n\n    context.set(msg.topic, store);\n    return outputMean ? msg : null;\n}\n\nconst m = msg.digest ?  digest(msg) : deliver(msg);\n\nconst utils = global.get('utils')\nif (nodeStatus)\n{\n    nodeStatus.text = `${utils.getHHMMSSNow()} ${nodeStatus.text}`;  \n    node.status(nodeStatus)\n}\nconst msgStatus = nodeStatus ? { topic : 'status' , payload : nodeStatus } : null ;\n\nconst logRecord = null ;\n\nreturn [[m], [m && isSet(m,'track') ? m : null], [logRecord], [msgStatus] ]",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 120,
        "wires": [
            [],
            [],
            [],
            []
        ],
        "info": "key process to reduce data"
    },
    {
        "id": "ec4343cadc8631bd",
        "type": "function",
        "z": "9e36a25803eb28ab",
        "name": "downsampleV2.1",
        "func": "/**\n * downsample v2.1 18 Oct 2025\n */\n\n/** rework so it operates on all fields in the payload */\n\n\nfunction toFix(num, precision)\n{\n  return (Math.round(num * (10 ** precision)))/ (10 ** precision) ;\n}\n\nconst isSet = (o, prop) => o[prop] ?? false ;\n\nconst store0 = {\n  payload : 0.0,   // last payload\n  mean : 0.0,\n  reportedMean : 0.0,\n  numSamples: 0,\n  begin: true\n}\n\nlet nodeStatus = null ;\n\nfunction deliver(msg)\n{\n  let store = context.get(msg.topic) ?? store0 ;\n  \n  // led indicates messageClass  red : digest, yellow : update, green : writeThrough\n  let colour = msg.writeThrough ? 'green' : 'yellow' ;\n  let statusText = `${msg.topic} ${store.payload}`;\n  if (msg.writeThrough || (msg.payload != store.payload))\n  {\n    statusText = `${statusText}=>${msg.payload}`;\n    store.payload = msg.payload ;\n    context.set(msg.topic, msg);\n    nodeStatus = { fill: colour, shape: \"dot\", text: statusText};\n  }\n  else\n    msg = null ;\n  \n  return msg ;\n}\n// ver 1.0 checked 22-09-2024\n\nfunction digest(msg) {\n  \n  // conditions to reset the store\n\n  let store = context.get(msg.topic);\n  if (store === undefined || msg.reset || isNaN(store.mean) ||  isNaN(store.numSamples))\n    store = store0;\n  \n  const dateNow = Date.now()\n\n  // check to see how much payload has changed\n\n  const percentageDiff = store.numSamples ? (msg.payload - store.reportedMean) * 100 * 2 / (msg.payload + store.lastMean) : 0.0;\n \n  const valueDiff1 = store.numSamples ? Math.abs(msg.payload - store.reportedMean) : 0.0;\n  const valueDiff2 = Math.abs(msg.payload - store.payload)\n  const valueTrigger = Math.max(valueDiff1, valueDiff2) >  (msg.reportOnDiff ?? 0) ;\n\n\n  // check if windowPeriod has been reached\n\n  let timeDiff = 0; let timeDiffLog = ''; let timeTrigger = false ;\n  if (msg.windowPeriodSecs)\n  {\n    if (store.timestamp === undefined)\n      store.timestamp = dateNow\n      if (msg.timestamp === undefined)\n        msg.timestamp = dateNow;\n    timeDiff = msg.timestamp - store.timestamp ;\n    timeDiffLog = `Δt:${ Math.round(timeDiff / 1000) }`\n    timeTrigger = timeDiff > (msg.windowPeriodSecs * 1000);\n  }\n\n  // check if window size has been reached \n\n  const windowSizeTrigger = store.numSamples + 1 >= (msg.windowSize ?? 10000)\n\n \n  const endTransition = valueTrigger || timeTrigger || windowSizeTrigger ; // write every maxGap\n  const triggers = (valueTrigger ? \"vt \" : \"\")  +  (timeTrigger ? \"tt \" : \"\") + (windowSizeTrigger ? \"ws \" : \"\");\n  msg.triggers = triggers ;\n\n  // to do put triggers into object \n  //node.error(`my error message ${msg.topic} ${triggers} ${msg.payload} ${valueDiff1} ${valueDiff2}`, msg);\n\n\n  store.payload = msg.payload;\n  store.mean = (store.mean * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct?\n  const storeMeanView = toFix(store.mean, msg.precision == undefined ?  2 : msg.precision );\n  store.numSamples += 1;\n  msg.numSamples = store.numSamples;\n  \n  const statusText = `${msg.topic} ${msg.payload} mean:${storeMeanView} num:${store.numSamples} ${timeDiffLog}`\n  /*\n   *    node.log(`${msg.topic} ${msg.lastPayload} mean: ${store.mean.toFixed(2)}, `\n   *             + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n   *             + `bt ${beginTransition} et ${ endTransition }`);\n   */\n  if (store.begin || endTransition) {\n    msg.payload = storeMeanView ;\n    store.reportedMean = store.mean ;  // don't need to reset store.mean because numSamples is zero\n    store.numSamples = 0 ;\n    store.timestamp = dateNow ;\n    store.begin = false ;\n  }\n  const colour = endTransition ? 'red' : 'blue'  \n  nodeStatus = { fill: colour, shape: \"dot\", text: statusText};\n  \n  context.set(msg.topic, store);\n  return endTransition ? msg : null;\n}\n\nconst m = msg.digest ?  digest(msg) : deliver(msg);\n\nconst utils = global.get('utils')\nif (nodeStatus)\n{\n  nodeStatus.text = `${utils.getHHMMSSNow()} ${nodeStatus.text}`;\n  node.status(nodeStatus)\n}\nconst msgStatus = nodeStatus ? { topic : 'status' , payload : nodeStatus } : null ;\n\nconst logRecord = null ;\n\nreturn [[m], [m && isSet(m,'track') ? m : null], [logRecord], [msgStatus] ]\n",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 200,
        "wires": [
            [],
            [],
            [],
            []
        ],
        "info": "key process to reduce data"
    },
    {
        "id": "c566712146768d0f",
        "type": "function",
        "z": "9e36a25803eb28ab",
        "name": "downsample v2.2",
        "func": "/**\n * downsample v2.2 30 Oct 2025\n */\n\n/** rework so it operates on all fields in the payload */\n\n\nfunction toFix(num, precision)\n{\n  return (Math.round(num * (10 ** precision)))/ (10 ** precision) ;\n}\n\nconst isSet = (o, prop) => o[prop] ?? false ;\n\nconst store0 = {\n  payload : 0.0,   // last payload\n  mean : 0.0,\n  reportedMean : 0.0,\n  numSamples: 0,\n  begin: true\n}\n\nlet nodeStatus = null ;\n\n/**\n * Compare properties on obj2 with obj1. \n * Create a new object with all the new properties that \n * have appeared in obj2 or that have changed from obj1.\n * It's not symmetric, properties that have disappeared \n * in obj2 are just ignored. \n */\n\nconst createDiff = (obj1, obj2) => Object.fromEntries(\n  Object.keys(obj2)\n    .filter(key => obj1.hasOwnProperty(key) == false || obj1[key] != obj2[key])\n    .map(key => [key, obj2[key]])\n);\n\n\nfunction deliver(msg)\n{\n  let store = context.get(msg.topic) ?? store0 ;\n  \n  // led indicates messageClass  red : digest, yellow : update, green : writeThrough\n  let colour = msg.writeThrough ? 'green' : 'yellow' ;\n  let statusText = `${msg.topic} ${store.payload}`;\n  if (typeof msg.payload !== 'object')\n  {\n    if (msg.writeThrough || (msg.payload != store.payload))\n    {\n      statusText = `${statusText}=>${msg.payload}`;\n      store.payload = msg.payload ;\n      context.set(msg.topic, store);\n      nodeStatus = { fill: colour, shape: \"dot\", text: statusText};\n    }\n    else \n      msg = null;\n  }\n  else {\n    msg.payload = createDiff(store.payload, msg.payload);\n    const numChanges = Object.keys(msg.payload).length ;\n    if (msg.writeThrough || numChanges) {\n      statusText = `Updated ${numChanges} properties`;\n      store.payload = Object.assign(store.payload, msg.payload);\n      context.set(msg.topic, store);\n      nodeStatus = { fill: 'red', shape: \"ring\", text: statusText };\n    }\n    else\n      msg = null;    \n  }\n  return msg ;\n}\n// ver 1.0 checked 22-09-2024\n\nfunction digest(msg) {\n  \n  // conditions to reset the store\n\n  let store = context.get(msg.topic);\n  if (store === undefined || msg.reset || isNaN(store.mean) ||  isNaN(store.numSamples))\n    store = store0;\n  \n  const dateNow = Date.now()\n\n  // check to see how much payload has changed\n\n  const percentageDiff = store.numSamples ? (msg.payload - store.reportedMean) * 100 * 2 / (msg.payload + store.lastMean) : 0.0;\n \n  const valueDiff1 = store.numSamples ? Math.abs(msg.payload - store.reportedMean) : 0.0;\n  const valueDiff2 = Math.abs(msg.payload - store.payload)\n  const valueTrigger = Math.max(valueDiff1, valueDiff2) >  (msg.reportOnDiff ?? 0) ;\n\n\n  // check if windowPeriod has been reached\n\n  let timeDiff = 0; let timeDiffLog = ''; let timeTrigger = false ;\n  if (msg.windowPeriodSecs)\n  {\n    if (store.timestamp === undefined)\n      store.timestamp = dateNow\n      if (msg.timestamp === undefined)\n        msg.timestamp = dateNow;\n    timeDiff = msg.timestamp - store.timestamp ;\n    timeDiffLog = `Δt:${ Math.round(timeDiff / 1000) }`\n    timeTrigger = timeDiff > (msg.windowPeriodSecs * 1000);\n  }\n\n  // check if window size has been reached \n\n  const windowSizeTrigger = store.numSamples + 1 >= (msg.windowSize ?? 10000)\n\n \n  const endTransition = valueTrigger || timeTrigger || windowSizeTrigger ; // write every maxGap\n  const triggers = (valueTrigger ? \"vt \" : \"\")  +  (timeTrigger ? \"tt \" : \"\") + (windowSizeTrigger ? \"ws \" : \"\");\n  msg.triggers = triggers ;\n\n  // to do put triggers into object \n  //node.error(`my error message ${msg.topic} ${triggers} ${msg.payload} ${valueDiff1} ${valueDiff2}`, msg);\n\n\n  store.payload = msg.payload;\n  store.mean = (store.mean * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct?\n  const storeMeanView = toFix(store.mean, msg.precision == undefined ?  2 : msg.precision );\n  store.numSamples += 1;\n  msg.numSamples = store.numSamples;\n  \n  const statusText = `${msg.topic} ${msg.payload} mean:${storeMeanView} num:${store.numSamples} ${timeDiffLog}`\n  /*\n   *    node.log(`${msg.topic} ${msg.lastPayload} mean: ${store.mean.toFixed(2)}, `\n   *             + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n   *             + `bt ${beginTransition} et ${ endTransition }`);\n   */\n  if (store.begin || endTransition) {\n    msg.payload = storeMeanView ;\n    store.reportedMean = store.mean ;  // don't need to reset store.mean because numSamples is zero\n    store.numSamples = 0 ;\n    store.timestamp = dateNow ;\n    store.begin = false ;\n  }\n  const colour = endTransition ? 'red' : 'blue'  \n  nodeStatus = { fill: colour, shape: \"dot\", text: statusText};\n  \n  context.set(msg.topic, store);\n  return endTransition ? msg : null;\n}\n\nif (msg.digest)\n  node.error('warning: digest specified ' + msg.topic)\n\nconst doDeliver = msg.writeThrough || (msg.reportOnDiff === undefined) \n\nconst m = doDeliver ? deliver(msg) : digest(msg) ;\n\nconst utils = global.get('utils')\nif (nodeStatus)\n{\n  nodeStatus.text = `${utils.getHHMMSSNow()} ${nodeStatus.text}`;\n  node.status(nodeStatus)\n}\nconst msgStatus = nodeStatus ? { topic : 'status' , payload : nodeStatus } : null ;\n\nconst logRecord = null ;\n\nreturn [[m], [m && isSet(m,'track') ? m : null], [logRecord], [msgStatus] ]\n",
        "outputs": 4,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 280,
        "wires": [
            [],
            [],
            [],
            []
        ]
    },
    {
        "id": "01189677a0099e03",
        "type": "mqtt out",
        "z": "fce55c80ba409b3d",
        "name": "hive",
        "topic": "",
        "qos": "0",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "2ce60664f6ba7120",
        "x": 630,
        "y": 40,
        "wires": []
    },
    {
        "id": "b71d646d0524d860",
        "type": "function",
        "z": "fce55c80ba409b3d",
        "name": "globalise",
        "func": "\nlet config = global.get(\"site-config\", 'file');\nmsg.topic = config.site + '/' + msg.topic ;\n\n//let ot =  msg.hasOwnProperty('originalTopic') ? msg.originalTopic : '' ; \nlet ot = msg.originalTopic ?? '' ;\nif (ot == msg.topic)\n{\n    //node.log(msg.topic + ' Suppressing echoing')\n    return null ; \n} \nreturn msg ;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 40,
        "wires": [
            [
                "91e4421d067a2d1b",
                "01189677a0099e03"
            ]
        ]
    },
    {
        "id": "06aca66c9580d0d3",
        "type": "function",
        "z": "fce55c80ba409b3d",
        "name": "localise",
        "func": "\nmsg.topic =  'local' + '/' + msg.topic ;\n/*\nlet uc =  msg.hasOwnProperty('useCount') ?  msg.useCount : 0 ;\nif (uc > 2) \n    return null ;\n*/\n\n//let ot =  msg.hasOwnProperty('originalTopic') ? msg.originalTopic : '' ; \nlet ot = msg.originalTopic ?? '' ;\nif (ot == msg.topic)\n{\n    //node.log(msg.topic + ' Suppressing echo')\n    return null ; \n} \nreturn msg ;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 100,
        "wires": [
            [
                "91e4421d067a2d1b",
                "56dc2cb7060287ab"
            ]
        ]
    },
    {
        "id": "56dc2cb7060287ab",
        "type": "mqtt out",
        "z": "fce55c80ba409b3d",
        "name": "mosquitto",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "9d1ae28e263fad2a",
        "x": 620,
        "y": 100,
        "wires": []
    },
    {
        "id": "6ac4b5a2620be04c",
        "type": "debug",
        "z": "fce55c80ba409b3d",
        "name": "MQTT out",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 160,
        "wires": []
    },
    {
        "id": "f5ee308ca04a95f3",
        "type": "mqtt in",
        "z": "fce55c80ba409b3d",
        "name": "hive req",
        "topic": "+/+/request/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "2ce60664f6ba7120",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 180,
        "wires": [
            [
                "b9e3aea420ead0a3"
            ]
        ]
    },
    {
        "id": "334d436609f20f3a",
        "type": "mqtt in",
        "z": "fce55c80ba409b3d",
        "name": "mosquitto",
        "topic": "#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "9d1ae28e263fad2a",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 180,
        "y": 300,
        "wires": [
            [
                "b9e3aea420ead0a3"
            ]
        ]
    },
    {
        "id": "169352bc32f5bbd4",
        "type": "switch",
        "z": "fce55c80ba409b3d",
        "name": "router",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "bridge\\/request",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "bridge\\/devices",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "bridge",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "^[adprsgmt][^\\d]*[\\d]{1,2}\\/availability$",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "pid0\\/(get|set|request)\\/",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "ashp0\\/(get|set)\\/",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "lae0\\/(get|set)\\/",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "clock0\\/(get|set)\\/",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "sensor0\\/(get|set)\\/",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "app\\/",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "^[adprsgmt][^\\d]*[\\d]{1,2}$",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "^heatX\\/[\\w]{2,}$",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "^[^\\/]*\\/(lae0|ashp0|pid0|sensor0)\\/*$",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 14,
        "x": 390,
        "y": 240,
        "wires": [
            [
                "6d021d84aed87757"
            ],
            [
                "19c30800fa95c445"
            ],
            [
                "6d021d84aed87757"
            ],
            [
                "2518a4fd104ebb54"
            ],
            [
                "d85bfa6a0e81301d"
            ],
            [
                "c0fb1b96b917cbc1"
            ],
            [
                "f1ec3b162b1184a0"
            ],
            [
                "605b2b84a661dbbc"
            ],
            [
                "a1eb201860b28d15"
            ],
            [
                "7b7a4dd23fba8082"
            ],
            [
                "e5c04e4bbe660ab9",
                "5df26a94adab42ee"
            ],
            [
                "c6fd0ae9641d7484"
            ],
            [
                "aca5d197ea67d78a"
            ],
            [
                "aca5d197ea67d78a"
            ]
        ],
        "info": "the regex here \n\nhttps://regex101.com/r/wlRMWz/1"
    },
    {
        "id": "3fff4148fd6087dd",
        "type": "function",
        "z": "fce55c80ba409b3d",
        "name": "check-in",
        "func": "msg.originalTopic = msg.topic ;\n\n// todo: tokenise here!\nlet pos = msg.topic.indexOf('/') ;\n\n// save 'cax'/'local' prefix\nmsg.prefix = msg.topic.substring(0,pos);\n\n// remove prefix from the topic\nmsg.topic = msg.topic.substring(pos+1);\n\n// make sure the message is for us\nlet config = global.get(\"site-config\", 'file')\n\nif (!([config.site, 'local', 'bridge'].includes(msg.prefix)))\n{\n  node.error(msg.originalTopic + ' unrecognised prefix, expected to local or ' + config.site + ', retain ' + msg.retain + \" \" + msg.payload);\n  return null ;   // it is not\n}\nnode.status({ fill: \"green\", shape: \"dot\", text: `${msg.originalTopic}`});\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 240,
        "y": 380,
        "wires": [
            [
                "169352bc32f5bbd4"
            ]
        ]
    },
    {
        "id": "9c0f3e23e9286b36",
        "type": "influxdb out",
        "z": "fce55c80ba409b3d",
        "influxdb": "ab1ab0d04bdd3b34",
        "name": "influx cloud",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "s",
        "retentionPolicyV18Flux": "",
        "org": "PUNL-30d",
        "bucket": "caxton30d",
        "x": 610,
        "y": 680,
        "wires": []
    },
    {
        "id": "75bac89abeeb5a27",
        "type": "influxdb out",
        "z": "fce55c80ba409b3d",
        "influxdb": "7d7a9bc368fd645d",
        "name": "influx local",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "database": "caxtonLive",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "organisation",
        "bucket": "bucket",
        "x": 610,
        "y": 720,
        "wires": []
    },
    {
        "id": "aca5d197ea67d78a",
        "type": "debug",
        "z": "fce55c80ba409b3d",
        "name": "discarded",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 400,
        "wires": []
    },
    {
        "id": "b059487bc1ff0a2b",
        "type": "link in",
        "z": "fce55c80ba409b3d",
        "name": "MQTT local",
        "links": [
            "0a9719bd77581975",
            "577231c552842134"
        ],
        "x": 185,
        "y": 100,
        "wires": [
            [
                "06aca66c9580d0d3"
            ]
        ]
    },
    {
        "id": "ae83978daa30c005",
        "type": "link in",
        "z": "fce55c80ba409b3d",
        "name": "MQTT cloud",
        "links": [
            "293ae4963a27a257",
            "8e6fb5fdc6f0bef1",
            "fed19cb666ad3b46"
        ],
        "x": 185,
        "y": 20,
        "wires": [
            [
                "b71d646d0524d860"
            ]
        ]
    },
    {
        "id": "d544888678a2bcd7",
        "type": "debug",
        "z": "fce55c80ba409b3d",
        "name": "influx",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 610,
        "y": 760,
        "wires": []
    },
    {
        "id": "e5c04e4bbe660ab9",
        "type": "function",
        "z": "fce55c80ba409b3d",
        "name": "unpack",
        "func": "/**\n * handle incoming traffic from sensors\n * serialize all the properties into single msgs\n */\n\n\nconst source = msg.topic; // e.g. s3\n\n// look up sensor location, it's edited by user on zigbee2mqtt\n\nconst config = global.get(\"site-config\", 'file');\n\nconst location = config.sensorMap.hasOwnProperty(source) \n               ? config.sensorMap[source] : source;  // e.g. s3\n\nconst stream = [] \n\nconst params = {\n    temperature:   { writeThrough : true },\n    battery:       { windowPeriodSecs : 60 * 60 * 24, reportOnDiff: 5000  },\n    voltage:       { windowPeriodSecs : 60 * 60 * 24, reportOnDiff: 5000  },\n    humidity:      { windowPeriodSecs : 60 * 60 * 1 , reportOnDiff: 5  },\n    linkquality:   { windowPeriodSecs : 60 * 60 * 1 , reportOnDiff: 30 },\n\n    windSpeed:     { windowPeriodSecs : 60 * 60 * 1   },\n    windDirection: { windowPeriodSecs : 60 * 60 * 1   },\n}\n\nconst m = {}   // Object.assign({}, msg);\n\n// create a template message \n\n// m.originalTopic = msg.originalTopic   no needed.\nm.source = source \nm.location = location\nm.prefix = msg.prefix // prevents influx recording copies\n\n//m.writeThrough = true ; //   msg.writeThrough ?? true;\n//m.digest = msg.digest ?? false;\n\n//m.timestamp = msg.timestamp ?? Date.now()\n//if (msg.payload.last_seen)\n  //  m.last_seen = msg.payload.last_seen\n\nm.timestamp = msg.timestamp ?? msg.last_seen ?? Date.now() ;\n\n// now create the variations\n// push out new message for every property in \n// the paramList.\n\n//const utils = global.get('utils')\n\nfor (const property in msg.payload) {\n    // looks like rubbish \n    // n.payload = Object.assign({}, m.payload);\n    if (params.hasOwnProperty(property))\n    {\n        const m1 = RED.util.cloneMessage(m);\n        const n = Object.assign(m1, params[property]);\n        n.topic = source + '/' + property ;\n        n.param = property ;\n        n.payload = msg.payload[property]\n        // round everything apart from temperature\n        n.precision = property == 'temperature' ? 2 : 0 ;\n        stream.push(n)\n    }\n}\nreturn [stream]",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 460,
        "wires": [
            [
                "9c4759a5aa1a682f"
            ]
        ]
    },
    {
        "id": "3a0b7c61797ade28",
        "type": "link in",
        "z": "fce55c80ba409b3d",
        "name": "downsampler",
        "links": [
            "298f4d77b929e02a",
            "228b073ae77b7894"
        ],
        "x": 115,
        "y": 600,
        "wires": [
            [
                "9c4759a5aa1a682f"
            ]
        ]
    },
    {
        "id": "7e810e9aa6aab8ad",
        "type": "debug",
        "z": "fce55c80ba409b3d",
        "name": "sampler out",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 590,
        "y": 540,
        "wires": []
    },
    {
        "id": "2384d6ea06ea6969",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "downsampler out",
        "mode": "link",
        "links": [
            "05fd8e378b5f7d83",
            "6e4f4737d3d2738b",
            "00c4ccd08c5fc11a",
            "4557c30c95706d62"
        ],
        "x": 625,
        "y": 580,
        "wires": []
    },
    {
        "id": "8b799875a8ef011e",
        "type": "link in",
        "z": "fce55c80ba409b3d",
        "name": "MQTT both",
        "links": [
            "f07bdf58f4238213",
            "90da587f91c535d6",
            "7972b448b09af4d9"
        ],
        "x": 185,
        "y": 60,
        "wires": [
            [
                "b71d646d0524d860",
                "06aca66c9580d0d3"
            ]
        ]
    },
    {
        "id": "7b7a4dd23fba8082",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "app",
        "mode": "link",
        "links": [
            "3d273fe27e049b65"
        ],
        "x": 655,
        "y": 280,
        "wires": []
    },
    {
        "id": "a2eff66e24c128f6",
        "type": "link in",
        "z": "fce55c80ba409b3d",
        "name": "weather",
        "links": [
            "f28841e54458294f"
        ],
        "x": 115,
        "y": 460,
        "wires": [
            [
                "e5c04e4bbe660ab9"
            ]
        ]
    },
    {
        "id": "11cd67874a91f2ba",
        "type": "debug",
        "z": "fce55c80ba409b3d",
        "name": "sampler in",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 370,
        "y": 540,
        "wires": []
    },
    {
        "id": "9a936887b0d2ee97",
        "type": "debug",
        "z": "fce55c80ba409b3d",
        "name": "tracked",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 620,
        "wires": []
    },
    {
        "id": "c6fd0ae9641d7484",
        "type": "function",
        "z": "fce55c80ba409b3d",
        "name": "heat exchange in",
        "func": "// set source, location and topic \n\nlet pos = msg.topic.indexOf('/') ;\n\n// msg.topic remains unchanged\nmsg.source = msg.topic.substring(0,pos);\nmsg.location = msg.topic.substring(pos+1);\nmsg.param = 'temperature'\n\n// copying ashp configuration\n\n//msg.reportOnDiff = 1\n\n//msg.digest = (msg.writeThrough == false) && (m.reportOnDiff != 0)  \n//node.error('digest ' + m.digest)\n\nmsg.writeThrough = true  \n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 460,
        "wires": [
            [
                "9c4759a5aa1a682f"
            ]
        ]
    },
    {
        "id": "d85bfa6a0e81301d",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "pid0 get/set",
        "mode": "link",
        "links": [
            "52fa1182d5cd2dff"
        ],
        "x": 655,
        "y": 200,
        "wires": []
    },
    {
        "id": "61606c0c7a017d06",
        "type": "comment",
        "z": "fce55c80ba409b3d",
        "name": "Hive req only accepts +/+/request/#",
        "info": "",
        "x": 260,
        "y": 140,
        "wires": []
    },
    {
        "id": "274a027e2ae7e83f",
        "type": "mqtt in",
        "z": "fce55c80ba409b3d",
        "name": "hive set",
        "topic": "+/+/set/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "2ce60664f6ba7120",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 260,
        "wires": [
            [
                "b9e3aea420ead0a3"
            ]
        ]
    },
    {
        "id": "818e2038058a0e91",
        "type": "link in",
        "z": "fce55c80ba409b3d",
        "name": "downsampler trace",
        "links": [
            "5d488e53c97b07ab"
        ],
        "x": 115,
        "y": 560,
        "wires": [
            [
                "11cd67874a91f2ba",
                "9c4759a5aa1a682f"
            ]
        ]
    },
    {
        "id": "bc12a1e2f4ce8f25",
        "type": "mqtt in",
        "z": "fce55c80ba409b3d",
        "name": "hive get",
        "topic": "+/+/get/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "2ce60664f6ba7120",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 220,
        "wires": [
            [
                "b9e3aea420ead0a3"
            ]
        ]
    },
    {
        "id": "f6f4795a9b9f4f80",
        "type": "link in",
        "z": "fce55c80ba409b3d",
        "name": "router",
        "links": [
            "de9a8c2bce218be1"
        ],
        "x": 115,
        "y": 420,
        "wires": [
            [
                "169352bc32f5bbd4"
            ]
        ]
    },
    {
        "id": "f1ec3b162b1184a0",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "lae0 get/set",
        "mode": "link",
        "links": [
            "067d0e710c60a2bf"
        ],
        "x": 655,
        "y": 240,
        "wires": []
    },
    {
        "id": "9e88902599050a7b",
        "type": "comment",
        "z": "fce55c80ba409b3d",
        "name": "Important to minimise influx traffic and so storage costs",
        "info": "",
        "x": 580,
        "y": 1280,
        "wires": []
    },
    {
        "id": "c0fb1b96b917cbc1",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "ashp0 get/set",
        "mode": "link",
        "links": [
            "f61b76784c425ebd"
        ],
        "x": 705,
        "y": 220,
        "wires": []
    },
    {
        "id": "605b2b84a661dbbc",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "clock0 get/set",
        "mode": "link",
        "links": [
            "5160c12d4a8d8e95"
        ],
        "x": 705,
        "y": 260,
        "wires": []
    },
    {
        "id": "6ca29bec912ca0c8",
        "type": "comment",
        "z": "fce55c80ba409b3d",
        "name": "Note bridge traffic NOT being handled ",
        "info": "This is to reduce the load on MQTT",
        "x": 850,
        "y": 40,
        "wires": []
    },
    {
        "id": "9c4759a5aa1a682f",
        "type": "subflow:9e36a25803eb28ab",
        "z": "fce55c80ba409b3d",
        "name": "",
        "x": 370,
        "y": 620,
        "wires": [
            [
                "2384d6ea06ea6969",
                "7e810e9aa6aab8ad",
                "dc86d09650ce95f5"
            ],
            [
                "9a936887b0d2ee97"
            ],
            []
        ]
    },
    {
        "id": "a944110ef21c8c0c",
        "type": "inject",
        "z": "fce55c80ba409b3d",
        "name": "initialize",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "initialize",
        "payload": "",
        "payloadType": "date",
        "x": 180,
        "y": 900,
        "wires": [
            [
                "6d33c5ea5374761b"
            ]
        ]
    },
    {
        "id": "6d33c5ea5374761b",
        "type": "function",
        "z": "fce55c80ba409b3d",
        "name": "recall",
        "func": "/**\n * flush through all the settings \n * so that dashboard is intialized\n * and all MQTT topics are updated\n */\n\n\nconst objectNames = ['ashp0','lae0','pid0','clock0']\nconst msgs = objectNames.map((name) => ({ topic: `${name}/get/all`, payload: false}))\nreturn [msgs];",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 900,
        "wires": [
            [
                "169352bc32f5bbd4"
            ]
        ]
    },
    {
        "id": "2518a4fd104ebb54",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "bridge device availability",
        "mode": "link",
        "links": [
            "75b27d2f659b385d"
        ],
        "x": 745,
        "y": 160,
        "wires": []
    },
    {
        "id": "19c30800fa95c445",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "bridge device list",
        "mode": "link",
        "links": [
            "28f2afe4d33649c3"
        ],
        "x": 745,
        "y": 120,
        "wires": []
    },
    {
        "id": "a1eb201860b28d15",
        "type": "link out",
        "z": "fce55c80ba409b3d",
        "name": "sensor0 get/set",
        "mode": "link",
        "links": [
            "463ad07330f8ce74"
        ],
        "x": 705,
        "y": 300,
        "wires": []
    },
    {
        "id": "dc86d09650ce95f5",
        "type": "function",
        "z": "fce55c80ba409b3d",
        "name": "tag for influx v2",
        "func": "if (['local'].includes(msg.prefix) == false) {\n  node.error(msg.topic + \" only storing 'local' sensors \");\n  return null;   // it is not.  Use hops in future?\n}\n\n/*  \n  strip out the known tag fields and place in second array in payload. \n  this is the standard reporting format for influx.\n  The msg.topic is ignored\n*/\n\nlet fields = {};\nlet tags = {};\n\nconst pick = (obj, ...keys) => Object.fromEntries(\n  keys\n    .filter(key => key in obj)\n    .map(key => [key, obj[key]])\n);\n\n\nconst pickNumbers = (obj) => Object.fromEntries(\n  Object.keys(obj)\n    .filter(key => typeof obj[key] === 'number')\n    .map(key => [key, obj[key]])\n);\n\n\n/** \n * to make the text in grafana look nice\n * all temperatures have to be grouped together under a measurement category\n * you have one named field followed one tag which is the source.\n * Make the named field the location even though this wierd.\n */\nconst location = msg.location ? msg.location : msg.source ;\n\nlet nodeStatus = null ;\n\nswitch(typeof msg.payload)\n{\n  case 'number' :\n    fields[location] = msg.payload;     // e.g. conference room\n    tags['source'] = msg.source ;       // e.g M11 \n    nodeStatus = { fill: \"yellow\", shape: \"dot\", text: `m:${msg.param} f:${location}=${msg.payload} t:${msg.source}`};\n    break ;\n\n  case 'object' :\n    fields = pickNumbers(msg.payload) ;\n    tags = msg.source ? {'source': msg.source} : {} ;       // e.g pid0 \n    nodeStatus = { fill: \"blue\", shape: \"dot\", text: `m:${msg.param} (object) t:${msg.source? msg.source:\"\"}`};\n    break ;\n}\nif (Object.keys(fields).length == 0)\n  return null;  // there are no (numeric) field values\n\nconst m = \n{\n  measurement : msg.param,          // e.g. battery\n  topic : msg.topic,\n  payload : [fields,tags]\n}\n\n\n//if (msg.track)) \n{\n  const utils = global.get('utils')\n  nodeStatus.text = `${utils.getHHMMSSNow()} ${nodeStatus.text}`\n  node.status(nodeStatus)\n}\nreturn m ;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 760,
        "wires": [
            [
                "9c0f3e23e9286b36",
                "75bac89abeeb5a27",
                "d544888678a2bcd7"
            ]
        ]
    },
    {
        "id": "1d59f94a2acc3c1a",
        "type": "link in",
        "z": "fce55c80ba409b3d",
        "name": "influx in",
        "links": [
            "90da587f91c535d6"
        ],
        "x": 115,
        "y": 680,
        "wires": [
            [
                "b60bd0ec51857556"
            ]
        ]
    },
    {
        "id": "b60bd0ec51857556",
        "type": "switch",
        "z": "fce55c80ba409b3d",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "log/record/pid0",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 210,
        "y": 680,
        "wires": [
            [
                "9c4759a5aa1a682f"
            ]
        ]
    },
    {
        "id": "4db6202e94cea612",
        "type": "function",
        "z": "fce55c80ba409b3d",
        "name": "tag for influx",
        "func": "if (['local'].includes(msg.prefix) == false) {\n  node.error(msg.topic + \" only storing 'local' sensors \");\n  return null;   // it is not.  Use hops in future?\n}\n\n/*  \n  strip out the known tag fields and place in second array in payload. \n  this is the standard reporting format for influx.\n  The msg.topic is ignored\n*/\n\nconst fields = {};\nconst tags = {};\n\n/** \n * to make the text in grafana look nice\n * all temperatures have to be grouped together under a measurement category\n * you have one named field followed one tag which is the source.\n * Make the named field the location even though this wierd.\n */\nconst location = msg.location ? msg.location : msg.source ;\n\nfields[location] = msg.payload; // e.g. conference room\ntags['source'] = msg.source ;       // e.g M11 \n\nconst m = \n{\n  measurement : msg.param,          // e.g. battery\n  topic : msg.topic,\n  payload : [fields,tags]\n}\n\nconst isSet = (o, prop) => Object.hasOwn(o,prop) ? o[prop] : false\n\n//if (isSet(msg,'track')) \n  node.status({ fill: \"yellow\", shape: \"dot\", text: `${m.measurement} ${location}=${msg.payload} ${msg.source}` });\n\nreturn m;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 900,
        "wires": [
            []
        ]
    },
    {
        "id": "5df26a94adab42ee",
        "type": "debug",
        "z": "fce55c80ba409b3d",
        "name": "debug 54",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 340,
        "wires": []
    },
    {
        "id": "2d28df211ec8ace4",
        "type": "function",
        "z": "a39c97029f2c005f",
        "name": "response general v1",
        "func": "\nconst timeNow = Date.now()\nconst config = global.get(\"site-config\", 'file');\nconst instruments = global.get('instrumentation')\nconst utils = global.get(\"utils\")\n\n// should allow a list of sensors to be supplied rather \n// getting them from config\n\nfunction handleRequest()\n{\n  msg.topic = msg.topic.replace('request', 'response');\n\n  let tokens = msg.topic.split('/') ;\n  let topic =  tokens[tokens.length - 1]  ?? \"\"\n  let sensor = tokens[tokens.length - 2]  ?? \"\"\n\n  //node.error('ddd ' + topic)\n\n  switch(topic)\n  {\n    case 'siteConfig' :\n      msg.payload = config ;  \n      break \n\n    case 'online' :\n    case 'offline' :\n    case 'timedOut' :\n      const sensorsKnown = Object.keys(config['sensorMap'])\n      const res = utils.sensorStatus(sensorsKnown, instruments, 29, timeNow) \n      msg.payload = res[topic] ?? 'topic'\n      break\n\n    case 'pid' :\n      msg.payload = global.get('pid') || {nothing: 'here'}\n      break\n  } \n  return msg \n}\n\n\nreturn handleRequest(msg)\n\n/*\nmsg.payload = JSON.stringify(config, undefined, 4);\nmsg.payload = `ffeferf<br>809f8f0ef0ef80ef\\n3rd line`\nlet msgs = [\n        { topic: 'tty' ,  payload : 'trte tetert'},\n        { topic: 'tty' ,  payload : '3r34r34r4'}\n]\nlet msg1 = RED.util.cloneMessage(msg)\nmsg1 = Object()\nmsg1.topic = 'dwdd'\nmsg1.payload = 'refreferf'\nmsgs = [\n        msg,\n        msg\n]\n\nreturn [msgs];\n*/",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n/*\nvar defaultSensorMap = {\n    s0: 'outside',\n    s1: '1stFloor-hallway',\n    s2: 'entrance-hallway',\n    s3: 'bedroom2',\n    s4: 'unmapped',\n    s5: 'unmapped',\n    s6: 'unmapped',        \n    s10: 'test-location'\n};\n\nflow.set(\"sensorMap\", defaultSensorMap);\n\nvar defaultSite = '40hg';\nflow.set(\"site\"     , defaultSite);\n*/",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 220,
        "wires": [
            [
                "f07bdf58f4238213",
                "cc00546b6d89d585"
            ]
        ]
    },
    {
        "id": "b9659d5bd127c327",
        "type": "function",
        "z": "a39c97029f2c005f",
        "name": "response/IP",
        "func": "msg.topic = msg.topic.replace('request', 'response');\n// extract ip address from the results of a bash \n// ip command showing the interefaces.\nvar ifaceList = JSON.parse(msg.payload) ;\nmsg.measurement = 'health' ;\nvar ip = '?.?.?.?' ;\nfor (const [i, iface] of Object.entries(ifaceList))\n{\n    msg.payload = {\n\n        ip: iface.addr_info[0].local,\n        operstate: iface.operstate,\n        topic: msg.topic,\n        source: \"wyse2\", \n        location : null \n    };\n    if (iface.operstate == 'UP')\n        break ;\n}\nreturn msg ;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\nreturn(null)",
        "finalize": "// Code added here will be run when the\n// node is being stopped or re-deployed.\n\nvar mout = {};\nmout.topic = 'cax/link';\nmout.payload = [{\n\n    operstate: 'DOWN'\n},\n{\n    topic: mout.topic,\n    source: \"cax/wyse0\"\n}];\nreturn mout;",
        "libs": [],
        "x": 610,
        "y": 120,
        "wires": [
            [
                "f07bdf58f4238213"
            ]
        ]
    },
    {
        "id": "50733ff690d8c396",
        "type": "exec",
        "z": "a39c97029f2c005f",
        "command": "ip  -f inet -4 -json  address",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "5",
        "winHide": false,
        "oldrc": false,
        "name": "request/IP",
        "x": 430,
        "y": 120,
        "wires": [
            [
                "b9659d5bd127c327"
            ],
            [],
            []
        ]
    },
    {
        "id": "3576a0b9dd48029d",
        "type": "http request",
        "z": "a39c97029f2c005f",
        "name": "get weather",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://api.openweathermap.org/data/2.5/weather?q=London,uk&units=metric&APPID=02d6849de8880c4335b3a8b50c016843",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": true,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 410,
        "y": 60,
        "wires": [
            [
                "5329666e4bcd40e1"
            ]
        ]
    },
    {
        "id": "5329666e4bcd40e1",
        "type": "function",
        "z": "a39c97029f2c005f",
        "name": "weather sensor",
        "func": "msg.topic = 'weather';\nmsg.originalTopic = 'open/weather' ;\nmsg.prefix = 'local' ;\nmsg.location = msg.payload.name ;\n\n// msg.timestamp = ???  // should be using timestamp in message but cannot see it.\n\n// simulate the output of zigbee2mqtt sensor, payload has multiple properties\n\nmsg.payload = {\n    temperature: Number(msg.payload.main.temp),\n    // feelsLike: Number(msg.payload.main.feelsLike),\n    humidity: Number(msg.payload.main.humidity),\n    windSpeed: Number(msg.payload.wind.speed),\n    windDirection: Number(msg.payload.wind.deg)\n};\n//node.warn(`topic ${msg.topic}, temperature ${msg.payload.temperature}`);\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 60,
        "wires": [
            [
                "f28841e54458294f",
                "701f99c78058cf60"
            ]
        ]
    },
    {
        "id": "73f3bd8747e9b9e9",
        "type": "link out",
        "z": "a39c97029f2c005f",
        "name": "bridge responses out",
        "mode": "link",
        "links": [
            "3ae42568f19fb87e",
            "95659a05514705b8"
        ],
        "x": 435,
        "y": 180,
        "wires": []
    },
    {
        "id": "a9eb5943c4a448fd",
        "type": "inject",
        "z": "a39c97029f2c005f",
        "name": "30 min weather",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "1800",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "s0",
        "x": 190,
        "y": 60,
        "wires": [
            [
                "3576a0b9dd48029d"
            ]
        ]
    },
    {
        "id": "9cb37ce3eb45e324",
        "type": "inject",
        "z": "a39c97029f2c005f",
        "name": "IP",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "3000",
        "topic": "wakeup",
        "x": 150,
        "y": 120,
        "wires": [
            [
                "50733ff690d8c396"
            ]
        ]
    },
    {
        "id": "cdc2849e83ce87c7",
        "type": "switch",
        "z": "a39c97029f2c005f",
        "name": "app dispatch",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "app\\/request\\/weather",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "app\\/request\\/IP",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "app\\/response\\/",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "app\\/request\\/refresh",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "app\\/request\\/",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 5,
        "x": 190,
        "y": 300,
        "wires": [
            [
                "3576a0b9dd48029d"
            ],
            [
                "50733ff690d8c396"
            ],
            [
                "73f3bd8747e9b9e9"
            ],
            [
                "c7515d6ac70f764e"
            ],
            [
                "2d28df211ec8ace4"
            ]
        ],
        "info": "the regex here \n\nhttps://regex101.com/r/wlRMWz/1"
    },
    {
        "id": "c7515d6ac70f764e",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "refresh request",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 620,
        "y": 400,
        "wires": []
    },
    {
        "id": "3d273fe27e049b65",
        "type": "link in",
        "z": "a39c97029f2c005f",
        "name": "dispatch to app",
        "links": [
            "7b7a4dd23fba8082"
        ],
        "x": 195,
        "y": 200,
        "wires": [
            [
                "cdc2849e83ce87c7"
            ]
        ]
    },
    {
        "id": "f07bdf58f4238213",
        "type": "link out",
        "z": "a39c97029f2c005f",
        "name": "MQTT both",
        "mode": "link",
        "links": [
            "8b799875a8ef011e"
        ],
        "x": 705,
        "y": 300,
        "wires": []
    },
    {
        "id": "95191d0245230bea",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "updateMQTT",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 650,
        "y": 460,
        "wires": []
    },
    {
        "id": "6e4f4737d3d2738b",
        "type": "link in",
        "z": "a39c97029f2c005f",
        "name": "downsampler in",
        "links": [
            "2384d6ea06ea6969"
        ],
        "x": 185,
        "y": 500,
        "wires": [
            [
                "ca4c7e7c54ba2693"
            ]
        ]
    },
    {
        "id": "f28841e54458294f",
        "type": "link out",
        "z": "a39c97029f2c005f",
        "name": "weather",
        "mode": "link",
        "links": [
            "a2eff66e24c128f6"
        ],
        "x": 785,
        "y": 60,
        "wires": []
    },
    {
        "id": "cc00546b6d89d585",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "debug 8",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 360,
        "wires": []
    },
    {
        "id": "f15ca2197c7843a7",
        "type": "function",
        "z": "a39c97029f2c005f",
        "name": "utils",
        "func": "// look in the On Start tab\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\nconst utils =\n{\n    square:((a) =>  a * a),\n\n    oneDecPoint : (n) => (Math.round(n * 10) / 10),\n    twoDecPoint : (n) => (Math.round(n * 100) / 100),\n    //toFix : (num, precision) => (Math.trunc(num * (10 ** precision))) / (10 ** precision),\n    toFix: (num, precision) => (Math.round(num * (10 ** precision))) / (10 ** precision),\n\n    getHHMM: (millis) => new Date(millis).toTimeString().substring(0, 5),\n    getHHMMSS: (millis) => new Date(millis).toTimeString().substring(0, 8),\n\n    getHHMMNow: () => utils.getHHMM(Date.now()),\n    getHHMMSSNow: () => utils.getHHMMSS(Date.now()),\n    \n    getTimeNow: () => utils.getHHMM(Date.now()),\n\n    sensorStatus: (sensorsKnown, instruments, minutes, timeNow) => \n    {\n        const isTimedOut = ((name) => instruments[name + '/temperature'].timestamp\n            + 1000 * 60 * minutes < timeNow)\n\n        const sensorsActive = Object.keys(instruments)\n            .filter((s) => s.split('/')[1] == 'temperature')\n            .map((s) => s.split('/')[0])\n\n        const sensorsOffline = sensorsKnown\n            .filter((name) => !sensorsActive.includes(name))\n\n        const timedOut2 = sensorsActive\n            .filter((name) => sensorsActive.includes(name))\n            .filter((name) => isTimedOut(name))\n\n        const timedOut = sensorsActive\n            .filter((name) => sensorsActive.includes(name))\n            .filter((name) => isTimedOut(name))\n            .map((name) => name + ':'\n                + utils.getHHMM(instruments[name + '/temperature'].timestamp ?? 0))\n\n        const sensorsOnline = sensorsActive\n            .filter((name) => (!isTimedOut(name)))\n\n        return { online: sensorsOnline, timedOut: timedOut, timedOut2: timedOut2,  offline: sensorsOffline }\n    }\n\n}\nglobal.set(\"utils\", utils)",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "4155f40899b57319",
        "type": "link out",
        "z": "a39c97029f2c005f",
        "name": "sensors clocked",
        "mode": "link",
        "links": [
            "f2e5754610a2a6d1"
        ],
        "x": 595,
        "y": 580,
        "wires": []
    },
    {
        "id": "93a735363165e2dd",
        "type": "comment",
        "z": "a39c97029f2c005f",
        "name": "store last message, timeout and fetch all",
        "info": "",
        "x": 220,
        "y": 380,
        "wires": []
    },
    {
        "id": "7a541e60b47ceaf0",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "b0",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 760,
        "wires": []
    },
    {
        "id": "76c380e8f0091c9a",
        "type": "function",
        "z": "a39c97029f2c005f",
        "name": "calculate b0",
        "func": "/**\n *\n * ver 2.0\n */\n\nconst timeNow = Date.now()\n\nconst siteConfig = global.get('site-config', 'file') ?? {}\n\nconst utils = global.get('utils')\n\nconst sensorWeight =\n  [\n    { name: 'g3', weight: 1 }, // main entrance \n    { name: 'g4', weight: 1 }, // cu ground\n    { name: 'm0', weight: 1 }, // first floor corridor\n    { name: 'm3', weight: 1 }, // cu front\n  ]\n\n\n// need to move this out to app node that calculate this\n\nfunction calculateBuildingTemperature(instruments, minsTimeout) \n{ \n  const sensorsKnown = Object.keys(siteConfig['sensorMap'])\n  // note messages are stored in instruments\n  // make instrument temperatures easier to access\n  const sensorTemp = ((name) => instruments[name + '/temperature'].payload)\n\n  const sensorsReport = utils.sensorStatus(sensorsKnown, instruments, minsTimeout, timeNow)\n\n  const sensors = sensorWeight\n    // filter the sensorWeight table so only online sensors included\n    .filter((w) => (sensorsReport['online'].includes(w.name)))\n    \n    // create new map of weighted temperatures\n    .map((e) => ({  name: e.name, \n                    t: sensorTemp(e.name), \n                    wt: sensorTemp(e.name) * e.weight, w: e.weight \n                }))\n    // filter out suspect values\n    //.filter((e) => 16 < e.t && e.t < 23 && e.t != 22)\n    \n  const sensorIDs = sensors.map((e) => e.name).join(\",\")\n\n  // calculate weighted average\n  const buildingTemperature = sensors.reduce((sum, e, idx) => (sum + e.wt), 0)\n    / sensors.reduce((sum, e, idx) => (sum + e.w), 0)\n\n  node.status({\n    fill: \"yellow\", shape: \"dot\",\n    text: `${utils.getHHMMSS(timeNow)} b0:${buildingTemperature.toFixed(1)} [${sensorIDs}]`\n  });\n  return buildingTemperature\n}\n\n/**\n* @param {NodeMessage} msg\n*/\n\nfunction processUpdates(msg) \n{\n//  const tokens = msg.topic.split(\"/\")\n//  const sensorName = tokens[0]\n//  const sensorProperty = tokens[1]\n\n  const instrumentation = msg.payload ;\n\n  let b0 = null\n\n\n//  const sensorsSelected = sensorWeight.map((e) => e.name)\n//  if (sensorsSelected.includes(sensorName)) \n//    if (['temperature'].includes(sensorProperty)) \n  {\n    const bt = calculateBuildingTemperature(instrumentation, 31)\n\n    // create a virtual sensor \n    b0 = {\n      topic:        'b0/temperature',\n      source:       'b0',\n      location:     'building',\n      payload:      Math.round(100 * bt) / 100, // update on 0.01 increments\n      bt0:          Math.round(100 * bt) / 100, // update on 0.01 increments\n      param:        'temperature',  // needed for influx\n      prefix:       'local',        // pretend to be a sensor, albeit virtual, so influx stores\n      reportOnDiff: 0.1,            \n      windowPeriodSecs: 15 * 60 ,   // report every 10 minutes regardless\n      track: true                   // update status text under node\n    }\n    //b0 = isNaN(bt) ? null : b0 ;\n  }\n  return b0\n}\n\nconst m = processUpdates(msg)\n//node.error(\"exiting dump history\" + JSON.stringify(history));\nreturn m",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 760,
        "wires": [
            [
                "7a541e60b47ceaf0",
                "228b073ae77b7894"
            ]
        ]
    },
    {
        "id": "228b073ae77b7894",
        "type": "link out",
        "z": "a39c97029f2c005f",
        "name": "b0",
        "mode": "link",
        "links": [
            "3a0b7c61797ade28",
            "c4d8aeb565e0b70e",
            "a1813311ef8ad85c"
        ],
        "x": 595,
        "y": 620,
        "wires": []
    },
    {
        "id": "3d6616cfe2646003",
        "type": "inject",
        "z": "a39c97029f2c005f",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "clear",
        "payload": "true",
        "payloadType": "bool",
        "x": 140,
        "y": 560,
        "wires": [
            [
                "ca4c7e7c54ba2693"
            ]
        ]
    },
    {
        "id": "d9119ac89c432692",
        "type": "inject",
        "z": "a39c97029f2c005f",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "get/all",
        "payload": "true",
        "payloadType": "bool",
        "x": 140,
        "y": 600,
        "wires": [
            [
                "ca4c7e7c54ba2693"
            ]
        ]
    },
    {
        "id": "56c75ff589319c10",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "updateDashboard",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 670,
        "y": 500,
        "wires": []
    },
    {
        "id": "75b27d2f659b385d",
        "type": "link in",
        "z": "a39c97029f2c005f",
        "name": "bridge device availability",
        "links": [
            "2518a4fd104ebb54"
        ],
        "x": 185,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "fed19cb666ad3b46",
        "type": "link out",
        "z": "a39c97029f2c005f",
        "name": "MQTT cloud",
        "mode": "link",
        "links": [
            "ae83978daa30c005"
        ],
        "x": 595,
        "y": 540,
        "wires": []
    },
    {
        "id": "2c5be8f103fc9a6b",
        "type": "function",
        "z": "a39c97029f2c005f",
        "name": "set config v2",
        "func": "const sensorList = msg.payload ;\n\nconst sensorMap = {} ;\n\nfor (const dev of sensorList)\n  if (dev.description)\n    sensorMap[dev.friendly_name] = dev.description ;\n\nconst numDevices = Object.keys(sensorMap).length; \n\nconst siteConfig = { site: 'cax',  sensorMap: sensorMap} \n\nglobal.set(\"site-config\", siteConfig, 'file');\n\nconst utils = global.get('utils');\nnode.status({\n    fill: \"green\", shape: \"dot\",\n    text: `${utils.getHHMMSSNow()} zigbee2mqtt map saved, ${numDevices} devices`\n});\n\nreturn { topic: 'site-config', payload: siteConfig };\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 840,
        "wires": [
            [
                "e83e0411a2fb1b2a"
            ]
        ]
    },
    {
        "id": "e83e0411a2fb1b2a",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "debug 49",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 840,
        "wires": []
    },
    {
        "id": "28f2afe4d33649c3",
        "type": "link in",
        "z": "a39c97029f2c005f",
        "name": "bridge device list",
        "links": [
            "19c30800fa95c445"
        ],
        "x": 175,
        "y": 840,
        "wires": [
            [
                "2c5be8f103fc9a6b"
            ]
        ]
    },
    {
        "id": "eb32ad981cfd4d2e",
        "type": "function",
        "z": "a39c97029f2c005f",
        "name": "msg table",
        "func": "\n/**\n * handle requests for sensor messsage recalls\n */\nlet nodeStatus = null ;\n//{ fill: \"green\", shape: \"dot\", text: `not-set` };\n\n\nfunction clearProperties(ob){\n  for (let k in ob)\n    delete ob[k] \n}\n\n// const clearProperties2 = (ob) => ({ for (let k in ob) delete ob[k] })\n\n// don't store items that are not objects\n\nfunction isValidMessage(msg, instrumentation)\n{\n  //node.error('abc', msg)\n  if (typeof msg !== 'object')\n  {\n    nodeStatus = { fill: \"red\", shape: \"triangle\", text: `rejecting ${msg.topic}, not an object` };\n    return false ;\n  }\n\n  if (msg.payload === undefined)\n  {\n    nodeStatus = { fill: \"red\", shape: \"triangle\", text: `rejecting ${msg.topic}, no payload` } ;\n    return false ;\n  }\n  return true ;\n}\n\n\nconst updateMQTT = [] ;\nconst updateDashboard = [];\n\n\nfunction handleMessage(msg, instrumentation)\n{\n  if (msg.topic === undefined) \n    node.red(msg.payload)\n\n  switch(msg.topic)\n  {\n    case 'app/request/refresh' :\n    case 'get/all' :\n      // strip out the keys\n      let ar = Object.values(instrumentation)\n      nodeStatus = { fill: \"green\", shape: \"dot\", text: `fetched ${ar.length} items`};\n      // and replay the stream of messages\n      //return [] ;\n      updateMQTT.push(...ar)\n      break ;\n\n    case 'clear' :\n      let ar2 = Object.values(instrumentation)\n      nodeStatus = { fill: \"green\", shape: \"dot\", text: `cleared ${ar2.length} items`};\n      clearProperties(instrumentation);\n      flow.set(\"instrumentation\", instrumentation);\n      break ;\n\n    case 'availability' :\n      const m = instrumentation[msg.topic]     \n      m.state = msg.payload; \n      updateDashboard.push(m)\n      updateMQTT.push(m)\n      break ;\n\n    default :\n      nodeStatus = { fill: \"red\", shape: \"dot\", text: `stored ${msg.topic} ${msg.payload}`};\n      if (isValidMessage(msg, instrumentation))\n      {\n        if (msg.timestamp === undefined)\n          msg.timestamp = Date.now()\n        instrumentation[msg.topic] = msg;\n        updateDashboard.push(msg)\n        updateMQTT.push(msg)        \n        flow.set('instrumentation', instrumentation)\n        nodeStatus = { fill: \"blue\", shape: \"dot\", text: `stored ${msg.topic} ${msg.payload}`};\n        \n      }\n      else\n        node.error('invalid message', msg)\n      break ;\n  }\n}\n\n\n/**\n *  now timeout some messages\n **/\n\nfunction sensorHousekeeping(msg)\n{\n  const siteConfig = global.get('site-config') ?? {}\n  const sensorsKnown = Object.keys(siteConfig['sensorMap'])\n  const utils = global.get('utils')\n\n  const sensorStatus = utils.sensorStatus(sensorsKnown, instrumentation, 30, Date.now())\n  //node.error(\"my error message 1 \" + JSON.stringify(sensorStatus), msg);\n  let numTimeouts = 0\n  //node.error(\"my error message 2 \" + JSON.stringify(sensorStatus.timedOut2), msg);\n  for (const name of sensorStatus.timedOut2) {\n    const topic = name + \"/temperature\";\n    numTimeouts += 1\n    if (instrumentation[topic] !== undefined) {\n      if (instrumentation[topic].hasTimedOut != true) {\n        instrumentation[topic].hasTimedOut = true;\n        //node.error('timeout 2d ' + JSON.stringify(instrumentation[topic]))\n        updateDashboard.push(instrumentation[topic])   // push message out to dashboard\n      }\n    }\n  }\n  \n  // save updated timeouts \n  context.set(\"instrumentation\", instrumentation ); // large write... but to memory\n  \n  const numSensors = sensorsKnown.length ;\n  const numTimedOut = sensorStatus.timedOut  ;\n  //node.error(\"my error message 3 \" + JSON.stringify(msg), msg);\n  const texxt = `${numTimeouts} sensors timed out, total ${numSensors}`;\n  if (nodeStatus == null)\n    nodeStatus = { fill: \"green\", shape: \"dot\", text : texxt }\n}\n\n// save and store message if validated\nconst instrumentation = flow.get(\"instrumentation\") ?? {}\nconst mqtt = handleMessage(msg, instrumentation)\n\nsensorHousekeeping()\n\nif (nodeStatus)\n{\n  const utils = global.get('utils');\n  nodeStatus.text = `${utils.getHHMMSSNow()} ${nodeStatus.text}`;\n  node.status(nodeStatus);\n} \n\nconst mtable = { topic: 'mtable', payload: instrumentation}\n\nreturn [updateMQTT, updateDashboard, mtable];\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 940,
        "wires": [
            [],
            [],
            []
        ],
        "inputLabels": [
            "data stream"
        ],
        "outputLabels": [
            "updateMQTT",
            "updateDashboard",
            "instrumentation"
        ]
    },
    {
        "id": "ca4c7e7c54ba2693",
        "type": "function",
        "z": "a39c97029f2c005f",
        "name": "msg table",
        "func": "\n\nconst utils = global.get('utils');\nconst siteConfig = global.get('site-config', 'file') ?? {}\n\nconst timeNow = Date.now();\nlet nodeStatus = null;\nconst updateMQTT = [];\nconst updateDashboard = [];\n\n/**\n * handle requests for sensor messsage recalls\n */\n\nfunction clearProperties(ob) {\n  for (let k in ob)\n    delete ob[k]\n}\n\n// const clearProperties2 = (ob) => ({ for (let k in ob) delete ob[k] })\n\n// don't store items that are not objects\n\nfunction isSensorMessage(msg) {\n\n  if (typeof msg !== 'object') {\n    nodeStatus = { fill: \"red\", shape: \"triangle\", text: `rejecting ${msg.topic}, not an object` };\n    return false;\n  }\n  // sensor pattern, 1 letter, 1 or 2 digits\n  //if (/^[adprsgmt][^\\d]*[\\d]{1,2}/.test(msg.topic) == false)\n    //return false;\n\n  if (msg.payload === undefined) {\n    nodeStatus = { fill: \"red\", shape: \"triangle\", text: `rejecting ${msg.topic}, no payload` };\n    return false;\n  }\n  return true;\n}\n\n\nfunction handleMessage(msg, instrumentation) {\n  if (msg.topic === undefined)\n    node.error(msg)\n    \n  let tokens = msg.topic.split('/') ;\n  let subtopic =  tokens[tokens.length - 1]  ?? \"\"\n  let sensor = tokens[tokens.length - 2]  ?? \"\"\n\n  const replyTopic = msg.topic.replace('sensor0/get', 'sensor0');  \n\n  switch (msg.topic) {\n    \n    case 'recall' :\n    case 'sensor0/get/all':\n      // strip out the keys\n      let ar = Object.values(instrumentation)\n      nodeStatus = { fill: \"green\", shape: \"dot\", text: `fetched ${ar.length} items` };\n      // and replay the stream of messages\n      // return [] ;\n      updateMQTT.push(...ar)\n      break;\n\n    case 'sensor0/get/siteConfig' :\n      const mout = {\n        topic:  replyTopic,\n        payload: siteConfig\n      }\n      updateMQTT.push(mout);\n      break       \n      \n    case 'sensor0/get/online':\n    case 'sensor0/get/offline':\n    case 'sensor0/get/timedOut':\n    \n      const sensorsKnown = Object.keys(siteConfig['sensorMap'])\n      const res = utils.sensorStatus(sensorsKnown, instrumentation, 29, timeNow)\n      const n = {\n        topic:  replyTopic,\n        payload: res[subtopic] ?? 'topic'\n      }\n      updateMQTT.push(n);\n      break\n      \n      \n    case 'clear':\n      let ar2 = Object.values(instrumentation)\n      nodeStatus = { fill: \"green\", shape: \"dot\", text: `cleared ${ar2.length} items` };\n      clearProperties(instrumentation);\n      flow.set(\"instrumentation\", instrumentation);\n      break;\n      \n    case 'availability':\n      const m = instrumentation[msg.topic]\n      m.state = msg.payload;\n      updateDashboard.push(m)\n      updateMQTT.push(m)\n      break;\n    \n    default:\n      if (msg.topic.startsWith('sensor0'))   // suppress echo of sensor0 output!\n        break \n      nodeStatus = { fill: \"red\", shape: \"dot\", text: `stored ${msg.topic} ${msg.payload}` };\n      if (isSensorMessage(msg)) {\n        if (msg.timestamp === undefined)\n          msg.timestamp = Date.now()\n          instrumentation[msg.topic] = msg;\n        updateDashboard.push(msg)\n        updateMQTT.push(msg)\n        flow.set('instrumentation', instrumentation)\n        nodeStatus = { fill: \"blue\", shape: \"dot\", text: `stored ${msg.topic} ${msg.payload}` }; \n      }\n      else\n        node.error('invalid message ' + JSON.stringify(msg), msg)\n        break;\n  }\n}\n\n\n/**\n *  now timeout some messages\n **/\n\nfunction sensorHousekeeping(msg) \n{\n  const sensorsKnown = Object.keys(siteConfig['sensorMap'])\n  \n  const sensorStatus = utils.sensorStatus(sensorsKnown, instrumentation, 30, Date.now())\n  //node.error(\"my error message 1 \" + JSON.stringify(sensorStatus), msg);\n  let numTimeouts = 0\n  //node.error(\"my error message 2 \" + JSON.stringify(sensorStatus.timedOut2), msg);\n  for (const name of sensorStatus.timedOut2) {\n    const topic = name + \"/temperature\";\n    numTimeouts += 1\n    if (instrumentation[topic] !== undefined) {\n      if (instrumentation[topic].hasTimedOut != true) {\n        instrumentation[topic].hasTimedOut = true;\n        //node.error('timeout 2d ' + JSON.stringify(instrumentation[topic]))\n        updateDashboard.push(instrumentation[topic])   // push message out to dashboard\n      }\n    }\n  }\n  \n  // save updated timeouts \n  context.set(\"instrumentation\", instrumentation); // large write... but to memory\n  \n  const numSensors = sensorsKnown.length;\n  const numTimedOut = sensorStatus.timedOut;\n  //node.error(\"my error message 3 \" + JSON.stringify(msg), msg);\n  const texxt = `${numTimedOut} sensors timed out, total ${numSensors}`;\n  if (nodeStatus == null)\n    nodeStatus = { fill: \"green\", shape: \"dot\", text: texxt }\n}\n\n// save and store message if validated\nconst instrumentation = flow.get(\"instrumentation\") ?? {}\nconst mqtt = handleMessage(msg, instrumentation)\n\n//sensorHousekeeping()\n\nif (nodeStatus) {\n  nodeStatus.text = `${utils.getHHMMSSNow()} ${nodeStatus.text}`;\n  node.status(nodeStatus);\n}\n\nconst mtable = { topic: 'sensorTable', payload: instrumentation }\n\nreturn [updateMQTT, updateDashboard, mtable];\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 560,
        "wires": [
            [
                "95191d0245230bea",
                "fed19cb666ad3b46"
            ],
            [
                "4155f40899b57319",
                "56c75ff589319c10"
            ],
            [
                "76c380e8f0091c9a"
            ]
        ],
        "inputLabels": [
            "data stream"
        ],
        "outputLabels": [
            "updateMQTT",
            "updateDashboard",
            "instrumentation"
        ]
    },
    {
        "id": "465c4179d88871f8",
        "type": "inject",
        "z": "a39c97029f2c005f",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "sensor0/get/timedOut",
        "payload": "true",
        "payloadType": "bool",
        "x": 190,
        "y": 640,
        "wires": [
            [
                "ca4c7e7c54ba2693"
            ]
        ]
    },
    {
        "id": "3673e8287d4e94c9",
        "type": "inject",
        "z": "a39c97029f2c005f",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "sensor0/get/offline",
        "payload": "true",
        "payloadType": "bool",
        "x": 180,
        "y": 680,
        "wires": [
            [
                "ca4c7e7c54ba2693"
            ]
        ]
    },
    {
        "id": "9cbc7538419f9d28",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "debug 51",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 450,
        "y": 340,
        "wires": []
    },
    {
        "id": "463ad07330f8ce74",
        "type": "link in",
        "z": "a39c97029f2c005f",
        "name": "sensor0 get/set",
        "links": [
            "a1eb201860b28d15"
        ],
        "x": 185,
        "y": 460,
        "wires": [
            [
                "ca4c7e7c54ba2693",
                "673ce2f87b4e34ac"
            ]
        ]
    },
    {
        "id": "673ce2f87b4e34ac",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "debug 52",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 330,
        "y": 460,
        "wires": []
    },
    {
        "id": "701f99c78058cf60",
        "type": "debug",
        "z": "a39c97029f2c005f",
        "name": "debug 53",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 100,
        "wires": []
    },
    {
        "id": "ee6878a5cca418a8",
        "type": "inject",
        "z": "e7fcf1f501be8b60",
        "name": "tick 30 secs",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "30",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "tick",
        "x": 130,
        "y": 140,
        "wires": [
            [
                "514bcf2a52af1cf0"
            ]
        ]
    },
    {
        "id": "bacb43412f50be7f",
        "type": "function",
        "z": "e7fcf1f501be8b60",
        "name": "scheduler v1",
        "func": "\nfunction addZero(i) {\n  if (i < 10) {i = \"0\" + i}\n  return i;\n}\n\nfunction getTimeNow()\n{\n  const d = new Date()\n  return d.toTimeString().substring(0, 5)\n}\n\nconst timeNow = getTimeNow()\nconst tokens = msg.topic.split(\"/\")\nconst command = tokens[tokens.length - 1]\n\nlet schedule = flow.get(\"schedule\") || { start: '12:00', stop: '12:00', unit: { status : null} }\n\n//node.error(`schedule ${schedule.start} ${schedule.stop} ${schedule.unit.status}`)\n\nlet timeChange = false ; \nlet response = null ; \nswitch (command) {\n    case 'start'  :\n        schedule.start = msg.payload \n        timeChange = true ; \n        break \n    case 'stop':\n        schedule.stop = msg.payload \n        timeChange = true ; \n        break \n    case 'refresh':    \n        timeChange = true ; \n        break ;\n} \n\n\n// Note that if start and stop time are the same, that means 24 operation\n// text string comparison\n\nlet unitShouldBeOn = schedule.start <= timeNow && timeNow <= schedule.stop; \n\nif (timeChange)\n{\n  const mstart = {}\n  mstart.topic = `app/response/schedule/start`\n  mstart.payload = schedule.start ?? 'hh:mm' \n\n  const mstop = {}\n  mstop.topic = `app/response/schedule/stop`\n  mstop.payload = schedule.stop ?? 'hh:mm' \n\n  //const h = {}   // hours not used\n  //h.topic = `app/response/schedule/${command}/hour`\n  //h.payload = schedule[command].substring(0,2)\n\n  const s = {} \n  s.topic = 'app/response/schedule'\n  s.payload = `${timeNow}:  ${schedule.start} -> ${schedule.stop} unitShouldBeOn: ${unitShouldBeOn}`\n\n  response = [mstart,mstop,s]\n  node.status({fill:\"yellow\",shape:\"ring\",text:`${command} ${msg.payload}`});\n\n  node.error(s.payload);\n}\n\n\n\nlet control = null\nif (schedule && schedule.unit.status !== undefined &&  unitShouldBeOn == schedule.unit.status) {\n  // unit status is unchanged\n  control = null ;\n}\nelse {\n  control = {} \n  control.topic = 'PROTOCOL_CHIL_OCC'  // modbus register\n  control.payload = unitShouldBeOn ? 1 : 0;\n  control.writeThrough = true ;\n  schedule.unit = { status : unitShouldBeOn };\n  node.status({ fill: \"red\", shape: \"ring\", text: `${timeNow}: unitOn:${unitShouldBeOn}` });\n}\nif (response || control)\n  flow.set(\"schedule\", schedule)\n\nreturn [response ?? null, control ?? null];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n//flow.set(\"schedule\", { start: '06:00', stop: '16:30', unit: {} })",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 420,
        "wires": [
            [
                "b8d9de514450140a"
            ],
            [
                "207bd26d97d91d04"
            ]
        ]
    },
    {
        "id": "b8d9de514450140a",
        "type": "debug",
        "z": "e7fcf1f501be8b60",
        "name": "response",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 380,
        "wires": []
    },
    {
        "id": "207bd26d97d91d04",
        "type": "debug",
        "z": "e7fcf1f501be8b60",
        "name": "control",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 630,
        "y": 460,
        "wires": []
    },
    {
        "id": "c98b6b30b5fddbb3",
        "type": "ui-form",
        "z": "e7fcf1f501be8b60",
        "name": "scheduler0",
        "group": "a08f5caa6b7f253a",
        "label": "",
        "order": 1,
        "width": null,
        "height": null,
        "options": [
            {
                "label": "Weekday Start time",
                "key": "start",
                "type": "time",
                "required": true,
                "rows": null
            },
            {
                "label": "Weekday Stop time",
                "key": "stop",
                "type": "time",
                "required": true,
                "rows": null
            }
        ],
        "formValue": {
            "start": "",
            "stop": ""
        },
        "payload": "",
        "submit": "submit",
        "cancel": "clear",
        "resetOnSubmit": true,
        "topic": "set/schedule",
        "topicType": "str",
        "splitLayout": "",
        "className": "",
        "passthru": false,
        "dropdownOptions": [],
        "x": 350,
        "y": 40,
        "wires": [
            [
                "514bcf2a52af1cf0"
            ]
        ]
    },
    {
        "id": "514bcf2a52af1cf0",
        "type": "function",
        "z": "e7fcf1f501be8b60",
        "name": "scheduler 2",
        "func": "const defaultSchedule = \n{\n  start : '23:40',\n  stop  : '23:45',\n  offOn : false\n}\n\nconst utils = global.get(\"utils\")\n\nconst schedule = Object.assign(defaultSchedule, context.get(\"schedule\", \"file\") ?? {})\n\nconst tokens = msg.topic.split(\"/\")\nconst command = tokens[tokens.length - 1]\n\nlet timeChange = false ;\nlet recall = false ; \nlet advance = false ; \nlet responses = null ; \nlet formResponse = null ;\n\nswitch (command) {\n    // from MQTT\n    case 'start'  :\n        schedule.start = msg.payload.substring(0, 5) \n        timeChange = true ; \n        break \n    case 'stop':\n        schedule.stop = msg.payload.substring(0, 5)  \n        timeChange = true ; \n        break \n    case 'all': \n        recall = true ;   \n    case 'tick': \n        break ;\n    \n    case 'advance' :\n        advance = true ;   \n        break ;\n\n        \n    // from the webform and MQTT\n    case 'schedule' :    \n        schedule.start = msg.payload.start;\n        schedule.stop = msg.payload.stop;\n        timeChange = true ; \n        break ;\n    \n    default: \n        node.error('Not expecting ' + msg.topic)\n}        \n\nconst timeNow = utils.getTimeNow();\n\nlet offOn = schedule.start != schedule.stop \n    ? schedule.start <= timeNow && timeNow <= schedule.stop \n    : true ;\n\nif (advance)\n    offOn = !schedule.offOn ;\n\nconst offOnText = offOn ? 'start': 'stop' \n\nconst texxt = `${timeNow}: ${offOnText} 🕐${schedule.start}↦${schedule.stop}`\n\nif (timeChange || recall)\n{\n  formResponse = { 'topic' : 'clock0/set/schedule', 'payload' : schedule };\n\n  const mstart = {}\n  mstart.topic = `clock0/schedule/start`\n  mstart.payload = schedule.start ?? 'hh:mm' \n\n  const mstop = {}\n  mstop.topic = `clock0/schedule/stop`\n  mstop.payload = schedule.stop ?? 'hh:mm' \n\n  const s = {} \n  s.topic = 'clock0/get/all'\n  s.payload = texxt ;\n\n  responses = [mstart,mstop]\n  node.status({fill:\"yellow\", shape:\"dot\", text:texxt});\n\n  //node.error(s.payload);\n}\nlet control = null ;\nif (schedule.offOn != offOn )\n{\n    schedule.offOn = offOn ;\n    control = { topic : 'schedule', payload : offOnText }\n    node.status({fill:offOn ? \"green\":\"grey\", shape:\"dot\", text:texxt});\n}\nif (timeChange || control)\n  context.set(\"schedule\", schedule, \"file\")\n\nreturn [[formResponse], responses, [control]];",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 140,
        "wires": [
            [
                "c98b6b30b5fddbb3",
                "2b8ee51b72781f75"
            ],
            [
                "942e10aa6b9bc92e",
                "7972b448b09af4d9"
            ],
            [
                "38c8f9bc814df53b",
                "e70ba65277e5fe4f"
            ]
        ]
    },
    {
        "id": "2b8ee51b72781f75",
        "type": "debug",
        "z": "e7fcf1f501be8b60",
        "name": "formResponse",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 100,
        "wires": []
    },
    {
        "id": "5160c12d4a8d8e95",
        "type": "link in",
        "z": "e7fcf1f501be8b60",
        "name": "clock0",
        "links": [
            "605b2b84a661dbbc",
            "848510da6b3c8e83"
        ],
        "x": 185,
        "y": 180,
        "wires": [
            [
                "514bcf2a52af1cf0"
            ]
        ]
    },
    {
        "id": "942e10aa6b9bc92e",
        "type": "debug",
        "z": "e7fcf1f501be8b60",
        "name": "mqttResponse",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 200,
        "wires": []
    },
    {
        "id": "7972b448b09af4d9",
        "type": "link out",
        "z": "e7fcf1f501be8b60",
        "name": "clock0",
        "mode": "link",
        "links": [
            "8b799875a8ef011e"
        ],
        "x": 595,
        "y": 160,
        "wires": []
    },
    {
        "id": "38c8f9bc814df53b",
        "type": "debug",
        "z": "e7fcf1f501be8b60",
        "name": "control",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 630,
        "y": 300,
        "wires": []
    },
    {
        "id": "e70ba65277e5fe4f",
        "type": "link out",
        "z": "e7fcf1f501be8b60",
        "name": "scheduleControl",
        "mode": "link",
        "links": [
            "52fa1182d5cd2dff"
        ],
        "x": 595,
        "y": 260,
        "wires": []
    },
    {
        "id": "0a617bea90cec73f",
        "type": "ui-form",
        "z": "e7fcf1f501be8b60",
        "name": "scheduler1",
        "group": "3b9fea2ad4f5df3c",
        "label": "",
        "order": 1,
        "width": null,
        "height": null,
        "options": [
            {
                "label": "Weekend Start time",
                "key": "start",
                "type": "time",
                "required": true,
                "rows": null
            },
            {
                "label": "Weekend Stop time",
                "key": "stop",
                "type": "time",
                "required": true,
                "rows": null
            }
        ],
        "formValue": {
            "start": "",
            "stop": ""
        },
        "payload": "",
        "submit": "submit",
        "cancel": "clear",
        "resetOnSubmit": true,
        "topic": "updateSchedule",
        "topicType": "str",
        "splitLayout": "",
        "className": "",
        "passthru": false,
        "dropdownOptions": [],
        "x": 550,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "57a65d7e6a100b88",
        "type": "link out",
        "z": "ce7503bf65214c43",
        "name": "to downsample",
        "mode": "link",
        "links": [],
        "x": 635,
        "y": 340,
        "wires": []
    },
    {
        "id": "52fa1064dec1e311",
        "type": "PID",
        "z": "ce7503bf65214c43",
        "name": "PID control",
        "setpoint": "20",
        "pb": "1",
        "ti": "99999",
        "td": 0,
        "integral_default": "0.33",
        "smooth_factor": 3,
        "max_interval": "1800",
        "enable": "1",
        "disabled_op": "0",
        "x": 230,
        "y": 240,
        "wires": [
            [
                "8c621caee9ea19f2"
            ]
        ]
    },
    {
        "id": "8c621caee9ea19f2",
        "type": "function",
        "z": "ce7503bf65214c43",
        "name": "set point",
        "func": "//really need to different handler functions for settings and ashp control\n\n\nconst utils =\n{\n  getHHMM: ((millis) => {\n    const d = new Date(millis)\n    return d.toTimeString().substring(0, 5)\n  }),\n  timeNow : (() => utils.getHHMM(Date.now()))\n}\n\nconst settings = context.get('pid') ??  { setpoint : 20.0, rangeLow : 32, maxFlow : 46, rangeHigh : 50 }\n\nconst twoDecPoint = (n) => (Math.round(n * 100) / 100)\n\nconst tokens = msg.topic.split(/[\\/]/);\nconst subTopic = tokens.at(-1);  \nlet waterSetPoint = null ;\n\nconst noticeOf = (settings, subTopic) => ({\n    topic:      'pid0/' + subTopic,\n    measurement: 'temperature',\n    payload:     settings[subTopic],\n    prefix:     'local'\n}) \n\n/* \n    every time we process an incoming message \n    just push out notices indicating what's going on\n*/\n\nconst ashpControl = [] \nconst notices = []\n\nswitch (msg.topic) {\n    case 'app/request/pid0/maxFlow' :\n    case 'app/request/pid0/rangeLow' :\n    case 'app/request/pid0/rangeHigh' :    \n        settings[subTopic] = parseInt(msg.payload) ;\n        context.set('pid', settings)\n        notices.push( noticeOf(settings, subTopic))       \n        node.status({\n            fill: \"blue\", shape: \"dot\",\n            text: `${utils.timeNow()} ${subTopic}:${settings[subTopic]}`\n        })\n        break ;\n        //return [null, null] ;\n \n    case 'app/request/refresh':\n        for (const [key, value] of Object.entries(settings)) \n            notices.push(noticeOf(settings, key))\n        break ;\n\n    case 'b0/temperature' :\n        waterSetPoint = settings.rangeLow + msg.payload * (settings.rangeHigh - settings.rangeLow)\n        waterSetPoint = twoDecPoint(Math.min(settings.maxFlow,  waterSetPoint))\n        break ;\n        \n    default :\n        node.error('unable to process ' + msg.topic)\n}\n\n\nif (waterSetPoint)\n{ \n    ashpControl.push({ \n        topic:      'ashp0/SETPOINT_hsp1',\n        measurement:'temperature',\n        payload:     waterSetPoint,\n        prefix:     'local',\n        track:       true               // update status text under node\n    });\n    ashpControl.push({ \n        topic:      'ashp0/SETPOINT_hsp2',\n        measurement:'temperature',\n        payload:     waterSetPoint,\n        prefix:     'local',\n        track:       true               // update status text under node\n    });\n\n    // push out setting information\n    notices.push( noticeOf(settings, 'setpoint'))\n    notices.push( noticeOf(settings, 'rangeLow'))\n    notices.push( noticeOf(settings, 'maxFlow'))\n    notices.push( noticeOf(settings, 'rangeHigh'))    \n\n    notices.push({ \n        topic:      'app/response/pid/log',\n        measurement: null,\n        payload:     `${utils.timeNow()} SP:${msg.setpoint} bt0:${msg.bt0} PID:${twoDecPoint(msg.payload)} L:${settings.rangeLow} F:${settings.maxFlow} H:${settings.rangeHigh} wat:${waterSetPoint}`,\n        prefix:     'local'\n    })\n    node.status({\n        fill: \"yellow\", shape: \"dot\",\n        text: `${utils.timeNow()} SETPOINT_hsp1:${waterSetPoint}`\n    })\n}\nreturn [ashpControl, notices]\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 240,
        "wires": [
            [
                "de40dbb8b3f9ae08",
                "34a804b2e0fbddd3"
            ],
            [
                "365d9ea51e2e979d",
                "097185d07f68729b"
            ]
        ]
    },
    {
        "id": "365d9ea51e2e979d",
        "type": "debug",
        "z": "ce7503bf65214c43",
        "name": "log",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 670,
        "y": 260,
        "wires": []
    },
    {
        "id": "a35c3d2647a06049",
        "type": "rate-limiter",
        "z": "ce7503bf65214c43",
        "delay_action": "ratelimit",
        "rate": "1",
        "nbRateUnits": "15",
        "rateUnits": "minute",
        "drop_select": "drop",
        "addcurrentcount": true,
        "name": "limit 1 msgs in 15 mins",
        "outputs": "2",
        "buffer_size": "0",
        "buffer_drop": "buffer_drop_new",
        "emit_msg_2nd": true,
        "control_topic": "control",
        "version": 0.0018,
        "x": 320,
        "y": 120,
        "wires": [
            [
                "e49adf55f3eac793",
                "52fa1064dec1e311"
            ],
            [
                "73f1db35034db281"
            ]
        ]
    },
    {
        "id": "e49adf55f3eac793",
        "type": "debug",
        "z": "ce7503bf65214c43",
        "name": "accepted",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 680,
        "y": 100,
        "wires": []
    },
    {
        "id": "73f1db35034db281",
        "type": "debug",
        "z": "ce7503bf65214c43",
        "name": "discarded",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 680,
        "y": 140,
        "wires": []
    },
    {
        "id": "de40dbb8b3f9ae08",
        "type": "debug",
        "z": "ce7503bf65214c43",
        "name": "to modbus",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 690,
        "y": 220,
        "wires": []
    },
    {
        "id": "a5b0229895915912",
        "type": "link in",
        "z": "ce7503bf65214c43",
        "name": "MQTT to pid legacy",
        "links": [
            "e214bc4b98b2be8f"
        ],
        "x": 135,
        "y": 400,
        "wires": [
            [
                "9b93bc23d24fa2d6"
            ]
        ]
    },
    {
        "id": "9b93bc23d24fa2d6",
        "type": "function",
        "z": "ce7503bf65214c43",
        "name": "request pid param",
        "func": "\n// PID configuration, see https://flows.nodered.org/node/node-red-contrib-pid\n\nconst lastPid = global.get('pid') ??  {}\n\nconst tokens = msg.topic.split('/')\nconst param = tokens[tokens.length - 1]\nlet m = null \nlet control = null \n\nif (tokens[1] != 'request')\n{\n  node.error(\"Ignoring topic \" + msg.topic)\n  return null ;\n}\n\nswitch(param){\n\n  case 'setpoint' :\n  case 'prop_band' :\n  case 't_integral' :  \n  case 't_derivative' :  \n  {\n    //const pid = lastPid;\n    //pid[param] = msg.payload \n    //global.set('pid',pid)\n\n    // sending response in sensor style simple format\n    \n    m = {\n      source : 'pid',\n      location : 'pid' ,\n      topic :  'pid' + '/' + param,\n      payload : msg.payload, \n      measurement : 'control',\n      prefix : 'local',\n      writeThrough : true,\n      track : true,\n    }\n\n    control = \n    {\n      topic   : param,\n      payload : msg.payload\n    }\n\n    node.status({\n      fill: \"yellow\", shape: \"dot\",\n      text: `${param} = ${msg.payload}`\n    });\n  }\n}\nreturn [control, m] ;\n\n/*\nPID params\nprocess_value\nsetpoint\nprop_band\nt_integral\nt_derivative\nmax_interval\nsmooth_factor\n\n*/",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 400,
        "wires": [
            [
                "7776a37a56cad8e0",
                "52fa1064dec1e311"
            ],
            [
                "8d6a93397d35dafe",
                "57a65d7e6a100b88"
            ]
        ]
    },
    {
        "id": "7776a37a56cad8e0",
        "type": "debug",
        "z": "ce7503bf65214c43",
        "name": "PID control",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 690,
        "y": 380,
        "wires": []
    },
    {
        "id": "8d6a93397d35dafe",
        "type": "debug",
        "z": "ce7503bf65214c43",
        "name": "response",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 680,
        "y": 420,
        "wires": []
    },
    {
        "id": "b27cee27b9d6f4b1",
        "type": "link in",
        "z": "ce7503bf65214c43",
        "name": "PID settings",
        "links": [
            "58d70b01b04781c8",
            "a2ff14d6d3cab8f1"
        ],
        "x": 135,
        "y": 180,
        "wires": [
            [
                "8c621caee9ea19f2"
            ]
        ]
    },
    {
        "id": "745b43584101b44a",
        "type": "link in",
        "z": "ce7503bf65214c43",
        "name": "link in 3",
        "links": [],
        "x": -15,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "03471048996ce664",
        "type": "link in",
        "z": "ce7503bf65214c43",
        "name": "link in 4",
        "links": [],
        "x": -15,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "c4d8aeb565e0b70e",
        "type": "link in",
        "z": "ce7503bf65214c43",
        "name": "b0",
        "links": [
            "228b073ae77b7894"
        ],
        "x": 135,
        "y": 120,
        "wires": [
            [
                "a35c3d2647a06049"
            ]
        ]
    },
    {
        "id": "34a804b2e0fbddd3",
        "type": "link out",
        "z": "ce7503bf65214c43",
        "name": "ASHP modbus",
        "mode": "link",
        "links": [
            "f61b76784c425ebd"
        ],
        "x": 635,
        "y": 180,
        "wires": []
    },
    {
        "id": "097185d07f68729b",
        "type": "link out",
        "z": "ce7503bf65214c43",
        "name": "to MQTT out",
        "mode": "link",
        "links": [],
        "x": 635,
        "y": 300,
        "wires": []
    },
    {
        "id": "010f7432531ec63f",
        "type": "comment",
        "z": "ce7503bf65214c43",
        "name": "the original and now backup PID temperature controller",
        "info": "",
        "x": 320,
        "y": 60,
        "wires": []
    },
    {
        "id": "4b601d377068ab43",
        "type": "function",
        "z": "ce7503bf65214c43",
        "name": "heat controller",
        "func": "/** \n * Calculate flow temperature. \n * This is the most important node.\n */\n\n\nconst utils  = global.get(\"utils\")\n\n/**\n* For a value of x between x1 to x2, find the value of y between y1 and y2\n* Assume x y and have a linear relationship.\n*/\n\nfunction lookup(x, x1, x2, y1, y2) {\n  // Calculate the slope (m)\n  const slope = (y2 - y1) / (x2 - x1);\n\n  // Calculate the y-intercept (b) using the point-slope form (y - y1 = m(x - x1))\n  const yIntercept = y1 - slope * x1;\n\n  // Calculate the y value for the given x\n  const y = slope * x + yIntercept;\n\n  return [utils.toFix(y,1), utils.toFix(slope,1) ]\n}\n\n\nfunction calculateFlowTemperature(prop)\n{\n  const oatBanded = Math.max(Math.min(prop.oat, prop.hrOatFull), prop.hrOatNone)\n  //node.warn(\"band \" + oatBanded);\n\n  const res = lookup(oatBanded, prop.hrOatFull, prop.hrOatNone\n                              , prop.hrFlowFull,prop.hrFlowNone);\n\n  const [wcTemp, wcSlope] = res\n\n  // use v1 algorithm and hard coded range for now \n \n  const [lcTemp, lcSlope]  = lookup(prop.pidOut, 0, 1, prop.lcLow, prop.lcHigh)\n\n  const [trim, lcSlope1]  = lookup(prop.pidOut, 0, 1, -prop.lcTrim, prop.lcTrim)\n\n  // add the weather compensation and the load compensation (needs fixing)\n\n  let flowSetPoint = prop.hrEnabled ? wcTemp + trim : lcTemp\n\n  //node.error(` load comp ${lcTemp}  flowSetPoint ${flowSetPoint} `)\n\n  flowSetPoint = utils.twoDecPoint(Math.max(Math.min(flowSetPoint, prop.flowMax), prop.flowMin))\n  \n  let heatSource = 'off' \n  if (prop.schedule)      // scheduled to run\n    if (flowSetPoint > prop.flowMin)\n      heatSource = flowSetPoint > prop.flowGas ? 'gas' : 'ashp' ;\n\n  return [ wcTemp, lcTemp, trim, flowSetPoint, heatSource ]\n}\n\n\n\nfunction doCalculation(settings, ashpControl, switchControl, notices)\n{\n  const [ weatherComp, loadComp, trim, flowSetPoint, heatSource ] = calculateFlowTemperature(settings)\n\n  const auto = settings.heatingMode == 'auto'\n\n  ashpControl.push({\n    topic:      'ashp0/SETPOINT_hsp1',\n    measurement:'temperature',\n    payload:     flowSetPoint,\n    prefix:     'local',\n    track:       true               // update status text under node\n  });\n  ashpControl.push({\n    topic:      'ashp0/SETPOINT_hsp2',\n    measurement:'temperature',\n    payload:     flowSetPoint,\n    prefix:     'local',\n    track:       true               // update status text under node\n  });\n\n  switchControl.push({\n    topic:      'switch/heatSource',\n    measurement:'state',\n    payload:     heatSource,\n    settings:    settings,          // need pump overrun time later\n    prefix:     'local',\n    track:       true               // update status text under node\n  });\n\n  const calcs = {\n    time: utils.getTimeNow(),\n    hm: settings.heatingMode,\n    oat: settings.oat,\n    wc: weatherComp,\n    b0: settings.bt,\n    sp: settings.setpoint,\n    PID: utils.twoDecPoint(settings.pidOut),\n    lcLow: settings.lcLow,  \n    lcHigh: settings.lcHigh,  \n    lc: loadComp,\n    tr: trim,\n    sch: settings.schedule,\n    hs:  heatSource,\n    min: settings.flowMin, \n    gas: settings.flowGas, \n    max: settings.flowMax, \n    wat: flowSetPoint\n  }\n\n  notices.push({\n    topic: 'log/record/pid0',\n    payload: calcs,\n    prefix: 'local'\n  })\n\n  const logText = [\n  `hm:${settings.heatingMode}`,\n  `oat:${settings.oat} wc:${weatherComp} schedule:${settings.schedule}`,\n  `b0:${settings.bt} sp:${settings.setpoint} PID:${utils.twoDecPoint(settings.pidOut)} lc:${loadComp}`,\n  `hs:${heatSource}`,\n  `min:${settings.flowMin} gas:${settings.flowGas} max:${settings.flowMax} wat:${flowSetPoint}`\n  ].join(' ')\n\n\n\n  notices.push({\n    topic:      'log/text/pid0',\n    measurement: null,\n    payload:     `${utils.getTimeNow()} v2 ${logText}`,\n    prefix:     'local'\n  })\n\n  \n  notices.push({\n    topic:      'pid0/flowSetpoint',\n    param:      'temperature',\n    payload:     flowSetPoint,\n    prefix:     'local'\n  })\n\n  node.status({\n    fill: \"yellow\", \n    shape: auto ? \"dot\" : \"ring\",\n    text: `${utils.getTimeNow()} heatSource:${heatSource} flow:${flowSetPoint}`\n  })\n}\n\n// assertions to ensure some degree of robustness\n\nif (msg.topic != 'bt')  // building temperature\n{\n  node.error(\"Will only accept msgs with 'bt' topic from heat settings\", msg);\n  return null\n}  \n\nif (msg.settingsPassingThrough === undefined)\n{\n  node.error(\"Will only accept msgs with settings\", msg);\n  return null\n}\nconst settings = msg.settingsPassingThrough\nsettings.pidOut = msg.payload\nconst ashpControl = []\nconst switchControl = []\nconst notices = []\n\n// need to check that setpoint and bt and oat are NOT null\n\ndoCalculation(settings, ashpControl, switchControl, notices)\n\n// only emit control messages if we're in auto heatingMode\nconst auto = settings.heatingMode == 'auto'\nreturn [auto ? ashpControl : null, auto ? switchControl : null, notices]\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 200,
        "y": 580,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "00c4ccd08c5fc11a",
        "type": "link in",
        "z": "81037ebb658aa24a",
        "name": "downsampled",
        "links": [
            "2384d6ea06ea6969"
        ],
        "x": 245,
        "y": 40,
        "wires": [
            [
                "a0cc013a6349a7be"
            ]
        ]
    },
    {
        "id": "bbb9fa50e55242f2",
        "type": "link out",
        "z": "81037ebb658aa24a",
        "name": "ASHP modbus",
        "mode": "link",
        "links": [
            "f61b76784c425ebd"
        ],
        "x": 675,
        "y": 540,
        "wires": []
    },
    {
        "id": "90da587f91c535d6",
        "type": "link out",
        "z": "81037ebb658aa24a",
        "name": "to MQTT out",
        "mode": "link",
        "links": [
            "1d59f94a2acc3c1a",
            "60e979b6c169619f",
            "8b087c86912319a1",
            "8b799875a8ef011e"
        ],
        "x": 675,
        "y": 180,
        "wires": []
    },
    {
        "id": "d7cca6955dfae8fe",
        "type": "function",
        "z": "81037ebb658aa24a",
        "name": "heat controller",
        "func": "/** \n * Calculate flow temperature. \n * This is the most important node.\n */\n\n\nconst utils  = global.get(\"utils\")\n\n/**\n* For a value of x between x1 to x2, find the value of y between y1 and y2\n* Assume x y and have a linear relationship.\n*/\n\nfunction lookup(x, x1, x2, y1, y2) {\n  // Calculate the slope (m)\n  const slope = (y2 - y1) / (x2 - x1);\n\n  // Calculate the y-intercept (b) using the point-slope form (y - y1 = m(x - x1))\n  const yIntercept = y1 - slope * x1;\n\n  // Calculate the y value for the given x\n  const y = slope * x + yIntercept;\n\n  return [utils.toFix(y,1), utils.toFix(slope,1) ]\n}\n\n\nfunction calculateFlowTemperature(prop)\n{\n  const oatBanded = Math.max(Math.min(prop.oat, prop.hrOatFull), prop.hrOatNone)\n  //node.warn(\"band \" + oatBanded);\n\n  const res = lookup(oatBanded, prop.hrOatFull, prop.hrOatNone\n                              , prop.hrFlowFull,prop.hrFlowNone);\n\n  const [wcTemp, wcSlope] = res\n\n  // use v1 algorithm and hard coded range for now \n \n  const [lcTemp, lcSlope]  = lookup(prop.pidOut, 0, 1, prop.lcLow, prop.lcHigh)\n\n  const [trim, lcSlope1]  = lookup(prop.pidOut, 0, 1, -prop.lcTrim, prop.lcTrim)\n\n  // add the weather compensation and the load compensation (needs fixing)\n  const wclcTemp = wcTemp + trim ;\n\n  let flowSetPoint = prop.hrEnabled ? wclcTemp : lcTemp\n\n  //node.error(` load comp ${lcTemp}  flowSetPoint ${flowSetPoint} `)\n\n  flowSetPoint = utils.twoDecPoint(Math.max(Math.min(flowSetPoint, prop.flowMax), prop.flowMin))\n  \n  let heatSource = 'off' \n  if (prop.schedule)      // scheduled to run\n    if (flowSetPoint > prop.flowMin)\n      heatSource = flowSetPoint > prop.flowGas ? 'gas' : 'ashp' ;\n\n  return [ wcTemp, lcTemp, trim, wclcTemp, flowSetPoint, heatSource ]\n}\n\n\n\nfunction doCalculation(settings, ashpControl, switchControl, notices)\n{\n  const [ weatherComp, loadComp, trim, wclcTemp, flowSetPoint, heatSource ] = calculateFlowTemperature(settings)\n\n  const auto = settings.heatingMode == 'auto'\n\n  ashpControl.push({\n    topic:      'ashp0/SETPOINT_hsp1',\n    measurement:'temperature',\n    payload:     flowSetPoint,\n    prefix:     'local',\n    track:       true               // update status text under node\n  });\n  ashpControl.push({\n    topic:      'ashp0/SETPOINT_hsp2',\n    measurement:'temperature',\n    payload:     flowSetPoint,\n    prefix:     'local',\n    track:       true               // update status text under node\n  });\n\n  switchControl.push({\n    topic:      'switch/heatSource',\n    measurement:'state',\n    payload:     heatSource,\n    settings:    settings,          // need pump overrun time later\n    prefix:     'local',\n    track:       true               // update status text under node\n  });\n\n  const calcs = {\n    time: utils.getTimeNow(),\n    hm: settings.heatingMode,\n    oat: settings.oat,\n    wc: weatherComp,\n    b0: settings.bt,\n    sp: settings.setpoint,\n    PID: utils.twoDecPoint(settings.pidOut),\n//    lcLow: settings.lcLow,  \n//    lcHigh: settings.lcHigh, \n    lc: loadComp,\n    trim: trim,   \n    wclc: wclcTemp,\n//    sch: settings.schedule,\n    hs:  heatSource,\n    min: settings.flowMin, \n    gas: settings.flowGas, \n    max: settings.flowMax, \n    wat: flowSetPoint\n  }\n\n  notices.push({\n    topic: 'log/record/pid0',\n    payload: calcs,\n    timestamp: Date.now(),\n    prefix: 'local',\n    param:  'control',   // for influx\n    //source: 'pid0'\n  })\n\n  const logText = [\n  `hm:${settings.heatingMode}`,\n  `oat:${settings.oat} wc:${weatherComp} schedule:${settings.schedule}`,\n  `b0:${settings.bt} sp:${settings.setpoint} PID:${utils.twoDecPoint(settings.pidOut)} lc:${loadComp}`,\n  `hs:${heatSource}`,\n  `min:${settings.flowMin} gas:${settings.flowGas} max:${settings.flowMax} wat:${flowSetPoint}`\n  ].join(' ')\n\n\n\n  notices.push({\n    topic:      'log/text/pid0',\n    measurement: null,\n    payload:     `${utils.getTimeNow()} v2 ${logText}`,\n    prefix:     'local'\n  })\n\n  \n  notices.push({\n    topic:      'pid0/flowSetpoint',\n    param:      'temperature',\n    payload:     flowSetPoint,\n    prefix:     'local'\n  })\n\n  node.status({\n    fill: \"yellow\", \n    shape: auto ? \"dot\" : \"ring\",\n    text: `${utils.getTimeNow()} heatSource:${heatSource} flow:${flowSetPoint}`\n  })\n}\n\n// assertions to ensure some degree of robustness\n\nif (msg.topic != 'bt')  // building temperature\n{\n  node.error(\"Will only accept msgs with 'bt' topic from heat settings\", msg);\n  return null\n}  \n\nif (msg.settingsPassingThrough === undefined)\n{\n  node.error(\"Will only accept msgs with settings\", msg);\n  return null\n}\nconst settings = msg.settingsPassingThrough\nsettings.pidOut = msg.payload\nconst ashpControl = []\nconst switchControl = []\nconst notices = []\n\n// need to check that setpoint and bt and oat are NOT null\n\ndoCalculation(settings, ashpControl, switchControl, notices)\n\n// only emit control messages if we're in auto heatingMode\nconst auto = settings.heatingMode == 'auto'\nreturn [auto ? ashpControl : null, auto ? switchControl : null, notices]\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 440,
        "wires": [
            [
                "6591f29aedfe3fc3",
                "bbb9fa50e55242f2"
            ],
            [
                "56fcefd90b4ae58c"
            ],
            [
                "ceef6f34e224aa7a",
                "3dc9495ac14b24c8"
            ]
        ]
    },
    {
        "id": "0d802e41352713c5",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "mqtt",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 240,
        "wires": []
    },
    {
        "id": "e6a9c5620bd09486",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "OAT 3",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "weather/oat",
        "payload": "3",
        "payloadType": "num",
        "x": 150,
        "y": 320,
        "wires": [
            [
                "94e8e29594123b82"
            ]
        ]
    },
    {
        "id": "445263326788ff31",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "OAT 12",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "weather/oat",
        "payload": "12",
        "payloadType": "num",
        "x": 150,
        "y": 400,
        "wires": [
            [
                "94e8e29594123b82"
            ]
        ]
    },
    {
        "id": "2ffdb1acbf50d45f",
        "type": "PID",
        "z": "81037ebb658aa24a",
        "name": "",
        "setpoint": 21,
        "pb": 1,
        "ti": 9999,
        "td": 0,
        "integral_default": 0.5,
        "smooth_factor": 3,
        "max_interval": 600,
        "enable": "1",
        "disabled_op": 0,
        "x": 370,
        "y": 340,
        "wires": [
            [
                "d7cca6955dfae8fe",
                "aaa40ac9f92ccbfc"
            ]
        ]
    },
    {
        "id": "56fcefd90b4ae58c",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "switch",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 380,
        "wires": []
    },
    {
        "id": "ffeff55564dfe352",
        "type": "function",
        "z": "81037ebb658aa24a",
        "name": "Switch off | ASHP | gas ",
        "func": "\nconst utils = global.get(\"utils\");\n\nconst switchControl = [] \nconst notices = []\n\nconst noticeOf = (key, value) => ({\n  topic:      'pid0/' + key,\n  measurement: 'state',\n  payload:     value,\n  prefix:     'local'\n})\n\nfunction changeHeatSource(desiredState, switchControl, notices) \n{\n  // override the preset LAE0 temperatures to force \n  // the controller into the required heating mode \n\n  switch(desiredState) {\n    case 'off' :   // state off, pull band low \n      switchControl.push({\n        topic: 'lae0/1SP',\n        payload: 0.5,\n      }) \n      switchControl.push({\n        topic:   'lae0/2SP',\n        payload:  0.5,        \n      })\n      break  \n\n    case 'ashp' :  // ASHP on, widen ASHP band \n      switchControl.push({\n        topic: 'lae0/1SP',\n        payload: 0.5,\n      })  \n      switchControl.push({\n        topic: 'lae0/2SP',\n        payload: 20.5,\n      }) \n      break\n\n    case 'gas' :  // GAS on, pull band high\n      switchControl.push({\n        topic: 'lae0/1SP',\n        payload: 20.5,\n      }) \n      switchControl.push({\n        topic: 'lae0/2SP',\n        payload: 20.5,\n      })\n      break \n\n    default : \n      node.error(\"Unrecognised desired state \" + desiredState);\n      switchControl.push({\n        topic: 'lae0/1SP',\n        payload: 5,\n      })\n      switchControl.push({\n        topic: 'lae0/2SP',\n        payload: 18,\n      })\n      break      \n  }\n  const stateColour = {off : 'white', ashp : 'green', gas : 'red'}\n  node.status({\n    fill: stateColour[desiredState], shape: \"dot\",\n    text: `${utils.getTimeNow()} heatSource:${desiredState}`\n  })\n  notices.push(noticeOf('heatSource', desiredState))\n}\n\nif (msg.topic != 'switch/heatSource') // good to assert correct stream\n{\n  node.error(`Received ${msg.topic}, expect only switch/heatSource`, msg);\n  return null ;\n}\n\nchangeHeatSource(msg.payload, switchControl, notices)\n\nreturn [switchControl, notices]\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 940,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "ea6dd55c20b1baa3",
        "type": "rbe",
        "z": "81037ebb658aa24a",
        "name": "changed?",
        "func": "rbe",
        "gap": "0.1",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 160,
        "y": 580,
        "wires": [
            [
                "bc0c7e318be9e3a0",
                "5f759ecd8912dbca"
            ]
        ]
    },
    {
        "id": "777a08215450b70f",
        "type": "function",
        "z": "81037ebb658aa24a",
        "name": "LAE listener - start/stop ASHP",
        "func": "\nconst utils =\n{\n  getHHMM: ((millis) => {\n    const d = new Date(millis)\n    return d.toTimeString().substring(0, 5)\n  }),\n  timeNow : (() => utils.getHHMM(Date.now()))\n}\n\nconst controlOf = (target, payload) => ({\n  topic:       target,\n  param:       'state',\n  payload:     payload\n})\n\nlet ashpControl = []\nlet gasControl = []\nlet notices = []\n\nfunction changedHeatingMode(state, ashpControl, gasControl, notices) \n{\n  // override the preset LAE0 temperatures to force \n  // the controller into the required heating mode \n  let ashpStateOn  \n  switch(state) {\n    case 0 :   // heating off \n    case 3 :   // gas on \n      ashpStateOn = false\n      break  \n\n    case 2 :   // ASHP on \n      ashpStateOn = true  \n      break  \n\n    default : \n      node.error(\"Unrecognised controller state\", state);\n  }\n  ashpControl.push(controlOf('PROTOCOL_CHIL_S_S', ashpStateOn ? 1 : 0))   \n  const stateColour   = ['black','grey','green','red']\n  const stateText   =   ['off','undefined','ashp','gas'] \n  const logText =     `LAE.OUT:${stateText[state]} [${state}]`\n  node.status({\n    fill: stateColour[state], shape: \"dot\",\n    text: `${utils.timeNow()} ${logText}`\n  })\n\n  notices.push({\n    topic:      'app/response/pid/log',\n    payload:     `${utils.timeNow()} ${logText}`, \n    prefix:      'local'\n  })\n\n}\n\n// ignore most messages from the LAE controller\nif (msg.topic == 'lae0/OUT')\n  changedHeatingMode(msg.payload, ashpControl, gasControl, notices)\nelse\n  node.debug('Ignoring topic', msg)\n\n\nreturn [ashpControl, gasControl, notices]\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 740,
        "wires": [
            [
                "bbb9fa50e55242f2",
                "95f98b4d54544416"
            ],
            [
                "80c4950e26605282"
            ],
            [
                "ceef6f34e224aa7a"
            ]
        ]
    },
    {
        "id": "854f216d34b3ed61",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 880,
        "wires": [
            [
                "bc7f5ca9b62258a3"
            ]
        ]
    },
    {
        "id": "bc7f5ca9b62258a3",
        "type": "function",
        "z": "81037ebb658aa24a",
        "name": "dump history",
        "func": "\nconst instrumentation = flow.get(\"history\") ?? {}\nlet m = {}\nm.topic = 'history'\nm.payload = instrumentation ;\nreturn m;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 880,
        "wires": [
            [
                "e6e57793c79cb473"
            ]
        ]
    },
    {
        "id": "e6e57793c79cb473",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "debug 6",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 540,
        "y": 880,
        "wires": []
    },
    {
        "id": "c1400d35bdc93f89",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "switch",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 680,
        "wires": []
    },
    {
        "id": "95f98b4d54544416",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "ashp ctrl",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 580,
        "wires": []
    },
    {
        "id": "80c4950e26605282",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "gas ctrl",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 760,
        "wires": []
    },
    {
        "id": "3a115e4d5c2be590",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "OAT 6",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "weather/oat",
        "payload": "6",
        "payloadType": "num",
        "x": 150,
        "y": 360,
        "wires": [
            [
                "94e8e29594123b82"
            ]
        ]
    },
    {
        "id": "e731444c07535ac3",
        "type": "link in",
        "z": "81037ebb658aa24a",
        "name": "LAE0",
        "links": [
            "6292886c41aee520",
            "76500cf3375b0621"
        ],
        "x": 205,
        "y": 660,
        "wires": [
            [
                "4625370b1146beb4"
            ]
        ]
    },
    {
        "id": "64ccfd798347cd78",
        "type": "function",
        "z": "81037ebb658aa24a",
        "name": "heat settings",
        "func": "/*\n\nthe primary function of this node is to store every \nsetting change and present the complete set control \nof control values to the heat 'controller' node so it can \ncalculate a new flow temperature\n\n*/\nconst utils = global.get(\"utils\");\n\nconst noticeOf = (settings, subTopic) => ({\n  topic:      'pid0/' + subTopic,\n  param:      'temperature',\n  payload:     settings[subTopic],\n  prefix:     'local'\n})\n\nconst initSettings =  {\n\n  // weather compensation.\n  // As outside temperature drops from OatFull 15C to OatNone 5C,\n  //            weatherComp rises from flowFull 25C to flowNone 40C\n\n  hrEnabled : false,\n  hrOatFull : 20,\n  hrOatNone : 3,\n  hrFlowFull : 25,\n  hrFlowNone : 45,\n\n  prop_band :    1.0,\n  t_integral :   9999, \n  t_derivative : 0, \n\n  lcLow : 32,\n  lcHigh: 50,  // must be  than min and gas or ashp not switched off huh?\n  lcTrim: 3,\n\n  flowMin : 28,\n  flowGas : 45,\n  flowMax : 48,\n\n  oat: 10,\n  bt : 19.8, \n  setpoint : 20.5,\n\n  schedule    :  false,\n  heatingMode : 'auto',\n  pumpOverrun :   1      // overrun time in minutes\n}\n\nconst heatingHelpers =   // this should be in the heat controller !\n{\n  manual : 'Heating unmanaged.\\n\\\n  Use the virtual White Box and ASHP panels left and below \\\n  to control the heating.\\n\\\n  Alternatively use the physical white box in the plant \\\n  and the touch panel on the front of the ASHP. ',\n\n  auto :   'Heating managed. ASHP/Gas is switched on/off as needed and flow\\\n  temperature is adjusted to maintain the desired building temperature during\\\n  the period that the building is occupied.',\n\n  off  :   'Override. ASHP and gas boiler off.',\n  ashp :   'Override. ASHP stays on.',\n  gas  :   'Override. Gas boiler stays on. The switch on the gas boiler must be switched on \\\n  in the plant room.'\n}\n\n/*\n *    every time we process an incoming message\n *    just push out notices indicating what's going on\n */\n\nfunction handleIncomingMessage(msg, contextName, settings, notices)\n{\n  const tokens = msg.topic.split(/[\\/]/)\n  let subTopic = tokens.at(-1)\n  let logText = null \n  let updateSetting = false \n\n  switch (msg.topic) {\n\n    case 'pid0/set/reset':\n      settings = initSettings;\n      updateSetting = true ;\n      context.set(contextName, settings);\n      logText = `${utils.getTimeNow()} reset settings`\n      /// this is very inelegant\n      return null ;\n\n    case 'pid0/get/all':\n    case 'recall':\n      for (const key in initSettings)\n        notices.push(noticeOf(settings, key))\n      logText = `${utils.getTimeNow()} recall`\n      break\n\n    case 'pid0/set/heatingMode' :\n      const help = heatingHelpers[msg.payload] ?? 'Missing help'\n      // create a properties object with one property of heatingModeHelp\n      notices.push(noticeOf({ heatingModeHelp : help }, 'heatingModeHelp'))\n      updateSetting = true \n      break\n\n    case 'schedule' :  // 0 or 1 \n      updateSetting = true\n      break ;       \n\n    case 'b0/temperature' :\n      subTopic = 'bt'    \n      // this is building temperature\n      // intentional dropthrough \n\n    default : \n      updateSetting = true \n      break   \n\n  }\n  if (updateSetting)\n  {\n    if (subTopic in initSettings)\n    {\n      if (typeof msg.payload === \"number\") \n        settings[subTopic] = utils.twoDecPoint(parseFloat(msg.payload));\n      else \n        settings[subTopic] = msg.payload;\n\n      // drag flow min/max around so no control conflict\n      switch(subTopic) {\n        case 'flowMin' :\n          if (settings.flowMax < settings.flowMin) \n          {\n            settings.flowMax = settings.flowMin ; \n            notices.push(noticeOf(settings, 'flowMax'))            \n          }\n          break \n        case 'flowMax':\n          if (settings.flowMin > settings.flowMax) \n          {\n            settings.flowMin = settings.flowMax ; \n            notices.push(noticeOf(settings, 'flowMin'))            \n          }\n          break \n      }\n\n      context.set(contextName, settings, 'file');\n      notices.push(noticeOf(settings, subTopic))\n      logText = `${utils.getTimeNow()} ${subTopic}:${settings[subTopic]}`\n    }\n    else {\n      logText = `${utils.getTimeNow()} No handler for topic:${msg.topic} and not a known setting`\n      node.error(logText)          \n    }\n  }\n  if (logText)\n  {\n    notices.push({\n      topic:      'log/text/pid0',\n      payload:     logText,\n      prefix:     'local'\n    })\n\n    node.status({\n      fill: \"blue\", shape: \"dot\",\n      text:  logText\n    })\n  }\n}\n\n\n\nconst contextName = 'pidv2'\nconst settings = Object.assign(initSettings, context.get(contextName, 'file') ?? {})\n\nconst notices = []\n\nhandleIncomingMessage(msg, contextName, settings, notices)\n\nconst msgPID = \n{ \n  topic : 'bt', \n  payload : settings.bt,    // PV - process value\n  setpoint : settings.setpoint, \n  prop_band : settings.prop_band, \n  settingsPassingThrough : settings\n}\nreturn [msgPID, notices]\n\n\n/*\nAvailable PID params:\n  process_value\n  setpoint\n  prop_band\n  t_integral\n  t_derivative\n  max_interval\n  smooth_factor\n*/",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 240,
        "wires": [
            [
                "3af8583518a00155",
                "2ffdb1acbf50d45f"
            ],
            [
                "ceef6f34e224aa7a"
            ]
        ]
    },
    {
        "id": "3af8583518a00155",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "settings",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 300,
        "wires": []
    },
    {
        "id": "ca76adbed905d7a1",
        "type": "comment",
        "z": "81037ebb658aa24a",
        "name": "Test buttons",
        "info": "",
        "x": 150,
        "y": 620,
        "wires": []
    },
    {
        "id": "f2708111c0193421",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "bt 20.1",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "b0/temperature",
        "payload": "20.1",
        "payloadType": "num",
        "x": 150,
        "y": 240,
        "wires": [
            [
                "94e8e29594123b82"
            ]
        ]
    },
    {
        "id": "aaa40ac9f92ccbfc",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "pid out",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 460,
        "wires": []
    },
    {
        "id": "a0cc013a6349a7be",
        "type": "function",
        "z": "81037ebb658aa24a",
        "name": "roof °C (oat)",
        "func": "if (msg.topic == 'lae0/PRO')\n{\n  const utils = global.get('utils')\n  msg.topic = 'weather/oat'\n  msg.source = 'lae0'\n\n  const logText = `${utils.getTimeNow()} ${msg.topic}:${msg.payload}`\n\n  node.status({\n    fill: \"blue\", shape: \"dot\",\n    text:  logText\n  })\n  return msg \n}\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 40,
        "wires": [
            [
                "cf9f8a576daa4234"
            ]
        ]
    },
    {
        "id": "78cd29908a48f8e6",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "recall",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "pid0/set/recall",
        "payload": "",
        "payloadType": "num",
        "x": 150,
        "y": 440,
        "wires": [
            [
                "94e8e29594123b82"
            ]
        ]
    },
    {
        "id": "52fa1182d5cd2dff",
        "type": "link in",
        "z": "81037ebb658aa24a",
        "name": "pid0",
        "links": [
            "d85bfa6a0e81301d",
            "e70ba65277e5fe4f"
        ],
        "x": 245,
        "y": 160,
        "wires": [
            [
                "5b3cfcf45023a7d1"
            ]
        ]
    },
    {
        "id": "dd391a5738117344",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "bt 19.8",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "b0/temperature",
        "payload": "19.8",
        "payloadType": "num",
        "x": 150,
        "y": 280,
        "wires": [
            [
                "94e8e29594123b82"
            ]
        ]
    },
    {
        "id": "bc0c7e318be9e3a0",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "debug 24",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 380,
        "y": 520,
        "wires": []
    },
    {
        "id": "3dc9495ac14b24c8",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "log2",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 420,
        "wires": []
    },
    {
        "id": "c4ec4ac0cef1582e",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "reset setttings",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "pid0/set/reset",
        "payload": "",
        "payloadType": "str",
        "x": 130,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "5f759ecd8912dbca",
        "type": "function",
        "z": "81037ebb658aa24a",
        "name": "heatSource",
        "func": "\n\nconst utils = global.get(\"utils\");\n\nconst controlOf = (target, payload, delay = 1) => ({\n  topic:       target,\n  param:      'state',\n  payload:     payload,\n  delay:       delay\n})\n\nlet ashpControl = []\nlet switchControl = []\nlet notices = []\n\nfunction changeHeatSource(currentHeatSource, heatSource, ashpControl, switchControl,  notices) \n{\n  // override the preset LAE0 temperatures to force \n  // the controller into the required heating mode \n\n  let pumpOverrun = false \n\n  switch(heatSource) {\n    case 'off' :   // heating off, low band \n      if (currentHeatSource == 'off')\n        break \n\n      ashpControl.push(controlOf('PROTOCOL_CHIL_S_S', 0)) \n      pumpOverrun =  (currentHeatSource == 'ashp');\n      const delay = (pumpOverrun ? 60 : 1) * 1000  ;\n      switchControl.push({\n        topic: 'lae0/1SP',\n        payload: 0.5,\n        delay: delay\n      })  \n      switchControl.push({\n        topic: 'lae0/2SP',\n        payload: 1.5,\n        delay: delay\n      })\n      break ;\n\n    case 'ashp':   // ASHP on, wide band \n      if (currentHeatSource == 'ashp')\n        break \n\n      ashpControl.push(controlOf('PROTOCOL_CHIL_S_S', 1)) \n      switchControl.push({\n        topic: 'lae0/1SP',\n        payload: 0.5,\n      })  \n      switchControl.push({\n        topic: 'lae0/2SP',\n        payload: 18.5,\n      }) \n      break  \n\n    case 'gas' :   // gas on, high band \n      if (currentHeatSource == 'gas')\n        break\n        \n      ashpControl.push(controlOf('PROTOCOL_CHIL_S_S', 0))   \n      switchControl.push({\n        topic: 'lae0/1SP',\n        payload: 17.5,\n      }) \n      switchControl.push({\n        topic: 'lae0/2SP',\n        payload: 18.5,\n      })        \n      break  \n\n\n    default : \n      node.error(\"Unrecognised heat source\", heatSource);\n      switchControl.push({\n        topic: 'lae0/1SP',\n        payload: 5,\n      })\n      switchControl.push({\n        topic: 'lae0/2SP',\n        payload: 18,\n      })\n      return null ;\n  }\n\n  const heatSourceColour = { off: 'yellow', ashp: 'green', gas: 'red'}\n  const logText  = `${currentHeatSource}->${heatSource} pumpOverrun:${pumpOverrun}`\n  node.status({\n    fill: heatSourceColour[heatSource], shape: \"dot\",\n    text: `${utils.getTimeNow()} ${logText}`\n  })\n\n  notices.push({\n    topic:      'app/response/pid/log',\n    payload:     `${utils.getTimeNow()} ${logText}`, \n    prefix:      'local'\n  })\n}\n\nif (msg.topic != 'switch/heatSource')\n{\n  node.error(`Received ${msg.topic}, expect only switch/heatSource`, msg);\n  return null ;\n}\n\nconst currentHeatSource = context.get('heatSource') ?? 'off' \nconst futureHeatSource = msg.payload ;\nconst pumpOverrun = changeHeatSource(currentHeatSource, futureHeatSource, ashpControl, switchControl,  notices)\ncontext.set('heatSource', futureHeatSource)\n\nreturn [ashpControl, switchControl,  notices]\n\n\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 580,
        "wires": [
            [
                "95f98b4d54544416"
            ],
            [
                "6bae65488d626181"
            ],
            [
                "ceef6f34e224aa7a"
            ]
        ],
        "outputLabels": [
            "ashpControl",
            "switchControl",
            "notices"
        ]
    },
    {
        "id": "6bae65488d626181",
        "type": "delay",
        "z": "81037ebb658aa24a",
        "name": "pump overrun",
        "pauseType": "delayv",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 400,
        "y": 640,
        "wires": [
            [
                "c1400d35bdc93f89"
            ]
        ]
    },
    {
        "id": "b2f85d21f610bcde",
        "type": "delay-topic-message",
        "z": "81037ebb658aa24a",
        "delay": "1",
        "x": 120,
        "y": 940,
        "wires": [
            []
        ],
        "inputLabels": [
            "abce"
        ],
        "outputLabels": [
            "defee"
        ],
        "icon": "node-red/file-out.svg"
    },
    {
        "id": "a1813311ef8ad85c",
        "type": "link in",
        "z": "81037ebb658aa24a",
        "name": "b0",
        "links": [
            "228b073ae77b7894"
        ],
        "x": 245,
        "y": 100,
        "wires": [
            [
                "3a3a00295495a1a7"
            ]
        ]
    },
    {
        "id": "6591f29aedfe3fc3",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "ashp temp",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 730,
        "y": 340,
        "wires": []
    },
    {
        "id": "16fe20a05e4f8866",
        "type": "link out",
        "z": "81037ebb658aa24a",
        "name": "LAE0",
        "mode": "link",
        "links": [
            "067d0e710c60a2bf"
        ],
        "x": 675,
        "y": 640,
        "wires": []
    },
    {
        "id": "39b1b4254d4373f9",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "lae",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 800,
        "wires": []
    },
    {
        "id": "4625370b1146beb4",
        "type": "switch",
        "z": "81037ebb658aa24a",
        "name": "filter OUTput",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "lae0/OUT",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 190,
        "y": 740,
        "wires": [
            [
                "777a08215450b70f",
                "39b1b4254d4373f9"
            ]
        ]
    },
    {
        "id": "05d692cc4920b7ed",
        "type": "inject",
        "z": "81037ebb658aa24a",
        "name": "ashp em stop",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "PROTOCOL_CHIL_S_S",
        "payload": "0",
        "payloadType": "num",
        "x": 130,
        "y": 840,
        "wires": [
            [
                "95f98b4d54544416",
                "bbb9fa50e55242f2"
            ]
        ]
    },
    {
        "id": "5b3cfcf45023a7d1",
        "type": "delay-topic-message",
        "z": "81037ebb658aa24a",
        "delay": "3",
        "x": 380,
        "y": 160,
        "wires": [
            [
                "7abf789ae18304f4"
            ]
        ]
    },
    {
        "id": "11b681f44301912a",
        "type": "comment",
        "z": "81037ebb658aa24a",
        "name": "delay and drop intermediate messages",
        "info": "",
        "x": 710,
        "y": 100,
        "wires": []
    },
    {
        "id": "03c2800c0d0d2ece",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "debug 42",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 140,
        "wires": []
    },
    {
        "id": "bc15fab6318b655e",
        "type": "debug",
        "z": "81037ebb658aa24a",
        "name": "b0 and oat",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 690,
        "y": 60,
        "wires": []
    },
    {
        "id": "3a3a00295495a1a7",
        "type": "subflow:9e36a25803eb28ab",
        "z": "81037ebb658aa24a",
        "name": "",
        "x": 390,
        "y": 100,
        "wires": [
            [
                "cf9f8a576daa4234"
            ],
            [],
            []
        ]
    },
    {
        "id": "f3e66e93b7f47329",
        "type": "comment",
        "z": "81037ebb658aa24a",
        "name": "todo suppress start temps",
        "info": "",
        "x": 150,
        "y": 140,
        "wires": []
    },
    {
        "id": "f2e5754610a2a6d1",
        "type": "link in",
        "z": "3187bd06ef664359",
        "name": "instrument data in",
        "links": [
            "4155f40899b57319"
        ],
        "x": 165,
        "y": 1940,
        "wires": [
            [
                "aa3572b743cf326b",
                "0021c59646b5c822",
                "ce189e38ee1ada7b",
                "4cfbb5d77596f936",
                "7f820c0f9477eb3f"
            ]
        ]
    },
    {
        "id": "87d4e3e4d7a5bb49",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "8fddc7545b8b993d",
        "name": "hrOatNone",
        "label": "not initialised",
        "tooltip": "",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": 10,
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 410,
        "y": 540,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "9bfc50e58ff45907",
        "type": "switch",
        "z": "3187bd06ef664359",
        "name": "gaugeSelect",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "lae0\\/OUT",
                "vt": "str",
                "case": true
            },
            {
                "t": "regex",
                "v": "lae0\\/1SP",
                "vt": "str",
                "case": true
            },
            {
                "t": "regex",
                "v": "lae0\\/2SP",
                "vt": "str",
                "case": true
            },
            {
                "t": "regex",
                "v": "lae0\\/PRO",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "weather\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "b0\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "g3\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "g4\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "g5\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "g6\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "g7\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m0\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m1\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m2\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m3\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m4\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m5\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m6\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m7\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m8\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m9\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m10\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "m11\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "t1\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "t2\\/temperature",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "t3\\/temperature",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 26,
        "x": 150,
        "y": 2720,
        "wires": [
            [
                "91a5b7441a976c4e"
            ],
            [
                "4207b681f59bdf56"
            ],
            [
                "e97b86492bdb03f2"
            ],
            [
                "7ab71584ce4a9f44"
            ],
            [],
            [
                "5cd1501fac9ece1d",
                "282ccfeaa0f9be7b"
            ],
            [
                "70ca036b587e52a8"
            ],
            [
                "231e852c483bc851"
            ],
            [
                "cb658eb45e85b015"
            ],
            [
                "4b56f87da70fd77b"
            ],
            [
                "de393f690aea796e"
            ],
            [
                "c065eb1d1cca671f"
            ],
            [
                "3127d528dd75bd35"
            ],
            [
                "5bfabbc178cd919f"
            ],
            [
                "5f2d33b187e1b568"
            ],
            [
                "d153945fee2b6686"
            ],
            [
                "c119ee29af718b7e"
            ],
            [
                "6ada43ce673cf3aa"
            ],
            [
                "dcd454138c70c4e9"
            ],
            [
                "f6edae950b7faac8"
            ],
            [
                "ca1924da970f8082"
            ],
            [
                "a685643a59b90cc0"
            ],
            [
                "39bde304ed848b72"
            ],
            [
                "88576d1c5452f48e"
            ],
            [
                "c3b17e516e580d04"
            ],
            [
                "d7d81ebe6a304f2b"
            ]
        ]
    },
    {
        "id": "aa3572b743cf326b",
        "type": "function",
        "z": "3187bd06ef664359",
        "name": "ui_update sensors",
        "func": "\n\nconst indoorGauge = {\n  measurement : 'tba',\n  min : 17, \n  max : 24,\n  units : \"°C\",\n  sectors: [\n    { \"start\": 0, \"color\": \"blue\"}, \n    { \"start\": 20, \"color\": \"yellow\"},\n    { \"start\": 21, \"color\": \"green\"}, \n    { \"start\": 22, \"color\": \"red\"}\n  ]\n}\n\n//node.error(\"my error message \" + msg.topic, msg);\n\n\nswitch(msg.topic) \n{\n  case 'lae0/1SP' :\n    msg.ui_update = {\n      label: 'Use gas below (SP1)',\n      color : 'red',\n      colorTrack : 'grey',    \n      min : 0,\n      max : 24,\n      thumbNail : 'always'\n    }\n    break ; \n\n  case 'lae0/2SP' :\n    msg.ui_update = {\n      label: 'Use heat below (SP2)',\n      color : 'green',\n      colorTrack : 'grey',    \n      min : 0,\n      max : 24,\n      thumbNail : 'always'\n    }\n    break ;  \n\n  case 'lae0/OUT' :\n    msg.state = msg.payload \n    msg.payload = (msg.payload != 0)\n    const statusText =   ['Off', 'Ambiguous setting SP1 > SP2 !! ', 'Using ASHP',  'Using Gas' ]\n    const statusColour = ['grey','purple','green', 'red']\n    msg.ui_update = {\n//      options : [statusText[msg.state]],\n      oncolor : statusColour[msg.state],\n      label   : statusText[msg.state]\n    }\n    //node.error(' out ' + msg.topic)\n    break \n\n\n  case 'lae0/PRO':  // roof temp \n    msg.ui_update = {\n      label: 'Outdoors',\n      measurement: 'Roof', // + \" \" + msg.source, \n      min: 0,\n      max: 25,\n      units: \"°C\",\n      sectors: [\n        { \"start\": 0, \"color\":  \"darkblue\"}, \n        { \"start\": 5, \"color\":  \"lightblue\"}, \n        { \"start\": 18, \"color\": \"lightgreen\"}, \n        { \"start\": 42, \"color\": \"red\"}\n      ]\n    }\n    break\n\n  case 'b0/temperature' :\n    msg.ui_update = indoorGauge\n    msg.ui_update.measurement = 'b0'\n    msg.ui_update.label = 'Indoors'\n    break \n\n  default :  // used by all the room/zone sensors\n    msg.ui_update = indoorGauge\n    msg.ui_update.label = msg.location // + \" \" + msg.source, \n    msg.ui_update.measurement = msg.source  // + \" \" + msg.source, \n    break\n}\nif (msg.hasTimedOut)\n{\n  msg.ui_update.sectors = [{ \"start\": 0, \"color\":  \"orange\"}]\n  msg.ui_update.measurement = msg.source + \" Timed Out\"\n}\n//msg.ui_update.sectors = [{ \"start\": 0, \"color\":  \"orange\"}]\n//msg.ui_update.prefix = 'ha ha'\n//msg.ui_update.suffix = 'OK'\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 2340,
        "wires": [
            [
                "9bfc50e58ff45907"
            ]
        ]
    },
    {
        "id": "83827d5e60899807",
        "type": "function",
        "z": "3187bd06ef664359",
        "name": "ui update PID",
        "func": "\nconst tokens = msg.topic.split('/')\nconst label = tokens[tokens.length - 1]\n\n//node.error(\"label: \"  + label, msg);\n\nconst defaultGauge = {\n  style : 'Rounded',\n  class : label, \n  label : label,  // the subtopic\n  min : 25, \n  step : 1,\n  max : 50,\n  units : \"°C\",\n  color : 'red',\n  colorTrack : 'grey',\n  \n  oncolor : 'red',\n  showTicks : 'always',\n  thumbLabel : 'always'\n}\n\nconst outsideWeatherGauge = {\n  min : 0,\n  max : 20,\n  step : 1,\n  color : 'lightblue',\n  colorTrack : 'grey',\n}\n\nmsg.ui_update = defaultGauge ;\n\n//node.error(\"my error message \" + msg.payload, msg);\n\nswitch(msg.topic)\n{\n  case 'pid0/heatingMode' :\n    context.set('heatingMode', msg.payload)\n  case 'pid0/heatingModeHelp' :\n    msg.ui_update.label = ''\n    break ; \n\n  case 'pid0/flowMin' :\n    msg.ui_update.label = 'Min'\n    msg.ui_update.color = 'lightblue'\n    break ;\n\n  case 'pid0/flowMax' :\n    msg.ui_update.label = 'Max'\n    msg.ui_update.color = 'red'\n    break ;\n    \n  case 'pid0/flowGas' :\n    msg.ui_update.label = 'Crossover to Gas above'\n    msg.ui_update.color = 'purple'\n    msg.ui_update.min = 42\n    msg.ui_update.max = 50\n    msg.ui_update.step = 1     \n    break ;\n\n  case 'pid0/lcLow' :\n    msg.ui_update.label = 'Low'\n    msg.ui_update.color = 'lightblue'\n    break ;\n\n  case 'pid0/lcHigh' :\n    msg.ui_update.label = 'High'\n    msg.ui_update.color = 'red'\n    break ;\n\n  case 'pid0/lcTrim' :\n    msg.ui_update.min = 0\n    msg.ui_update.max = 10\n    break ;\n\n  case 'pid0/setpoint' :\n    msg.ui_update.min = 20\n    msg.ui_update.max = 22\n    msg.ui_update.step = 0.1\n    msg.ui_update.label = 'Desired building temperature'\n    break ;\n\n  case 'pid0/flowSetpoint' :\n    msg.ui_update.min = 25\n    msg.ui_update.max = 52\n    msg.ui_update.step = 1\n    msg.ui_update.label = 'Flow setpoint'\n    const mode = context.get('heatingMode')\n    const color = mode == 'auto' ?  'red' : 'grey' \n    msg.ui_update.color = color \n    break ;\n\n  case 'pid0/hrOatNone' :\n  case 'pid0/hrOatFull' :\n    msg.ui_update = Object.assign(defaultGauge, outsideWeatherGauge) \n    break \n\n  case 'pid0/hrEnabled' :\n    msg.ui_update.label = 'Enabled'\n    break   \n\n  case 'pid0/prop_band' :\n    msg.ui_update.label = 'Proportional band' ;\n    msg.ui_update.min = 0 ;\n    msg.ui_update.max = 1 ;\n    msg.ui_update.step = 0.1 ;\n    break ;\n\n  case 'pid0/t_integral' :\n    msg.ui_update.label = 'Integral' ;\n    msg.ui_update.min = 0 ;\n    msg.ui_update.max = 1000 ;\n    msg.ui_update.step = 100 ;\n    break ;\n\n  case 'pid0/t_derivative' :\n    msg.ui_update.label = 'Derivative'; \n    msg.ui_update.min = 0 ;\n    msg.ui_update.max = 1 ;\n    msg.ui_update.step = 0.1 ;\n    break ;\n\n\n}\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 160,
        "wires": [
            [
                "4eb69a7cf8aca82f",
                "1c45ecd7fdc8802c"
            ]
        ]
    },
    {
        "id": "60e979b6c169619f",
        "type": "link in",
        "z": "3187bd06ef664359",
        "name": "pid setter",
        "links": [
            "90da587f91c535d6"
        ],
        "x": 145,
        "y": 160,
        "wires": [
            [
                "83827d5e60899807"
            ]
        ]
    },
    {
        "id": "e50d85f8f2cafbf0",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "8fddc7545b8b993d",
        "name": "hrOatFull",
        "label": "not initialised",
        "tooltip": "",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": 10,
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 400,
        "y": 580,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "5f41ef31211919be",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "8fddc7545b8b993d",
        "name": "hrFlowFull",
        "label": "not initialised",
        "tooltip": "",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": 10,
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 410,
        "y": 660,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "9fc4240a4f268cb2",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "8fddc7545b8b993d",
        "name": "hrFlowNone",
        "label": "not initialised",
        "tooltip": "",
        "order": 4,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": 10,
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 410,
        "y": 620,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "c56e82e85ac376ec",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "5e46a3149640b893",
        "name": "flowMin",
        "label": "not initialised",
        "tooltip": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": "50",
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "gray",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 700,
        "y": 360,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "3b95b6c9a9191042",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "5e46a3149640b893",
        "name": "flowGas",
        "label": "not initialised",
        "tooltip": "",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": "50",
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 700,
        "y": 400,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "d9b0d3a91aafa6ce",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "5e46a3149640b893",
        "name": "flowMax",
        "label": "not initialised",
        "tooltip": "",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": "50",
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 700,
        "y": 440,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "5076fa64105af556",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "7d2a07e2b30dad87",
        "name": "building setpoint",
        "label": "not initialised",
        "tooltip": "",
        "order": 3,
        "width": 6,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": "0",
        "max": "50",
        "step": "10",
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "red",
        "colorTrack": "green",
        "colorThumb": "",
        "showTextField": false,
        "x": 700,
        "y": 220,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "192c56bf8a9c83e8",
        "type": "ui-control",
        "z": "3187bd06ef664359",
        "name": "events",
        "ui": "e41c774eeb2b3037",
        "events": "all",
        "x": 390,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "8a81b4dda778a32a",
        "type": "ui-button-group",
        "z": "3187bd06ef664359",
        "name": "heatingMode",
        "group": "7d2a07e2b30dad87",
        "order": 1,
        "width": 6,
        "height": 1,
        "label": "Heating Mode",
        "className": "",
        "rounded": true,
        "useThemeColors": true,
        "passthru": false,
        "options": [
            {
                "label": "Manual",
                "icon": "",
                "value": "manual",
                "valueType": "str",
                "color": "#cccc00"
            },
            {
                "label": "Auto",
                "icon": "",
                "value": "auto",
                "valueType": "str",
                "color": "#009999"
            },
            {
                "label": "Off",
                "icon": "",
                "value": "off",
                "valueType": "str",
                "color": "#009933"
            },
            {
                "label": "ASHP",
                "icon": "",
                "value": "ashp",
                "valueType": "str",
                "color": "#999999"
            },
            {
                "label": "Gas",
                "icon": "",
                "value": "gas",
                "valueType": "str",
                "color": "#ff6666"
            }
        ],
        "topic": "topic",
        "topicType": "msg",
        "x": 710,
        "y": 160,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "cc857205d763da06",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "eca65edcc34b5a40",
        "name": "lcHigh",
        "label": "not initialised",
        "tooltip": "",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": 10,
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 390,
        "y": 460,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "4eb69a7cf8aca82f",
        "type": "switch",
        "z": "3187bd06ef664359",
        "name": "PID",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "heatingModeHelp",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "heatingMode",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "setpoint",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "flowSetpoint",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "flowMin",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "flowGas",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "flowMax",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "lcLow",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "lcHigh",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "hrEnabled",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "hrOatNone",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "hrOatFull",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "hrFlowNone",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "hrFlowFull",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "lcTrim",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "prop_band",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "t_integral",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "t_derivative",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "PUMPCONF_w_dt_spt",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "log",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 20,
        "x": 130,
        "y": 360,
        "wires": [
            [
                "50d49369fff140db"
            ],
            [
                "8a81b4dda778a32a"
            ],
            [
                "5076fa64105af556"
            ],
            [
                "9cf7b39ffeb526ce",
                "7ef60c8d3ef9f629"
            ],
            [
                "c56e82e85ac376ec"
            ],
            [
                "3b95b6c9a9191042"
            ],
            [
                "d9b0d3a91aafa6ce"
            ],
            [
                "9d5ed6d1e0aa40f4"
            ],
            [
                "cc857205d763da06"
            ],
            [
                "9a8aa58508996f67"
            ],
            [
                "87d4e3e4d7a5bb49"
            ],
            [
                "e50d85f8f2cafbf0"
            ],
            [
                "9fc4240a4f268cb2"
            ],
            [
                "5f41ef31211919be"
            ],
            [
                "0da7a18550db5f18"
            ],
            [
                "d7a729c9b54aef0b"
            ],
            [
                "043245fa94d8d05e"
            ],
            [
                "4ebaa0361f52d24b"
            ],
            [],
            [
                "b442feb9dc937420"
            ]
        ]
    },
    {
        "id": "5cd1501fac9ece1d",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "b0",
        "group": "318d4c5818f432d1",
        "order": 1,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 550,
        "y": 2560,
        "wires": []
    },
    {
        "id": "70ca036b587e52a8",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "g3",
        "group": "ddb86a924c9cd18d",
        "order": 1,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 550,
        "y": 2600,
        "wires": []
    },
    {
        "id": "231e852c483bc851",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "g4",
        "group": "ddb86a924c9cd18d",
        "order": 2,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 550,
        "y": 2640,
        "wires": []
    },
    {
        "id": "cb658eb45e85b015",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "g5",
        "group": "ddb86a924c9cd18d",
        "order": 3,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 550,
        "y": 2680,
        "wires": []
    },
    {
        "id": "4b56f87da70fd77b",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "g6",
        "group": "ddb86a924c9cd18d",
        "order": 4,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 550,
        "y": 2720,
        "wires": []
    },
    {
        "id": "c065eb1d1cca671f",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m0",
        "group": "318d4c5818f432d1",
        "order": 2,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2500,
        "wires": []
    },
    {
        "id": "5f2d33b187e1b568",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m3",
        "group": "318d4c5818f432d1",
        "order": 5,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2620,
        "wires": []
    },
    {
        "id": "39bde304ed848b72",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m11",
        "group": "318d4c5818f432d1",
        "order": 13,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2940,
        "wires": []
    },
    {
        "id": "de393f690aea796e",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "g7",
        "group": "ddb86a924c9cd18d",
        "order": 5,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 550,
        "y": 2760,
        "wires": []
    },
    {
        "id": "2386c4ee327379c4",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "t0",
        "group": "6bb44fe3ca0ba894",
        "order": 1,
        "width": "2",
        "height": "2",
        "min": 0,
        "max": 10,
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "black",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 550,
        "y": 2840,
        "wires": []
    },
    {
        "id": "88576d1c5452f48e",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "t1",
        "group": "6bb44fe3ca0ba894",
        "order": 2,
        "width": "2",
        "height": "2",
        "min": 0,
        "max": 10,
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "black",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 550,
        "y": 2880,
        "wires": []
    },
    {
        "id": "c3b17e516e580d04",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "t2",
        "group": "6bb44fe3ca0ba894",
        "order": 4,
        "width": "2",
        "height": "2",
        "min": 0,
        "max": 10,
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "black",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 550,
        "y": 2920,
        "wires": []
    },
    {
        "id": "d7d81ebe6a304f2b",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "t3",
        "group": "6bb44fe3ca0ba894",
        "order": 3,
        "width": "2",
        "height": "2",
        "min": 0,
        "max": 10,
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "black",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 550,
        "y": 2960,
        "wires": []
    },
    {
        "id": "5bfabbc178cd919f",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m2",
        "group": "318d4c5818f432d1",
        "order": 4,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2580,
        "wires": []
    },
    {
        "id": "3127d528dd75bd35",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m1",
        "group": "318d4c5818f432d1",
        "order": 3,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2540,
        "wires": []
    },
    {
        "id": "d153945fee2b6686",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m4",
        "group": "318d4c5818f432d1",
        "order": 6,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2660,
        "wires": []
    },
    {
        "id": "c119ee29af718b7e",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m5",
        "group": "318d4c5818f432d1",
        "order": 7,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2700,
        "wires": []
    },
    {
        "id": "f6edae950b7faac8",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m8",
        "group": "318d4c5818f432d1",
        "order": 10,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2820,
        "wires": []
    },
    {
        "id": "dcd454138c70c4e9",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m7",
        "group": "318d4c5818f432d1",
        "order": 9,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2780,
        "wires": []
    },
    {
        "id": "6ada43ce673cf3aa",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m6",
        "group": "318d4c5818f432d1",
        "order": 8,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2740,
        "wires": []
    },
    {
        "id": "ca1924da970f8082",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m9",
        "group": "318d4c5818f432d1",
        "order": 11,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2860,
        "wires": []
    },
    {
        "id": "a685643a59b90cc0",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "m10",
        "group": "318d4c5818f432d1",
        "order": 12,
        "width": "2",
        "height": "2",
        "min": "15",
        "max": "25",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "temperature",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": "250",
        "myclass": "",
        "x": 710,
        "y": 2900,
        "wires": []
    },
    {
        "id": "282ccfeaa0f9be7b",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "Indoors",
        "group": "a89236c6fd618d45",
        "order": 2,
        "width": "2",
        "height": "2",
        "min": "18",
        "max": "22",
        "sectors": [],
        "major_division": 1,
        "minor_division": 0.2,
        "value_decimal_places": "2",
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "not initialised",
        "units": "°C",
        "needles": [
            {
                "topic": "b0/temperature",
                "color": "red",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 580,
        "y": 2340,
        "wires": []
    },
    {
        "id": "0021c59646b5c822",
        "type": "function",
        "z": "3187bd06ef664359",
        "name": "ui update ASHP",
        "func": "// set source, location and topic \n// should this be done by common routine\n\nlet tokens = msg.topic.split('/') \nconst source = tokens[0]\nconst subtopic = tokens[1]\n\nif (source != 'ashp0')\n  return null \n\nif (msg.track)\n  node.status({ fill: 'green', shape: \"dot\", text:`source:${source} subtopic:${subtopic}`})\n\nswitch (msg.topic)\n{\n  case 'ashp0/UNIT_STATUS' :\n    msg.state = msg.payload \n    msg.payload = (msg.payload != 0)\n    const statusText =   ['Off','Running','Stopping', 'Delay','4 ish','Ready','6 ish','Defrost' ]\n    const statusColour = ['grey','red',   'yellow',   'orange','blue','green','yellow','lightblue' ]\n    msg.ui_update = {\n      label :   'ASHP ' + statusText[msg.state],\n      oncolor : statusColour[msg.state],\n      offcolor : statusColour[msg.state]\n    }\n    break ;\n    \n  case 'ashp0/GENUNIT_CTRL_PNT' :\n    msg.ui_update = {\n      //label : 'xxx', \n      min : 25, \n      max : 52,\n      step : 1,\n      units : \"°C\",\n\n      sectors: [\n        { \"start\": 0, \"color\":  \"darkblue\"}, \n        { \"start\": 5, \"color\":  \"lightblue\"}, \n        { \"start\": 18, \"color\": \"lightgreen\"}, \n        { \"start\": 42, \"color\": \"red\"}\n      ]\n    } \n    break \n\n  case 'ashp0/TEMP_LWT' :\n  case 'ashp0/TEMP_EWT' :\n    msg.ui_update = {\n      //label : 'xxx', \n      min : 0, \n      max : 52,\n      step : 5,\n      units : \"°C\",\n\n      sectors: [\n        { \"start\": 0, \"color\":  \"darkblue\"}, \n        { \"start\": 5, \"color\":  \"lightblue\"}, \n        { \"start\": 18, \"color\": \"lightgreen\"}, \n        { \"start\": 42, \"color\": \"red\"}\n      ]\n    } \n    break \n  case 'ashp0/PUMPSTAT_CAPPOWER' :\n    msg.ui_update = {\n      //label : 'xxx', \n      measurement : 'Output power',\n      min : 0, \n      max : 50,\n      step : 5,\n      units : \"kw\",\n\n      sectors: [\n        { \"start\": 0, \"color\":  \"grey\"}, \n        { \"start\": 20, \"color\": \"pink\"}, \n        { \"start\": 30, \"color\": \"green\"}, \n        { \"start\": 40, \"color\": \"red\"}, \n      ]\n    }\n    break \n\n  case 'ashp0/today/kWh' :\n    msg.ui_update = {\n      label : 'Output energy today kWh ', \n      fontSize : 20      \n    }\n    break \n  case 'ashp0/yesterday/kWh' :    \n    msg.ui_update = {\n      label : 'Output energy yesterday kWh ', \n      fontSize : 20      \n    }\n    break     \n  default :\n\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 1360,
        "wires": [
            [
                "2d6f3fff36f36fec",
                "94b54912d7823112"
            ]
        ]
    },
    {
        "id": "857f7ba98b9db309",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "Flow in/out",
        "group": "d3987b783abbd512",
        "order": 3,
        "width": "2",
        "height": "2",
        "min": "0",
        "max": "50",
        "sectors": [],
        "major_division": "5",
        "minor_division": "1",
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "Flow in/out",
        "units": "°C",
        "needles": [
            {
                "topic": "ashp0/TEMP_EWT",
                "color": "green",
                "lengthPercent": "100"
            },
            {
                "topic": "ashp0/TEMP_LWT",
                "color": "red",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 570,
        "y": 1580,
        "wires": []
    },
    {
        "id": "2d6f3fff36f36fec",
        "type": "switch",
        "z": "3187bd06ef664359",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "UNIT_STATUS",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "GENUNIT_CTRL_PNT",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "(TEMP_EWT|TEMP_LWT)",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "PUMPSTAT_CAPPOWER",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "yesterday\\/kWh",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "today\\/kWh",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 6,
        "x": 270,
        "y": 1600,
        "wires": [
            [
                "2fb23cde95534f2d"
            ],
            [
                "46840e3a9559d36d"
            ],
            [
                "857f7ba98b9db309"
            ],
            [
                "427f1f7861a9e8c6"
            ],
            [
                "823b75b14cac43ad"
            ],
            [
                "31f30a7c661ae413"
            ]
        ]
    },
    {
        "id": "7ab71584ce4a9f44",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "Outdoors",
        "group": "a89236c6fd618d45",
        "order": 1,
        "width": "2",
        "height": "2",
        "min": "0",
        "max": "22",
        "sectors": [],
        "major_division": "5",
        "minor_division": "1",
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "not initialised",
        "units": "°C",
        "needles": [
            {
                "topic": "lae0/PRO",
                "color": "red",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 580,
        "y": 2300,
        "wires": []
    },
    {
        "id": "df6629bce513b5d6",
        "type": "comment",
        "z": "3187bd06ef664359",
        "name": "Building sensor temperatures page, 'input registers'",
        "info": "",
        "x": 270,
        "y": 2380,
        "wires": []
    },
    {
        "id": "4207b681f59bdf56",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "9c62a4b6cf15630d",
        "name": "1SP",
        "label": "slider",
        "tooltip": "",
        "order": 2,
        "width": 6,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "always",
        "showTicks": "always",
        "min": 0,
        "max": "20",
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "grey",
        "colorTrack": "grey",
        "colorThumb": "",
        "showTextField": false,
        "x": 350,
        "y": 2040,
        "wires": [
            [
                "8b922c8e9c5bfc9a"
            ]
        ]
    },
    {
        "id": "e97b86492bdb03f2",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "9c62a4b6cf15630d",
        "name": "2SP",
        "label": "slider",
        "tooltip": "",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "always",
        "showTicks": "always",
        "min": 0,
        "max": "20",
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "grey",
        "colorTrack": "grey",
        "colorThumb": "",
        "showTextField": false,
        "x": 350,
        "y": 2100,
        "wires": [
            [
                "8b922c8e9c5bfc9a"
            ]
        ]
    },
    {
        "id": "6a8cd82ce90caf36",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "random",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "update_ui.options",
                "v": "[{'value' : 0, 'label' : 'abcd'}]",
                "vt": "jsonata"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "ddpowek",
        "payload": "true",
        "payloadType": "bool",
        "x": 120,
        "y": 2160,
        "wires": [
            [
                "91a5b7441a976c4e"
            ]
        ]
    },
    {
        "id": "427f1f7861a9e8c6",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "Output power",
        "group": "d3987b783abbd512",
        "order": 4,
        "width": "2",
        "height": "2",
        "min": "0",
        "max": "50",
        "sectors": [],
        "major_division": "5",
        "minor_division": "1",
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "Output power",
        "units": "kW",
        "needles": [
            {
                "topic": "",
                "color": "",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 580,
        "y": 1620,
        "wires": []
    },
    {
        "id": "31f30a7c661ae413",
        "type": "ui-text",
        "z": "3187bd06ef664359",
        "group": "d3987b783abbd512",
        "order": 5,
        "width": 0,
        "height": 0,
        "name": "Output energy",
        "label": "Output energy",
        "format": "{{msg.payload}}",
        "layout": "row-left",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "x": 580,
        "y": 1700,
        "wires": []
    },
    {
        "id": "823b75b14cac43ad",
        "type": "ui-text",
        "z": "3187bd06ef664359",
        "group": "d3987b783abbd512",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "Output energy",
        "label": "Output energy",
        "format": "{{msg.payload}}",
        "layout": "row-left",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "x": 580,
        "y": 1660,
        "wires": []
    },
    {
        "id": "46840e3a9559d36d",
        "type": "ui-gauge-classic",
        "z": "3187bd06ef664359",
        "name": "Control",
        "group": "d3987b783abbd512",
        "order": 2,
        "width": "2",
        "height": "2",
        "min": "0",
        "max": "50",
        "sectors": [],
        "major_division": "5",
        "minor_division": "1",
        "value_decimal_places": 1,
        "scale_decimal_places": 0,
        "label": "",
        "measurement": "Control point",
        "units": "°C",
        "needles": [
            {
                "topic": "",
                "color": "purple",
                "lengthPercent": "100"
            }
        ],
        "sweep_angle": 250,
        "myclass": "",
        "x": 560,
        "y": 1540,
        "wires": []
    },
    {
        "id": "2fb23cde95534f2d",
        "type": "ui-switch",
        "z": "3187bd06ef664359",
        "name": "State",
        "label": "waiting for update...",
        "group": "d3987b783abbd512",
        "order": 1,
        "width": null,
        "height": null,
        "passthru": false,
        "decouple": false,
        "topic": "",
        "topicType": "str",
        "style": "",
        "className": "",
        "layout": "row-left-swapped",
        "clickableArea": "none",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "heat-wave",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "heat-wave",
        "offcolor": "",
        "x": 550,
        "y": 1500,
        "wires": [
            []
        ]
    },
    {
        "id": "c2421ea89381c3ef",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "1",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "source",
                "v": "ashp0",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "ashp0/UNIT_STATUS",
        "payload": "1",
        "payloadType": "num",
        "x": 230,
        "y": 1440,
        "wires": [
            [
                "0021c59646b5c822"
            ]
        ]
    },
    {
        "id": "32d47156e0e7a9ca",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "0",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "source",
                "v": "ashp0",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "ashp0/UNIT_STATUS",
        "payload": "0",
        "payloadType": "num",
        "x": 230,
        "y": 1480,
        "wires": [
            [
                "0021c59646b5c822"
            ]
        ]
    },
    {
        "id": "ff58fb8898413348",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "5",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "source",
                "v": "ashp0",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "ashp0/UNIT_STATUS",
        "payload": "5",
        "payloadType": "num",
        "x": 230,
        "y": 1400,
        "wires": [
            [
                "0021c59646b5c822"
            ]
        ]
    },
    {
        "id": "e90782c8920ee20f",
        "type": "comment",
        "z": "3187bd06ef664359",
        "name": "LAE0 data should ONLY come from downsampler",
        "info": "",
        "x": 260,
        "y": 2420,
        "wires": []
    },
    {
        "id": "e0fac03ac529fc6a",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "source",
                "v": "ashp0",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "ashp0/today/kWh",
        "payload": "7",
        "payloadType": "num",
        "x": 270,
        "y": 1320,
        "wires": [
            [
                "0021c59646b5c822"
            ]
        ]
    },
    {
        "id": "54a154cc48ec7c69",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "source",
                "v": "ashp0",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "ashp0/yesterday/kWh",
        "payload": "6",
        "payloadType": "num",
        "x": 280,
        "y": 1360,
        "wires": [
            [
                "0021c59646b5c822"
            ]
        ]
    },
    {
        "id": "9cf7b39ffeb526ce",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "d": true,
        "group": "7d2a07e2b30dad87",
        "name": "flow setpoint",
        "label": "not initialised",
        "tooltip": "",
        "order": 5,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": "0",
        "max": "50",
        "step": "10",
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 710,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "7ef60c8d3ef9f629",
        "type": "ui-gauge-linear",
        "z": "3187bd06ef664359",
        "name": "flow setpoint 2",
        "group": "7d2a07e2b30dad87",
        "order": 4,
        "width": 3,
        "height": "1",
        "min": "20",
        "max": "50",
        "ticks": [
            {
                "value": "30",
                "label": "30"
            },
            {
                "value": "40",
                "label": "40"
            }
        ],
        "colors": [
            {
                "size": 100,
                "color": "rgb(255, 255, 0)"
            },
            {
                "size": 100,
                "color": "rgb(255, 255, 0)"
            },
            {
                "size": 100,
                "color": "rgb(255, 255, 0)"
            },
            {
                "size": 100,
                "color": "rgb(255, 255, 0)"
            },
            {
                "size": 100,
                "color": "rgb(255, 255, 0)"
            },
            {
                "size": 100,
                "color": "rgb(255, 255, 0)"
            },
            {
                "size": 100,
                "color": "rgb(255, 255, 0)"
            },
            {
                "size": 100,
                "color": "rgb(255, 255, 0)"
            },
            {
                "size": 100,
                "color": "rgb(0, 227, 0)"
            },
            {
                "size": 100,
                "color": "rgb(0, 227, 0)"
            },
            {
                "size": 100,
                "color": "rgb(0, 227, 0)"
            },
            {
                "size": 100,
                "color": "rgb(0, 227, 0)"
            },
            {
                "size": 100,
                "color": "rgb(0, 227, 0)"
            },
            {
                "size": 100,
                "color": "rgb(0, 227, 0)"
            },
            {
                "size": 100,
                "color": "rgb(0, 227, 0)"
            },
            {
                "size": 100,
                "color": "rgb(0, 227, 0)"
            },
            {
                "size": 100,
                "color": "rgb(255, 169, 22)"
            },
            {
                "size": 100,
                "color": "rgb(255, 169, 22)"
            },
            {
                "size": 100,
                "color": "rgb(255, 169, 22)"
            },
            {
                "size": 100,
                "color": "rgb(255, 169, 22)"
            },
            {
                "size": 100,
                "color": "rgb(255, 169, 22)"
            },
            {
                "size": 100,
                "color": "rgb(255, 76, 22)"
            },
            {
                "size": 100,
                "color": "rgb(255, 76, 22)"
            },
            {
                "size": 100,
                "color": "rgb(255, 76, 22)"
            },
            {
                "size": 100,
                "color": "rgb(255, 76, 22)"
            }
        ],
        "zeroCrossColors": [
            "#ff4c16",
            "#00e300"
        ],
        "mode": "default",
        "bar": "segmented",
        "minLabel": "",
        "maxLabel": "",
        "label": "Water flow setpoint",
        "icon": "",
        "unit": "°C",
        "dim": 0.2,
        "property": "payload",
        "decimals": 2,
        "zeros": true,
        "myclass": "",
        "x": 720,
        "y": 280,
        "wires": []
    },
    {
        "id": "b090260599cdd170",
        "type": "comment",
        "z": "3187bd06ef664359",
        "name": "White box controls page",
        "info": "",
        "x": 200,
        "y": 700,
        "wires": []
    },
    {
        "id": "de9a8c2bce218be1",
        "type": "link out",
        "z": "3187bd06ef664359",
        "name": "router",
        "mode": "link",
        "links": [
            "f6f4795a9b9f4f80"
        ],
        "x": 775,
        "y": 820,
        "wires": []
    },
    {
        "id": "4a3c52fb4dc216b4",
        "type": "function",
        "z": "3187bd06ef664359",
        "name": "setter",
        "func": "const tokens = msg.topic.split('/')\nmsg.topic = tokens[0] + '/set/' + tokens[1]\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 860,
        "wires": [
            [
                "de9a8c2bce218be1",
                "289f05625b5019a5"
            ]
        ]
    },
    {
        "id": "289f05625b5019a5",
        "type": "debug",
        "z": "3187bd06ef664359",
        "name": "returned",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 820,
        "y": 860,
        "wires": []
    },
    {
        "id": "15aa380a3443cc02",
        "type": "comment",
        "z": "3187bd06ef664359",
        "name": "ASHP panel, 'input registers'",
        "info": "",
        "x": 540,
        "y": 1220,
        "wires": []
    },
    {
        "id": "49671c73ccd8fdc1",
        "type": "comment",
        "z": "3187bd06ef664359",
        "name": "Heating control, 'holding registers'",
        "info": "",
        "x": 170,
        "y": 60,
        "wires": []
    },
    {
        "id": "94b54912d7823112",
        "type": "debug",
        "z": "3187bd06ef664359",
        "name": "debug 35",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 1360,
        "wires": []
    },
    {
        "id": "ce189e38ee1ada7b",
        "type": "debug",
        "z": "3187bd06ef664359",
        "name": "downsampler in",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 660,
        "y": 2440,
        "wires": []
    },
    {
        "id": "738d1f19ceaf53bf",
        "type": "link in",
        "z": "3187bd06ef664359",
        "name": "patch",
        "links": [],
        "x": 155,
        "y": 1220,
        "wires": [
            [
                "0021c59646b5c822",
                "ed057b51f606f2ba"
            ]
        ]
    },
    {
        "id": "ed057b51f606f2ba",
        "type": "debug",
        "z": "3187bd06ef664359",
        "name": "debug 37",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 1300,
        "wires": []
    },
    {
        "id": "9a8aa58508996f67",
        "type": "ui-switch",
        "z": "3187bd06ef664359",
        "name": "hrEnabled",
        "label": "Weather Compensation",
        "group": "8fddc7545b8b993d",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "decouple": false,
        "topic": "topic",
        "topicType": "msg",
        "style": "",
        "className": "",
        "layout": "row-left",
        "clickableArea": "label",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "",
        "offcolor": "",
        "x": 410,
        "y": 500,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "478bf454a2e6f026",
        "type": "comment",
        "z": "3187bd06ef664359",
        "name": "Labeling, set is done by 'ui update'",
        "info": "",
        "x": 180,
        "y": 100,
        "wires": []
    },
    {
        "id": "dc4128c790f0602d",
        "type": "ui-table",
        "z": "3187bd06ef664359",
        "group": "6b329d717937e322",
        "name": "Sensor table",
        "label": "Sensor status",
        "order": 1,
        "width": 0,
        "height": 0,
        "maxrows": "0",
        "passthru": false,
        "autocols": true,
        "showSearch": false,
        "deselect": true,
        "selectionType": "none",
        "columns": [],
        "mobileBreakpoint": "lg",
        "mobileBreakpointType": "defaults",
        "action": "replace",
        "x": 750,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "4cfbb5d77596f936",
        "type": "function",
        "z": "3187bd06ef664359",
        "name": "sensor data prep",
        "func": "const sensorRegex = /^[bsdgmt][\\d]{1,2}$/\n\nif (!msg.source.match(sensorRegex))\n  return null ;\n\nconst utils = global.get('utils') ?? null ;\n\n// ja \n// source is m1, m2, m3  (desired rows)\n// measurement is temperature, humidity  (desired cols)\n\nconst columns =  // define the initial column order\n{\n  time : 0,\n  source : '?',\n  location : '?',\n  temperature : 0\n}\nconst frame = context.get('frame') ?? { }\n\nconst row = frame[msg.source] ?? columns ;\n// \nrow['time'] =  utils.getHHMM(msg.timestamp);\nif (msg.last_seen)\n  row['lastSeen'] =  utils.getHHMM(msg.last_seen);\nrow['source'] = msg.source ;\nrow['location'] = msg.location ;\nrow['state'] = msg.state ;\nrow[msg.param] = msg.payload ;\nframe[msg.source] = row ;\ncontext.set('frame', frame)\n\nconst ar = Object.values(frame);\nconst arsort = (a, b) => a.source.localeCompare(b.source);\nar.sort(arsort);\n\nnode.status({ fill: \"green\", shape: \"dot\", text : msg.topic })\nreturn { topic : 'frame',  payload :  ar};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 1140,
        "wires": [
            [
                "dc4128c790f0602d"
            ]
        ]
    },
    {
        "id": "f9aaef9f35ef98d8",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 240,
        "y": 1140,
        "wires": [
            [
                "4cfbb5d77596f936"
            ]
        ]
    },
    {
        "id": "1c45ecd7fdc8802c",
        "type": "debug",
        "z": "3187bd06ef664359",
        "name": "inbound",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 40,
        "wires": []
    },
    {
        "id": "fb957731e504a9d1",
        "type": "ui-text",
        "z": "3187bd06ef664359",
        "d": true,
        "group": "9c62a4b6cf15630d",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "value": "payload",
        "valueType": "msg",
        "x": 150,
        "y": 660,
        "wires": []
    },
    {
        "id": "9d5ed6d1e0aa40f4",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "eca65edcc34b5a40",
        "name": "lcLow",
        "label": "not initialised",
        "tooltip": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": 10,
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 390,
        "y": 420,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "b442feb9dc937420",
        "type": "ui-text",
        "z": "3187bd06ef664359",
        "group": "e506712cd9dc5c30",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "log",
        "label": "PID log",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": true,
        "className": "",
        "x": 150,
        "y": 560,
        "wires": []
    },
    {
        "id": "921885113d64bd0d",
        "type": "ui-table",
        "z": "3187bd06ef664359",
        "group": "c8e0ab309895af11",
        "name": "PID0 settings",
        "label": "Heat controller inputs and outputs",
        "order": 1,
        "width": 0,
        "height": 0,
        "maxrows": "0",
        "passthru": false,
        "autocols": true,
        "showSearch": false,
        "selectionType": "none",
        "columns": [],
        "mobileBreakpoint": "lg",
        "mobileBreakpointType": "defaults",
        "action": "replace",
        "x": 540,
        "y": 1800,
        "wires": [
            []
        ]
    },
    {
        "id": "a11d7964c3f91c50",
        "type": "function",
        "z": "3187bd06ef664359",
        "name": "PID0 data prep",
        "func": "\nif (msg.topic != 'log/record/pid0')\n  return null ;\n\nconst log = context.get('logCalcs') ?? [{ }]\n\nif (log.length >= 10) \n  log.pop()\nlog.unshift(msg.payload)\ncontext.set('logCalcs', log)\n\n\nnode.status({ fill: \"green\", shape: \"dot\", text : msg.payload.time })\nreturn { topic : msg.topic,  payload :  log};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 1800,
        "wires": [
            [
                "921885113d64bd0d",
                "2bcceb12cb0e3621"
            ]
        ]
    },
    {
        "id": "8b087c86912319a1",
        "type": "link in",
        "z": "3187bd06ef664359",
        "name": "pid calcs",
        "links": [
            "90da587f91c535d6"
        ],
        "x": 165,
        "y": 1800,
        "wires": [
            [
                "a11d7964c3f91c50"
            ]
        ]
    },
    {
        "id": "f4519dfdeaf321b4",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 240,
        "y": 1700,
        "wires": [
            [
                "a11d7964c3f91c50"
            ]
        ]
    },
    {
        "id": "d6ea08116b54571f",
        "type": "inject",
        "z": "3187bd06ef664359",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 1520,
        "wires": [
            [
                "2fb23cde95534f2d"
            ]
        ]
    },
    {
        "id": "91a5b7441a976c4e",
        "type": "ui-switch",
        "z": "3187bd06ef664359",
        "name": "LAE0 OUT",
        "label": "waiting for update...",
        "group": "9c62a4b6cf15630d",
        "order": 4,
        "width": null,
        "height": null,
        "passthru": false,
        "decouple": false,
        "topic": "",
        "topicType": "str",
        "style": "",
        "className": "",
        "layout": "row-left-swapped",
        "clickableArea": "none",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "radiator",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "radiator-off",
        "offcolor": "",
        "x": 370,
        "y": 2160,
        "wires": [
            []
        ]
    },
    {
        "id": "0da7a18550db5f18",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "8fddc7545b8b993d",
        "name": "lcTrim",
        "label": "wc lc Trim",
        "tooltip": "",
        "order": 6,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": "10",
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 390,
        "y": 700,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "50d49369fff140db",
        "type": "ui-text",
        "z": "3187bd06ef664359",
        "group": "7d2a07e2b30dad87",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "heatingModeHelp",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#717171",
        "wrapText": true,
        "className": "",
        "value": "payload",
        "valueType": "msg",
        "x": 730,
        "y": 120,
        "wires": []
    },
    {
        "id": "d7a729c9b54aef0b",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "cab14c5374c0b4bf",
        "name": "prop_band",
        "label": "slider",
        "tooltip": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "all",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": "1",
        "step": ".1",
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 410,
        "y": 760,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "4ebaa0361f52d24b",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "cab14c5374c0b4bf",
        "name": "t_derivative",
        "label": "slider",
        "tooltip": "",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "all",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": 10,
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 410,
        "y": 840,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "043245fa94d8d05e",
        "type": "ui-slider",
        "z": "3187bd06ef664359",
        "group": "cab14c5374c0b4bf",
        "name": "t_integral",
        "label": "slider",
        "tooltip": "",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "all",
        "topic": "topic",
        "topicType": "msg",
        "thumbLabel": "true",
        "showTicks": "always",
        "min": 0,
        "max": 10,
        "step": 1,
        "className": "",
        "iconPrepend": "",
        "iconAppend": "",
        "color": "",
        "colorTrack": "",
        "colorThumb": "",
        "showTextField": false,
        "x": 400,
        "y": 800,
        "wires": [
            [
                "4ccc68756097fca2"
            ]
        ]
    },
    {
        "id": "2bcceb12cb0e3621",
        "type": "ui-table",
        "z": "3187bd06ef664359",
        "group": "5e3b78a06771b8f3",
        "name": "PID0 settings - 1 row",
        "label": "Heat controller inputs and outputs",
        "order": 1,
        "width": 0,
        "height": 0,
        "maxrows": "1",
        "passthru": false,
        "autocols": true,
        "showSearch": false,
        "deselect": false,
        "selectionType": "none",
        "columns": [
            {
                "title": "",
                "key": "",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            }
        ],
        "mobileBreakpoint": "lg",
        "mobileBreakpointType": "defaults",
        "action": "replace",
        "x": 560,
        "y": 1860,
        "wires": [
            []
        ]
    },
    {
        "id": "c46180bd2674fe18",
        "type": "ui-template",
        "z": "3187bd06ef664359",
        "group": "0ab4678ba1f9dae0",
        "page": "",
        "ui": "",
        "name": "test range",
        "order": 2,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<v-container class=\"pa-4\">\n  <h3 class=\"mb-4\">Vuetify Range Slider (Auto-Send, Compatible)</h3>\n\n  <v-range-slider\n    v-model=\"range\"\n    :min=\"0\"\n    :max=\"100\"\n    :step=\"1\"\n    thumb-label=\"always\"\n    color=\"primary\"\n  ></v-range-slider>\n\n  <div class=\"mt-2\">Selected range: {{ range[0] }} – {{ range[1] }}</div>\n</v-container>\n\n<script>\n(() => {\n  // Define reactive data for the template\n  const range = [20, 80];\n\n  // Make range reactive using Vue's reactivity (provided by Dashboard 2)\n  const vue = window.vueApp ?? window.Vue ?? null;\n  if (!vue) {\n    console.error(\"Vue instance not found in Dashboard context.\");\n    return;\n  }\n\n  const { ref, watch } = vue;\n  const rangeRef = ref(range);\n\n  // Auto-send when slider moves\n  watch(rangeRef, (newVal) => {\n    if (typeof send === \"function\") {\n      send({ payload: { range: newVal } });\n    } else if (window.send) {\n      window.send({ payload: { range: newVal } });\n    }\n  });\n\n  // Handle incoming messages\n  const receiveFn = typeof receive === \"function\" ? receive : window.receive;\n  if (receiveFn) {\n    receiveFn((msg) => {\n      if (msg?.payload?.range && Array.isArray(msg.payload.range)) {\n        rangeRef.value = msg.payload.range;\n      }\n    });\n  }\n\n  // Expose to template\n  return { range: rangeRef };\n})();\n</script>\n\n<style scoped>\nh3 {\n  font-weight: 500;\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 160,
        "y": 3020,
        "wires": [
            []
        ]
    },
    {
        "id": "c60061332293cb39",
        "type": "ui-template",
        "z": "3187bd06ef664359",
        "d": true,
        "group": "0ab4678ba1f9dae0",
        "page": "",
        "ui": "",
        "name": "test range2",
        "order": 3,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n    <div>\n        <h2>Counter</h2>\n        <p>Current Count: </p>\n        <p class=\"my-class\">Formatted Count: </p>\n        <v-btn @click=\"increase()\">Increment</v-btn>\n    </div>\n</template>\n\n<script>\n    export default {\n        data() {\n            // define variables available component-wide\n            // (in <template> and component functions)\n            return {\n                count: 0\n            }\n        },\n        watch: {\n            // watch for any changes of \"count\"\n            count: function () {\n                if (this.count % 5 === 0) {\n                    this.send({payload: 'Multiple of 5'})\n                }\n            }\n        },\n        computed: {\n            // automatically compute this variable\n            // whenever VueJS deems appropriate\n            formattedCount: function () {\n                return this.count + 'Apples'\n            }\n        },\n        methods: {\n            // expose a method to our <template> and Vue Application\n            increase: function () {\n                this.count++\n            }\n        },\n        mounted() {\n            // code here when the component is first loaded\n        },\n        unmounted() {\n            // code here when the component is removed from the Dashboard\n            // i.e. when the user navigates away from the page\n        }\n    }\n</script>\n<style>\n    /* define any styles here - supports raw CSS */\n    .my-class {\n        color: red;\n    }\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 170,
        "y": 3080,
        "wires": [
            []
        ]
    },
    {
        "id": "94aac4c5e81fde15",
        "type": "ui-template",
        "z": "3187bd06ef664359",
        "d": true,
        "group": "0ab4678ba1f9dae0",
        "page": "",
        "ui": "",
        "name": "test template",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n    <div>\n        <h2>Counter</h2>\n        <!-- Conditional Styling using Attribute Binding (\":\") -->\n        <!-- and rendering content inside <tags></tags> with {{ }} -->\n        <p :style=\"{'color' : (count > 5 ? 'red' : 'green' )}\">Current Count: {{ count }}</p>\n        <!-- Computed Rendering using Vue Computed Variables -->\n        <p class=\"my-class\">Formatted Count: {{ formattedCount }}</p>\n        <!-- Conditional Rendering with \"v-if\" -->\n        <b v-if=\"count > 5\">Too many!</b>\n        <v-btn @click=\"increase()\">Increment</v-btn>\n    </div>\n</template>\n\n<script>\n    export default {\n        data() {\n            // define variables available component-wide\n            // (in <template> and component functions)\n            return {\n                count: 0\n            }\n        },\n        watch: {\n            // watch for any changes of \"count\"\n            count: function () {\n                if (this.count % 5 === 0) {\n                    this.send({payload: 'Multiple of 5'})\n                }\n            }\n        },\n        computed: {\n            // automatically compute this variable\n            // whenever VueJS deems appropriate\n            formattedCount: function () {\n                return this.count + ' Apples'\n            }\n        },\n        methods: {\n            // expose a method to our <template> and Vue Application\n            increase: function () {\n                this.count++\n            }\n        },\n        mounted() {\n            // code here when the component is first loaded\n        },\n        unmounted() {\n            // code here when the component is removed from the Dashboard\n            // i.e. when the user navigates away from the page\n        }\n    }\n</script>\n<style>\n    /* define any styles here - supports raw CSS */\n    .my-class {\n        color: red;\n    }\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 170,
        "y": 3160,
        "wires": [
            []
        ]
    },
    {
        "id": "036e2046bfd2657c",
        "type": "delay",
        "z": "78ad727ff3800ccd",
        "name": "refresh 1 sec",
        "pauseType": "delay",
        "timeout": "1000",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 510,
        "y": 420,
        "wires": [
            [
                "e664cefd2982f764"
            ]
        ]
    },
    {
        "id": "f2247fd3eb87a008",
        "type": "function",
        "z": "78ad727ff3800ccd",
        "name": "create modbus write",
        "func": "/*\nFunction node code example for single write:\n\nmsg.payload = { value: msg.payload, 'fc': 5, 'unitid': 1, 'address': 0 , 'quantity': 1 } return msg ;\n\nFunction node code example for multiple write:\n\nmsg.payload = { value: msg.payload, 'fc': 15, 'unitid': 1, 'address': 0 , 'quantity': 10 } return msg ;\n*/\n\nconst utils = global.get('utils') \n\nlet payload = msg.payload ; \nif (isFinite(payload))\n  payload = utils.twoDecPoint(10 * Number(payload))\n\nmsg.payload = { 'address': msg.address, value: payload, 'fc': 6, 'unitid': 1,  'quantity': 2 };\n\nnode.status({ fill: \"yellow\", shape: \"dot\", text: `${msg.topic}  ${payload}` });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 320,
        "wires": [
            [
                "21ea63b8552935b4",
                "94620ca7e001976d"
            ]
        ]
    },
    {
        "id": "21ea63b8552935b4",
        "type": "modbus-flex-write",
        "z": "78ad727ff3800ccd",
        "name": "write AC1-27",
        "showStatusActivities": true,
        "showErrors": true,
        "showWarnings": true,
        "server": "8a3ca6b2c6028d5b",
        "emptyMsgOnFail": true,
        "keepMsgProperties": true,
        "delayOnStart": false,
        "startDelayTime": "",
        "x": 730,
        "y": 320,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "7a7bf0dbe5c3e9c8",
        "type": "modbus-flex-connector",
        "z": "78ad727ff3800ccd",
        "name": "AC1 27 connector",
        "maxReconnectsPerMinute": 4,
        "emptyQueue": false,
        "showStatusActivities": true,
        "showErrors": true,
        "server": "8a3ca6b2c6028d5b",
        "x": 510,
        "y": 480,
        "wires": [
            [
                "98d6879a13a2d3cf"
            ]
        ]
    },
    {
        "id": "94620ca7e001976d",
        "type": "debug",
        "z": "78ad727ff3800ccd",
        "name": "updates",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 380,
        "wires": []
    },
    {
        "id": "98d6879a13a2d3cf",
        "type": "debug",
        "z": "78ad727ff3800ccd",
        "name": "raw modbus",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 540,
        "wires": []
    },
    {
        "id": "297578f283368694",
        "type": "modbus-flex-sequencer",
        "z": "78ad727ff3800ccd",
        "name": "AC1 27 read",
        "sequences": [
            {
                "name": "sequence0",
                "unitid": "1",
                "fc": "FC3",
                "address": "0",
                "quantity": "1"
            }
        ],
        "server": "8a3ca6b2c6028d5b",
        "showStatusActivities": true,
        "showErrors": true,
        "showWarnings": true,
        "logIOActivities": false,
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": true,
        "keepMsgProperties": true,
        "delayOnStart": false,
        "startDelayTime": "",
        "x": 490,
        "y": 540,
        "wires": [
            [
                "98d6879a13a2d3cf",
                "f19f15445d6a2cbf"
            ],
            []
        ]
    },
    {
        "id": "e664cefd2982f764",
        "type": "function",
        "z": "78ad727ff3800ccd",
        "name": "poll modbus",
        "func": "\n// this code is largely duplicated from ashp poll\n\n\n// ver 1.0\nfunction lookupRegister(subTopic) {\n    const registers = flow.get(\"modbusRegistersLAE0\");\n    for (const row of registers) {\n        if (row[\"Mnem.\"] == subTopic)\n            return row;\n    }\n    node.error('Unable to find register in map ' + subTopic)\n    return null;\n}\n\n//msg.topic = 'sequence1';\n//flow.set('writeThrough', msg.writeThrough);  // but what's being saved? A: whether we want to flush\n//msg.payload = null;\n\n\nconst input =\n    [\n        { name: \"1SP\" },\n        { name: \"2SP\" },       \n        { name: \"ALA\" },    // low temp alarm, used for testing       \n        { name: \"AHA\" },    // low temp alarm, used for testing               \n    ];\n\nconst temperature =\n    [\n        { \n            name: \"PRO\", \n            reportOnDiff: 0.3,            // override the 0.25 \n            windowPeriodSecs : 60 * 60    // 60 minutes\n        }  \n    ];\n\nconst state =  \n    [\n        { name: \"OUT\" }\n    ];\n\nconst alarm =\n    [\n        { name: \"AL0\" },\n        { name: \"AL1\" }\n    ];\n\n\nconst tokens = msg.topic.split(/[\\/]/);\nconst subTopic = tokens === undefined ? msg.topic : tokens.at(-1);  \n\nlet regList         = { input: input, temperature: temperature, state: state, alarm: alarm};\nlet reportOnDiff    = { temperature: 1.0 };\nlet windowPeriodSecs = 120 * 60    // 2 hours\nlet sequences = [] ;\n\nconst fc = { HR : 3}\n\nfor (const [measurement, group] of Object.entries(regList)) {    \n    for (const e of group) {\n        if (subTopic == 'pollAll' || subTopic == e.name)\n        {\n            const row = lookupRegister(e.name);\n            if (row)\n            {\n                const m = {} ;\n                m.prefix = 'local';\n                m.source = 'lae0';\n                m.location = e.name;\n                m.topic = m.source + '/' + m.location;\n\n                // essential modbus characteristics\n                m.address = row.Address ;\n                m.param = measurement;\n                m.fc = fc['HR'] ;\n                m.quantity = 1 ;\n                m.unitid = 1;\n\n\n                m.modbusRow = row ;\n                m.writeThrough = msg.writeThrough ;  // set upstream\n\n                const diff = e.reportOnDiff ?? reportOnDiff[measurement] ?? false;\n                if (diff)\n                    m.reportOnDiff = diff ;\n\n                m.windowPeriodSecs = e.windowPeriodSecs ?? windowPeriodSecs ; \n\n                //const digest = (m.reportOnDiff != 0) && !(msg.writeThrough ?? false)\n\n                const doDeliver = msg.writeThrough || (msg.reportOnDiff === undefined) \n                //node.error(e)\n                // red : digest, yellow : update, green : writeThrough   \n\n\n                let colour = doDeliver ? m.writeThrough ? 'green' : 'yellow' : 'red' ;\n                node.status({ fill: colour, shape: \"dot\", text: `name:${e.name}` });\n                sequences.push(m);\n            }\n        }\n    }\n}\n\n//msg.sequences = Array.prototype.concat(temperatures, pressures)\n\nmsg.sequences = sequences;\nif (msg.sequences.length == 0)\n{\n    node.status({ fill: \"red\", shape: \"ring\", text: `Nothing sent ${msg.topic}` });\n    return null ;\n}\nif (msg.sequences.length > 1)\n{\n    node.status({ fill: \"green\", shape: \"ring\", text: `${msg.sequences.length} registers requested` });\n}\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n//const fs = require('fs');\n//const csv = require('csv-parser');\n\n/*\nconst filePath = 'AQUACIAT-Modbus.csv'; // Replace with your actual file path\n\nconst data = [];\n\nfs.createReadStream(filePath)\n    .pipe(csv())\n    .on('data', (row) => {\n        data.push(row);\n    })\n    .on('end', () => {\n        console.log('CSV data parsed successfully!');\n        context.put('aquaciat', data);\n        node.status({ fill: \"green\", shape: \"dot\", text: `CSV file loaded` });\n\n\n    })\n    .on('error', (err) => {\n        console.error('Error parsing CSV:', err);\n    });\n\n*/",
        "finalize": "",
        "libs": [],
        "x": 270,
        "y": 540,
        "wires": [
            [
                "297578f283368694"
            ]
        ]
    },
    {
        "id": "f19f15445d6a2cbf",
        "type": "function",
        "z": "78ad727ff3800ccd",
        "name": "number conversions",
        "func": "//\n// note that the load CSV node must be configured to NOT parse numbers \n// because default values like 40.0 must be preserved as this is used\n// to determine decimal points\n\nconst utils  = global.get(\"utils\")\n\nconst m = /\\.[\\d]+$/.test(msg.modbusRow['Default value'])\nconst numberOfDecimals = m ? 1 : 0;\n\nRED.util.cloneMessage(msg);\n\nif (isFinite(msg.payload)) \n{\n  msg.payload *= Math.pow(10, -numberOfDecimals);\n  msg.payload = utils.oneDecPoint(msg.payload) \n}\n\nmsg.units = msg.modbusRow['Unit/Value']\n\n// red : digest, yellow : update, green : writeThrough    \n\nlet colour = msg.digest ? 'red': (msg.writeThrough ? 'green' : 'yellow') ;\n\nconst defaultValue = msg.modbusRow['Default value']\nconst defaultValueText = defaultValue === undefined ? \"\" : 'default ' + defaultValue\nnode.status({\n    fill: colour, shape: \"dot\", \n    text: `${utils.getTimeNow()} ${msg.topic}:${msg.payload} ${defaultValueText}`\n});\nreturn msg  ;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 620,
        "wires": [
            [
                "5d488e53c97b07ab",
                "a2d462fa509649cf"
            ]
        ]
    },
    {
        "id": "c438c8cab5ded2a4",
        "type": "function",
        "z": "78ad727ff3800ccd",
        "name": "map LAE register",
        "func": "/**\n * lookup address of LAE mneumonic\n * The last subtopic is assumed to contain \n * the  register name e.g  \n * \n * lae0/get/1SP   // but not supported\n * lae0/set/2SP \n */\n\n// ver 1.1\nfunction lookupRegister(topic) {\n\n    const tokens = topic.split(/[\\/]/);\n    const subTopic = tokens.at(-1);  \n    const registers = flow.get(\"modbusRegistersLAE0\");\n    for (const row of registers) {\n        if (row[\"Mnem.\"] == subTopic)\n            return row;\n    }\n    node.error('unable to parse ' + subTopic)\n    return null;\n}\n\n\nconst row = lookupRegister(msg.topic)\nif (row)\n{   \n    msg.address = row.Address;\n    /*\n    if (msg.topic == 'PRO')  // outside temperature\n    {\n        msg.digest = true  \n        msg.track = true \n        msg.windowSize = 2 \n    }  \n    else \n    */\n    //msg.writeThough = true;\n\n    msg.modbusRow = row ;\n    let colour = msg.digest ? 'red': (msg.writeThrough ? 'green' : 'yellow') ;\n    node.status({ fill: colour, shape: \"dot\", text: `${msg.topic} ${msg.address} ${msg.payload}` });\n    return msg  ;\n}\nelse\n{\n    node.status({ fill: \"black\", shape: \"dot\", text: `unmatched command: ${msg.topic}` });\n    return null ;\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 270,
        "y": 320,
        "wires": [
            [
                "036e2046bfd2657c",
                "f2247fd3eb87a008"
            ]
        ]
    },
    {
        "id": "9a42b7c21189bcac",
        "type": "file in",
        "z": "78ad727ff3800ccd",
        "name": "read modbus file",
        "filename": "/mnt/dietpi_userdata/lae-ac1/lae-ac1-27.csv",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 410,
        "y": 100,
        "wires": [
            [
                "4e4de1bff793bf79"
            ]
        ]
    },
    {
        "id": "d019b6b3ca9e6bcd",
        "type": "debug",
        "z": "78ad727ff3800ccd",
        "name": "lae-modbus",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 180,
        "wires": []
    },
    {
        "id": "a0f3a2340a3477a3",
        "type": "function",
        "z": "78ad727ff3800ccd",
        "name": "set modbusLAE0 array",
        "func": "// todo, store scale as \n\nlet registers = msg.payload;\nconst contextName = \"modbusRegistersLAE0\"\nflow.set(contextName , registers);\nconst len = registers.length ;\nnode.status({ fill: \"green\", shape: \"dot\", text: `${len} items loaded from file into flow ${contextName}`});\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 180,
        "wires": [
            [
                "d019b6b3ca9e6bcd"
            ]
        ]
    },
    {
        "id": "375c1135c9263a11",
        "type": "inject",
        "z": "78ad727ff3800ccd",
        "name": "initialize",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.0",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 200,
        "y": 100,
        "wires": [
            [
                "9a42b7c21189bcac"
            ]
        ]
    },
    {
        "id": "4e4de1bff793bf79",
        "type": "csv",
        "z": "78ad727ff3800ccd",
        "name": "load CSV (no numbers)",
        "sep": ",",
        "hdrin": true,
        "hdrout": "none",
        "multi": "mult",
        "ret": "\\n",
        "temp": "",
        "skip": "0",
        "strings": false,
        "include_empty_strings": "",
        "include_null_values": "",
        "x": 650,
        "y": 100,
        "wires": [
            [
                "a0f3a2340a3477a3"
            ]
        ]
    },
    {
        "id": "1c929b18596fe404",
        "type": "comment",
        "z": "78ad727ff3800ccd",
        "name": "modbus interface to LAE1-27 white box in plant room over serial link",
        "info": "",
        "x": 360,
        "y": 40,
        "wires": []
    },
    {
        "id": "38ae1de7ad821a16",
        "type": "inject",
        "z": "78ad727ff3800ccd",
        "name": "every 20 secs",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "writeThrough",
                "v": "false",
                "vt": "bool"
            }
        ],
        "repeat": "20",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "pollAll",
        "payload": "",
        "payloadType": "date",
        "x": 240,
        "y": 420,
        "wires": [
            [
                "e664cefd2982f764"
            ]
        ]
    },
    {
        "id": "5d488e53c97b07ab",
        "type": "link out",
        "z": "78ad727ff3800ccd",
        "name": "downsampler",
        "mode": "link",
        "links": [
            "818e2038058a0e91"
        ],
        "x": 715,
        "y": 620,
        "wires": []
    },
    {
        "id": "067d0e710c60a2bf",
        "type": "link in",
        "z": "78ad727ff3800ccd",
        "name": "lae0 get/set",
        "links": [
            "f1ec3b162b1184a0",
            "16fe20a05e4f8866"
        ],
        "x": 135,
        "y": 320,
        "wires": [
            [
                "c438c8cab5ded2a4"
            ]
        ]
    },
    {
        "id": "76500cf3375b0621",
        "type": "link out",
        "z": "78ad727ff3800ccd",
        "name": "listener",
        "mode": "link",
        "links": [
            "e731444c07535ac3"
        ],
        "x": 715,
        "y": 660,
        "wires": []
    },
    {
        "id": "5a52353f2cbb9e61",
        "type": "comment",
        "z": "78ad727ff3800ccd",
        "name": "Nodes below are similar to those on ashp0",
        "info": "",
        "x": 280,
        "y": 260,
        "wires": []
    },
    {
        "id": "f3dd344c36740256",
        "type": "debug",
        "z": "78ad727ff3800ccd",
        "name": "payload",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 720,
        "wires": []
    },
    {
        "id": "a2d462fa509649cf",
        "type": "subflow:9e36a25803eb28ab",
        "z": "78ad727ff3800ccd",
        "name": "",
        "x": 490,
        "y": 660,
        "wires": [
            [
                "76500cf3375b0621",
                "f3dd344c36740256"
            ],
            [],
            []
        ]
    },
    {
        "id": "dcad49ce97d38715",
        "type": "file in",
        "z": "d6d8802f46b4aa03",
        "name": "read modbus file",
        "filename": "/mnt/dietpi_userdata/AQUACIAT-LD_ILD_150R-600R_Modbus.csv",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 570,
        "y": 120,
        "wires": [
            [
                "42ec723fea505d70"
            ]
        ]
    },
    {
        "id": "55bcf23565930b54",
        "type": "debug",
        "z": "d6d8802f46b4aa03",
        "name": "reg load",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 180,
        "wires": []
    },
    {
        "id": "fa32f5503e51738d",
        "type": "function",
        "z": "d6d8802f46b4aa03",
        "name": "set modbusASHP array",
        "func": "let registers = msg.payload;\nconst contextName = \"modbusRegistersASHP\"\nflow.set(contextName, registers);\nconst len = registers.length ;\nnode.status({ fill: \"green\", shape: \"dot\", text: `${len} items loaded into ${contextName}`});\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 180,
        "wires": [
            [
                "55bcf23565930b54"
            ]
        ]
    },
    {
        "id": "dbb1e36af2878840",
        "type": "inject",
        "z": "d6d8802f46b4aa03",
        "name": "initialize",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.0",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 380,
        "y": 120,
        "wires": [
            [
                "dcad49ce97d38715"
            ]
        ]
    },
    {
        "id": "42ec723fea505d70",
        "type": "csv",
        "z": "d6d8802f46b4aa03",
        "name": "load CSV",
        "sep": ",",
        "hdrin": true,
        "hdrout": "none",
        "multi": "mult",
        "ret": "\\n",
        "temp": "",
        "skip": "0",
        "strings": true,
        "include_empty_strings": "",
        "include_null_values": "",
        "x": 780,
        "y": 120,
        "wires": [
            [
                "fa32f5503e51738d"
            ]
        ]
    },
    {
        "id": "1e837a9b33a662b8",
        "type": "comment",
        "z": "d6d8802f46b4aa03",
        "name": "Load the names and numbers of ASHP modbus registers we're interested in",
        "info": "",
        "x": 570,
        "y": 80,
        "wires": []
    },
    {
        "id": "3bdc23fc1f16c1bb",
        "type": "modbus-flex-sequencer",
        "z": "d6d8802f46b4aa03",
        "name": "ASHP-read",
        "sequences": [
            {
                "name": "sequence0",
                "unitid": "1",
                "fc": "FC1",
                "address": "0",
                "quantity": "1"
            }
        ],
        "server": "c6b56e0744603b80",
        "showStatusActivities": true,
        "showErrors": true,
        "showWarnings": true,
        "logIOActivities": false,
        "useIOFile": false,
        "ioFile": "",
        "useIOForPayload": false,
        "emptyMsgOnFail": true,
        "keepMsgProperties": true,
        "delayOnStart": false,
        "startDelayTime": "",
        "x": 570,
        "y": 560,
        "wires": [
            [
                "a78a112a810b69ea"
            ],
            [
                "6dbcbc44b8105773"
            ]
        ]
    },
    {
        "id": "e8b29f091693fa42",
        "type": "inject",
        "z": "d6d8802f46b4aa03",
        "name": "every 20 secs",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "writeThrough",
                "v": "false",
                "vt": "bool"
            }
        ],
        "repeat": "20",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "pollAll",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 560,
        "wires": [
            [
                "f176f6507293d547"
            ]
        ]
    },
    {
        "id": "f176f6507293d547",
        "type": "function",
        "z": "d6d8802f46b4aa03",
        "name": "poll modbus",
        "func": "\n// specify explicit register using msg.topic else get them all\n\n\n// 01: Coils (FC=01)\n// 02: Discrete Inputs (FC=02)\nconst HR = 3 // Multiple Holding Registers (FC=03)\nconst IR = 4 // Input Registers (FC=04)\n// 05: Single Coil (FC=05)\n// 06: Single Holding Register (FC=06)\n// 0F: Multiple Coils (FC=15)\n// 10: Multiple Holding Registers (FC=16)\n\n\n// ver 1.0\nfunction lookupRegister(subTopic) {\n    const registers = flow.get(\"modbusRegistersASHP\");\n    for (const row of registers) {\n        if (row.Parameter == subTopic)\n            return row;\n    }\n    node.error('unable to parse ' + subTopic)\n    return null;\n}\n\n//msg.topic = 'sequence1';\n//flow.set('writeThrough', msg.writeThrough);  // but what's being saved? A: whether we want to flush\n//msg.payload = null;\n\n\nconst input =\n    [\n        { name: \"SETPOINT_hsp1\" },\n        { name: \"SETPOINT_hsp2\" },\n\n        { name: \"RESETCFG_hr_deg\" },\n        { name: \"RESETCFG_oat_hrfu\" },\n        { name: \"RESETCFG_oat_hrno\" },\n\n        { name: \"PROTOCOL_DEM_LIM\" },\n        { name: \"PUMPCONF_w_dt_spt\" }\n    ];\n\nconst temperature =\n    [\n        { name: \"GENUNIT_SP\" },\n        { name: \"GENUNIT_CTRL_PNT\" },\n        { name: \"GENUNIT_CTRL_TYP\" },\n\n        { name: \"TEMP_EWT\", reportOnDiff: 1 },  // override the 0.25\n        { name: \"TEMP_LWT\", reportOnDiff: 1 },  // override the 0.25\n        { name: \"TEMP_OAT\" },\n    ];\n\nconst pressure =\n    [\n        { name: \"PRESSURE_PUMP_EWP\" },\n        { name: \"PRESSURE_PUMP_LWP\" },\n        { name: \"PUMPSTAT_WAT_FLOW\" }\n    ];\n\nconst state =\n    [\n        { name: \"UNIT_STATUS\" },\n        { name: \"PROTOCOL_CHIL_S_S\" },  //off on\n        { name: \"PROTOCOL_SP_SEL\" },\n        { name: \"PROTOCOL_SP_OCC\" },\n        { name: \"PROTOCOL_CHIL_OCC\" },\n\n        { name: \"PUMPSTAT_PUMP_1\" },\n        { name: \"PUMPSTAT_PUMP_2\" },\n    ];\n\nconst pump =\n    [\n        { name: \"GENUNIT_CAP_T\", reportOnDiff: 10 },   // 0% to 100%\n\n        { name: \"PUMPSTAT_VPMP_CMD\" },\n        { name: \"PUMPSTAT_CAPPOWER\", reportOnDiff: 2 },\n        { name: \"PUMPSTAT_WAT_FLOW\", reportOnDiff: 0.5 },\n    ];\n\nconst alarm =\n    [\n        { name: \"UNIT_ALM\" },\n        { name: \"ALARMRST_alarm_1c\" },\n        { name: \"ALARMRST_alarm_2c\" },\n        { name: \"ALARMRST_alarm_3c\" },\n        { name: \"ALARMRST_alarm_4c\" },\n        { name: \"ALARMRST_alarm_5c\" },\n    ];\n\n\n\nconst tokens = msg.topic.split(/[\\/]/);\nconst subTopic = tokens === undefined ? msg.topic : tokens.at(-1);\n\n\nlet regList = { input: input, temperature: temperature, pressure: pressure, state: state, pump: pump, alarm: alarm };\nlet reportOnDiff = { temperature: 1.0, pressure: 15, pump: 0.5 };\n\nlet sequences = [];\n\nconst fc = { HR: 3, IR: 4 }\n\nfor (const [measurement, group] of Object.entries(regList)) {\n    for (const e of group) {\n        if (subTopic == 'pollAll' || subTopic == e.name) {\n            const row = lookupRegister(e.name);\n            if (row) {\n                const m = {};\n                m.prefix = 'local';\n                m.source = 'ashp0';\n                m.location = e.name;\n                m.topic = m.source + '/' + m.location;\n\n                // essential modbus characteristics\n                m.address = row.Address;\n                m.param = measurement;\n                m.fc = fc[row.Type];\n                m.quantity = row['Reg. N°'];\n                m.unitid = 1;\n\n\n                m.modbusRow = row;\n                m.writeThrough = msg.writeThrough;\n\n\n                //const groupReportOnDifference = reportOnDiff[measurement] ?? undefined ;\n\n                const diff = e.reportOnDiff ?? reportOnDiff[measurement] ?? false;\n                if (diff)\n                    m.reportOnDiff = diff ;\n                    \n                m.windowPeriodSecs = 120 * 60    // 2 hours\n\n                let colour = m.digest ? 'red' : (m.writeThrough ? 'green' : 'yellow');\n                node.status({ fill: colour, shape: \"dot\", text: `name:${e.name}` });\n                sequences.push(m);\n            }\n        }\n    }\n}\n\n//msg.sequences = Array.prototype.concat(temperatures, pressures)\n\nmsg.sequences = sequences;\nif (msg.sequences.length == 0) {\n    node.status({ fill: \"red\", shape: \"ring\", text: `Nothing sent ${msg.topic}` });\n    return null;\n}\nif (msg.sequences.length > 1) {\n    node.status({ fill: \"green\", shape: \"ring\", text: `${msg.sequences.length} registers requested` });\n}\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n//const fs = require('fs');\n//const csv = require('csv-parser');\n\n/*\nconst filePath = 'AQUACIAT-Modbus.csv'; // Replace with your actual file path\n\nconst data = [];\n\nfs.createReadStream(filePath)\n    .pipe(csv())\n    .on('data', (row) => {\n        data.push(row);\n    })\n    .on('end', () => {\n        console.log('CSV data parsed successfully!');\n        context.put('aquaciat', data);\n        node.status({ fill: \"green\", shape: \"dot\", text: `CSV file loaded` });\n\n\n    })\n    .on('error', (err) => {\n        console.error('Error parsing CSV:', err);\n    });\n\n*/",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 560,
        "wires": [
            [
                "3bdc23fc1f16c1bb"
            ]
        ]
    },
    {
        "id": "fd7087714f1e7e46",
        "type": "modbus-flex-connector",
        "z": "d6d8802f46b4aa03",
        "name": "ASHP-connector",
        "maxReconnectsPerMinute": 4,
        "emptyQueue": false,
        "showStatusActivities": true,
        "showErrors": true,
        "server": "c6b56e0744603b80",
        "x": 590,
        "y": 480,
        "wires": [
            [
                "a78a112a810b69ea"
            ]
        ]
    },
    {
        "id": "a78a112a810b69ea",
        "type": "debug",
        "z": "d6d8802f46b4aa03",
        "name": "raw modbus",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 810,
        "y": 480,
        "wires": []
    },
    {
        "id": "bb16735a0cac5286",
        "type": "debug",
        "z": "d6d8802f46b4aa03",
        "name": "payload",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 600,
        "wires": []
    },
    {
        "id": "298f4d77b929e02a",
        "type": "link out",
        "z": "d6d8802f46b4aa03",
        "name": "sensors",
        "mode": "link",
        "links": [
            "3a0b7c61797ade28"
        ],
        "x": 715,
        "y": 660,
        "wires": []
    },
    {
        "id": "6dbcbc44b8105773",
        "type": "function",
        "z": "d6d8802f46b4aa03",
        "name": "number conversions",
        "func": "\n// float32lib.js  rev 1.0 22/09/2024\n\nfunction swapEndian(xb) {\n    return [xb[1], xb[0], xb[3], xb[2]]\n}\n\nfunction float32ToBytes(fl) {\n    const f32 = new Float32Array(1); f32[0] = fl;\n    const ui8 = new Uint8Array(f32.buffer);\n    return swapEndian((Array.from(ui8)));\n}\n\n// this still works on incoming data\n// float32ToBytes bytes = 15,219,64,73 getFloat32 = 3.14\n\nfunction bytesToFloat32(xb) {\n    const ui8 = Uint8Array.from((swapEndian(xb)));\n    //console.log(`ui8: ${ui8}  ui8.buffer ${ui8.buffer}`);\n    const fl = new Float32Array(ui8.buffer);\n    return Math.trunc(fl[0] * 100) / 100;\n}\n\n\nfunction bytesToUint32(xb) {\n    const ui8 = Uint8Array.from((swapEndian(xb)));\n    //console.log(`ui8: ${ui8}  ui8.buffer ${ui8.buffer}`);\n\n    var dataView = new DataView(ui8.buffer);\n    return dataView.getUint32(0, true); // false for big-endian\n}\n\n\nlet value = null ;\n\nswitch (msg.modbusRow['Display Mode'])\n{\n    case '32bits FLOAT' :\n        value = bytesToFloat32(msg.payload.buffer);\n        break ;\n\n    case '32bits UINT' :   \n        value = bytesToUint32(msg.payload.buffer);\n        value = msg.modbusRow['Max.'] == 1 ? value * 100 : value ; // boolean\n        break ;\n    \n    default : \n        node.status({ fill: \"red\", shape: \"dot\", text: `${msg.topic}:${msg.payload} unrecognised dm: ${msg.modbusRow['Display Mode']}`})\n        return null ;\n}\n\nmsg.units = msg.modbusRow['Unit']\nmsg.payload = value;\n\n// red : digest, yellow : update, green : writeThrough    \n\nlet colour = msg.digest ? 'red': (msg.writeThrough ? 'green' : 'yellow') ;\n\nnode.status({ fill: colour, shape: \"dot\", text: `${msg.topic}:${msg.payload}` });\nreturn msg  ;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 660,
        "wires": [
            [
                "bb16735a0cac5286",
                "298f4d77b929e02a"
            ]
        ]
    },
    {
        "id": "e3f5b1582fd58943",
        "type": "modbus-flex-write",
        "z": "d6d8802f46b4aa03",
        "name": "ASHP-write",
        "showStatusActivities": true,
        "showErrors": true,
        "showWarnings": true,
        "server": "c6b56e0744603b80",
        "emptyMsgOnFail": false,
        "keepMsgProperties": true,
        "delayOnStart": false,
        "startDelayTime": "",
        "x": 810,
        "y": 340,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "faf9c12a90fda8f1",
        "type": "function",
        "z": "d6d8802f46b4aa03",
        "name": "create modbus request",
        "func": "/*\nFunction node code example for single write:\n\nmsg.payload = { value: msg.payload, 'fc': 5, 'unitid': 1, 'address': 0 , 'quantity': 1 } return msg ;\n\nFunction node code example for multiple write:\n\nmsg.payload = { value: msg.payload, 'fc': 15, 'unitid': 1, 'address': 0 , 'quantity': 10 } return msg ;\n*/\n\n\nfunction swapEndian(xb) {\n    return [xb[1], xb[0], xb[3], xb[2]]\n}\n\nfunction float32ToBytes(fl) {\n    const f32 = new Float32Array(1); f32[0] = fl;\n    const ui8 = new Uint8Array(f32.buffer);\n    return swapEndian((Array.from(ui8)));\n}\n\nfunction uint32ToBytes(ui) {\n    const ui32 = new Uint32Array(1); ui32[0] = ui;\n    const ui8 = new Uint8Array(ui32.buffer);\n    return swapEndian((Array.from(ui8)));\n}\n\n\n\n// this still works on incoming data\n// float32ToBytes bytes = 15,219,64,73 getFloat32 = 3.14\n\nfunction bytesToFloat32(xb) {\n    const ui8 = Uint8Array.from((swapEndian(xb)));\n    const fl = new Float32Array(ui8.buffer);\n    return Math.trunc(fl[0] * 100) / 100;\n}\n\n/*\nconst f32val = msg.payload ;\nconst ba = float32ToBytes(f32val);\nconst f32check = bytesToFloat32(ba);\n\nif (f32check != f32val)\n{\n    node.error(`values ${f32val} ${f32check} do not match`)\n    return null ;\n}\n*/\n\nlet numericPayload = Number(msg.payload);\n\nlet ba = null ; \nswitch (msg.modbusRow['Display Mode']) \n{\n    case '32bits FLOAT':\n        ba = float32ToBytes(numericPayload);\n        break;\n\n    case '32bits UINT':\n        ba = uint32ToBytes(Math.round(numericPayload));\n        //value = msg.modbusRow['Max.'] == 1 ? value * 100 : value; // boolean\n        break;\n\n    default:\n        node.error(`${msg.topic}:${numericPayload} dm: ${msg['Display Mode']}`)\n        return null;\n}\n\nvar ui16 = [(ba[0] * 256 + ba[1]), (ba[2] * 256) + ba[3]] ;\n\nmsg.payload = { 'address': msg.address, value: ui16, 'fc': 16, 'unitid': 1,  'quantity': 2 };\n\nnode.status({ fill: \"yellow\", shape: \"dot\", text: `${msg.topic}  ${ui16}` });\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 340,
        "wires": [
            [
                "e3f5b1582fd58943",
                "13536d367730f4cf"
            ]
        ]
    },
    {
        "id": "ab26331b697a1a23",
        "type": "function",
        "z": "d6d8802f46b4aa03",
        "name": "map CIAT register",
        "func": "/**\n * \n */\n\n\n// ver 1.0\nfunction lookupRegister(topic)\n{\n    const tokens = topic.split(/[\\/]/);\n    const subTopic = tokens.at(-1);     \n\n    const registers = flow.get(\"modbusRegistersASHP\");\n    for (const row of registers)\n    {\n        if (row.Parameter == subTopic)\n            return row ;\n    }   \n    return null ;\n}\n\nconst row = lookupRegister(msg.topic)\nif (row)\n{   \n    msg.address = row.Address;\n    msg.writeThrough = true ;\n    msg.modbusRow = row ;\n    node.status({ fill: \"green\", shape: \"dot\", text: `${msg.topic} ${msg.address} ${msg.payload}` });\n    return msg  ;\n}\nelse\n{\n    node.status({ fill: \"red\", shape: \"dot\", text: `unmatched command: ${msg.topic}` });\n    return null ;\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 260,
        "wires": [
            [
                "657e75936deb6112"
            ]
        ]
    },
    {
        "id": "0b3d1bb1f851d520",
        "type": "delay",
        "z": "d6d8802f46b4aa03",
        "name": "refresh in 500ms",
        "pauseType": "delay",
        "timeout": "500",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 390,
        "y": 400,
        "wires": [
            [
                "f176f6507293d547"
            ]
        ]
    },
    {
        "id": "ea336da82fe8e44a",
        "type": "inject",
        "z": "d6d8802f46b4aa03",
        "name": "set PUMPCONF_w_dt_spt",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "writeThrough",
                "v": "True",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "PUMPCONF_w_dt_spt",
        "payload": "5.0",
        "payloadType": "num",
        "x": 170,
        "y": 360,
        "wires": [
            [
                "ab26331b697a1a23"
            ]
        ]
    },
    {
        "id": "b3d979820e956933",
        "type": "inject",
        "z": "d6d8802f46b4aa03",
        "name": "modbus writeThrough",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "writeThrough",
                "v": "true",
                "vt": "bool"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "pollAll",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 500,
        "wires": [
            [
                "f176f6507293d547"
            ]
        ]
    },
    {
        "id": "dec62f1238d75d0e",
        "type": "inject",
        "z": "d6d8802f46b4aa03",
        "name": "chill occ on",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "writeThrough",
                "v": "True",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "PROTOCOL_CHIL_OCC",
        "payload": "1",
        "payloadType": "num",
        "x": 120,
        "y": 280,
        "wires": [
            [
                "ab26331b697a1a23"
            ]
        ]
    },
    {
        "id": "be7a26c62fd75ed2",
        "type": "inject",
        "z": "d6d8802f46b4aa03",
        "name": "chill occ off",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "writeThrough",
                "v": "True",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "PROTOCOL_CHIL_OCC",
        "payload": "0",
        "payloadType": "num",
        "x": 120,
        "y": 320,
        "wires": [
            [
                "ab26331b697a1a23"
            ]
        ]
    },
    {
        "id": "13536d367730f4cf",
        "type": "debug",
        "z": "d6d8802f46b4aa03",
        "name": "updates",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 420,
        "wires": []
    },
    {
        "id": "f61b76784c425ebd",
        "type": "link in",
        "z": "d6d8802f46b4aa03",
        "name": "modbus in",
        "links": [
            "e21e2f5c25ffebce",
            "99970d5033f5f26f",
            "bbb9fa50e55242f2",
            "c0fb1b96b917cbc1",
            "34a804b2e0fbddd3"
        ],
        "x": 155,
        "y": 240,
        "wires": [
            [
                "ab26331b697a1a23"
            ]
        ]
    },
    {
        "id": "609c45f169b15f43",
        "type": "function",
        "z": "d6d8802f46b4aa03",
        "name": "calculate ashp0/kWh",
        "func": "\n\n/**\n * This utils code is duplicated\n *\n * ver 1.0\n */\n\nfunction getHHMM(millis) \n{\n  const d = new Date(millis)\n  return d.toTimeString().substring(0, 5)\n}\n\nconst timeNow = Date.now()\n\nconst siteConfig = global.get('site-config') ?? {}\nconst instrumentation = global.get(\"instrumentation\") ?? {}\nconst history = flow.get(\"history\") ?? {}\n\nfunction zeroIntegral(key) \n{\n  //const entry = 'key' in history ? history[key] : { vt: 0, s: timeNow, e: 0, n: -1 }\n  const entry = history[key] ?? { vt: 0, s: timeNow, e: 0, n: -1 }\n\n  entry.s += entry.e    // move the start time to end of last period\n  entry.vt = 0          // zero the integral\n  entry.e  = 0\n  entry.n = 0           // need to be careful about initialising this\n  history[key] = entry\n}\n\nfunction integral(key, value) \n{\n  //const entry = 'key' in history ? history[key] : { vt: 0, s: timeNow, e: 0, n: -1 }\n  const entry = history[key] ?? { vt: 0, s: timeNow, e: 0, n: -1 }\n  // first value ignored, just using timestamp\n  const elapsed = timeNow - entry.s\n\n  entry.vt += value * (elapsed - entry.e)  // integral calculation\n  entry.v = value\n  entry.e = elapsed\n  entry.n += 1\n  history[key] = entry \n\n  const vth = entry.vt / (60 * 60 * 1000)\n\n  //const en = { v: value, vt: vt, s: entry.s, e: elapsed, n: entry.n + 1 }\n\n  const avg = elapsed ? entry.vt / elapsed : 0  // from the start\n\n  const elapsedSecs = Math.floor(elapsed / 1000)\n  if (true)\n    node.status({\n      fill: \"red\", shape: \"dot\",\n      text: `${key} s:${getHHMM(entry.s)} e:${elapsedSecs} ∫:${entry.vt} avg:${avg.toFixed(2)} ∫h:${vth.toFixed(2)}`\n    });\n  return avg\n}\n\n/**\n* @param {NodeMessage} msg\n*/\n\nfunction collectData(msg) {\n  const tokens = msg.topic.split(\"/\")\n  const sensorName = tokens[0]\n  const sensorProperty = tokens[1]\n\n  let m = null\n\n  if ([\"PUMPSTAT_CAPPOWER\", \"zeroCounters\"].includes(sensorProperty)) \n  {\n    switch (sensorProperty) {\n      case \"PUMPSTAT_CAPPOWER\":\n        //node.error('hhh II ' + msg.topic + \" \" + sensorProperty + \" \" + history['ashp0/today/kWh'] ?? 0)\n\n        let avg = integral(\"PUMPSTAT_CAPPOWER\", Number(msg.payload))\n        let elapsedHours = history[\"PUMPSTAT_CAPPOWER\"].e / (1000 * 3600)\n        let kWh = avg * elapsedHours\n        history['ashp0/today/kWh'] = kWh // save to move to yesterday\n        m = {\n          topic: `ashp0/today/kWh`,  // update on each kWh consumed\n          param: 'kWh',\n          prefix : 'local',  \n          payload: Math.floor(kWh),\n          source: 'ashp0',\n          digest: false,\n          track: false\n        }                // send update for each kWh\n        break\n\n      case \"zeroCounters\":\n\n        node.status({ fill: \"yellow\", shape: \"dot\", text: `midnight : counter reset` });\n\n        history['ashp0/yesterday/kWh'] = history['ashp0/today/kWh']\n        zeroIntegral(\"PUMPSTAT_CAPPOWER\")\n\n        m = {\n          topic: `ashp0/yesterday/kWh`,\n          param:    'kWh',\n          prefix : 'local',   \n          payload: Math.floor(history['ashp0/yesterday/kWh']),\n          source: 'ashp0',\n          digest: false,\n          track: false\n        }\n        break\n    }\n  }\n  return m\n}\n\n\nlet m = collectData(msg)\nflow.set(\"history\", history)\n//node.error(\"exiting dump history\" + JSON.stringify(history));\n\nreturn m\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\nflow.set(\"history\", null); ",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 740,
        "wires": [
            [
                "298f4d77b929e02a",
                "e772664fcac34660"
            ]
        ]
    },
    {
        "id": "4557c30c95706d62",
        "type": "link in",
        "z": "d6d8802f46b4aa03",
        "name": "link in 1",
        "links": [
            "2384d6ea06ea6969"
        ],
        "x": 165,
        "y": 760,
        "wires": [
            [
                "609c45f169b15f43"
            ]
        ]
    },
    {
        "id": "870589deb20f8277",
        "type": "inject",
        "z": "d6d8802f46b4aa03",
        "name": "5000 kW",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "digest",
                "v": "false",
                "vt": "bool"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "asph0/PUMPSTAT_CAPPOWER",
        "payload": "5000",
        "payloadType": "num",
        "x": 120,
        "y": 720,
        "wires": [
            [
                "609c45f169b15f43"
            ]
        ]
    },
    {
        "id": "8f787230d433976a",
        "type": "inject",
        "z": "d6d8802f46b4aa03",
        "name": "midnight",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "history/zeroCounters",
        "payload": "false",
        "payloadType": "bool",
        "x": 120,
        "y": 680,
        "wires": [
            [
                "609c45f169b15f43"
            ]
        ]
    },
    {
        "id": "e772664fcac34660",
        "type": "debug",
        "z": "d6d8802f46b4aa03",
        "name": "energy",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 810,
        "y": 740,
        "wires": []
    },
    {
        "id": "3434c59de55e09c4",
        "type": "debug",
        "z": "d6d8802f46b4aa03",
        "name": "debug 38",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 260,
        "wires": []
    },
    {
        "id": "386b7342a4aa0590",
        "type": "comment",
        "z": "d6d8802f46b4aa03",
        "name": "Nodes below are similar to those on lae0",
        "info": "",
        "x": 200,
        "y": 180,
        "wires": []
    },
    {
        "id": "847984e402e1ba84",
        "type": "comment",
        "z": "d6d8802f46b4aa03",
        "name": "modbus interface to ASHP over ethernet",
        "info": "",
        "x": 190,
        "y": 20,
        "wires": []
    },
    {
        "id": "3b37161a0c61f52e",
        "type": "function",
        "z": "86219b48706129b6",
        "name": "downsample",
        "func": "/** rework so it operates on all fields in the payload */\n\nfunction toFix(num, precision) //x\n{\n    return (Math.trunc(num * (10 ** precision)))/ (10 ** precision) ;\n}\n\nconst isSet = (o, prop) => Object.hasOwn(o,prop) ? o[prop] : false\n\nconst store0 = {\n    payload: 0.0,\n    lastPayload : 0.0, \n    avg : 0.0,\n    lastAvg : 0.0,\n    numSamples: 0,\n    beginTransition: true\n}\n\nfunction deliver(msg)\n{\n    let store = context.get(msg.topic) ?? store0 ;\n    if ((msg.writeThrough == false) && (store.payload == msg.payload))\n        return null ;\n                    // red : digest, yellow : update, green : writeThrough    \n\n    let colour = msg.writeThrough ? 'green' : 'yellow' ;    \n    node.status({ fill: colour, shape: \"dot\", text: `${msg.topic} ${store.payload}=>${msg.payload}`});\n    store.payload = msg.payload ;\n    context.set(msg.topic, msg);  \n    return msg ;  \n}\n// ver 1.0 checked 22-09-2024\n\nfunction digest(msg) {\n\n    if (msg.reportOnDiff === undefined)\n        msg.reportOnDiff = 1 ; \n    if (msg.windowSize === undefined)\n        msg.windowSize = 10 ;   // arbitrary number\n\n    let store = context.get(msg.topic);\n    if (store === undefined)\n        store = store0;\n\n    const beginTransition = store.beginTransition;\n    store.beginTransition = false;\n\n    const valueDiff = store.numSamples ? Math.abs(msg.payload - store.lastAvg) : 0.0;\n    const percentageDiff = store.numSamples ? (msg.payload - store.lastAvg) * 100 * 2 / (msg.payload + store.lastAvg) : 0.0;\n\n    const endTransition = msg.writeThrough\n                || (valueDiff >= msg.reportOnDiff) \n                || (store.numSamples + 1 >= msg.windowSize);  // write every maxGap  \n    const outputAvg = beginTransition || endTransition;\n\n    store.payload = msg.lastPayload = msg.payload;\n    store.avg = (store.avg * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct? \n    store.avg = toFix(store.avg, 2);\n    store.numSamples += 1;\n    msg.numSamples = store.numSamples;\n\n    if (isSet(msg,'track') || endTransition) \n    {\n        const colour = msg.endTransition ? 'red' : 'yellow'\n        node.status({ fill: colour, shape: \"dot\", text: `${msg.topic} ${msg.payload}  avg:${store.avg} num:${store.numSamples} `});\n    }\n    /*\n    node.log(`${msg.topic} ${msg.lastPayload} avg: ${store.avg.toFixed(2)}, `\n        + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n        + `bt ${beginTransition} et ${ endTransition }`);\n    */\n    if (outputAvg) {\n        msg.payload = store.avg;\n        store.numSamples = 0;\n        if (endTransition)\n        {\n            store.lastAvg = store.avg;\n            store.beginTransition = true;\n        }\n    }\n\n    context.set(msg.topic, store);\n    return outputAvg ? msg : null;\n}\n\nconst m = msg.digest ?  digest(msg) : deliver(msg);\n\nreturn [[m], [m && isSet(m,'track') ? m : null] ]",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 120,
        "wires": [
            [
                "865beee985e6a55d"
            ],
            [
                "93bacd1ce9ca8fba"
            ]
        ]
    },
    {
        "id": "865beee985e6a55d",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "out",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 100,
        "wires": []
    },
    {
        "id": "93bacd1ce9ca8fba",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "track",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 160,
        "wires": []
    },
    {
        "id": "69b77321f6113b9f",
        "type": "inject",
        "z": "86219b48706129b6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abcd",
        "payload": "34",
        "payloadType": "num",
        "x": 110,
        "y": 100,
        "wires": [
            [
                "06a47b37c2fd940d"
            ]
        ]
    },
    {
        "id": "1bb81c233ce3a8b6",
        "type": "inject",
        "z": "86219b48706129b6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abcd",
        "payload": "35",
        "payloadType": "num",
        "x": 110,
        "y": 160,
        "wires": [
            [
                "06a47b37c2fd940d"
            ]
        ]
    },
    {
        "id": "65f42e329be02b58",
        "type": "inject",
        "z": "86219b48706129b6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abcd",
        "payload": "36.5",
        "payloadType": "num",
        "x": 120,
        "y": 220,
        "wires": [
            [
                "06a47b37c2fd940d"
            ]
        ]
    },
    {
        "id": "1878a92275748032",
        "type": "inject",
        "z": "86219b48706129b6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abcd",
        "payload": "37",
        "payloadType": "num",
        "x": 110,
        "y": 280,
        "wires": [
            [
                "06a47b37c2fd940d"
            ]
        ]
    },
    {
        "id": "c8019270b037639a",
        "type": "function",
        "z": "86219b48706129b6",
        "name": "function 2",
        "func": "\nmsg.digest = true\nmsg.windowSize = 5\nmsg.track = false\n\n//msg.payload = Math.sin(msg.payload * Math.PI/180);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 180,
        "wires": [
            [
                "c0b60c146d9ecc83"
            ]
        ]
    },
    {
        "id": "477f87789ab83554",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "out",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 730,
        "y": 520,
        "wires": []
    },
    {
        "id": "0d528e3d620c68e8",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "pre track",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 220,
        "wires": []
    },
    {
        "id": "83d67b410208bcad",
        "type": "catch",
        "z": "86219b48706129b6",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 380,
        "y": 660,
        "wires": [
            [
                "b16ed38bfb85904b"
            ]
        ]
    },
    {
        "id": "b16ed38bfb85904b",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "stacktrace",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 610,
        "y": 660,
        "wires": []
    },
    {
        "id": "c0b60c146d9ecc83",
        "type": "function",
        "z": "86219b48706129b6",
        "name": "downsample2 rc3",
        "func": "/** rework so it operates on all fields in the payload */\n\nconst utils = global.get(\"utils\");\n\nconst isSet = (o, prop) => Object.hasOwn(o,prop) ? o[prop] : false\n\nconst msgsOut = []\n\nfunction deliverUpdates(msg, store)   // needs windows\n{\n    store.mode = 'updates'\n    msg.windowSize ??= 10   // arbitrary number\n\n    if ((msg.writeThrough ?? false) == false && store.lastMsg && msg.payload == store.lastMsg.payload )\n        return null ;\n\n    // msg.payload has changed                \n\n    // red : digest, yellow : update, green : writeThrough    \n    let colour = msg.writeThrough ? 'green' : 'yellow' ; \n    \n    const oldVal =  store.lastMsg ? `${store.lastMsg.payload}=>` : \"\"\n    const logText = `${msg.topic} ${oldVal}${msg.payload}`   \n    node.status({ fill: colour, shape: \"dot\", text: `${logText}` });\n    msgsOut.push(msg)\n    return msg ;  \n}\n\n// ver 1.1 22-Mar-2025\n\nfunction digest(msg, store) \n{\n    msg.reportOnDiff ??= null \n    msg.windowSize ??= 10   // arbitrary number\n\n    //const beginTransition = store.beginTransition; \n    //store.beginTransition = false;\n\n    const valueDiff = store.numSamples ? Math.abs(msg.payload - store.lastAvg) : 0.0;\n    const percentageDiff = store.numSamples ? (msg.payload - store.lastAvg) * 100 * 2 / (msg.payload + store.lastAvg) : 0.0;\n    const valueChange = valueDiff >= msg.reportOnDiff     \n\n    const endTransition = (msg.passThrough ?? false)\n                || (valueChange) \n                || (store.numSamples + 1 >= msg.windowSize);  // write every maxGap  \n\n    // store.payload = msg.lastPayload = msg.payload;\n    // store.lastMsg = msg \n    store.avg = (store.avg * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct? \n    store.avg = utils.toFix(store.avg, 2);\n    store.numSamples += 1;\n    msg.numSamples = store.numSamples;\n\n    if (isSet(msg,'track') || endTransition) \n    {\n        const colour = msg.endTransition ? 'red' : 'yellow'\n        node.status({ fill: colour, shape: \"dot\", text: `${msg.topic} ${msg.payload}  avg:${store.avg} num:${store.numSamples}`});\n    }\n    /*\n    node.log(`${msg.topic} ${msg.lastPayload} avg: ${store.avg.toFixed(2)}, `\n        + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n        + `bt ${beginTransition} et ${ endTransition }`);\n    */\n    if (endTransition) {\n        msg.payload = store.avg;\n        store.numSamples = 0;   // no need to zero avg\n        msgsOut.push(msg)\n    }\n}\n\nconst store0 = {\n    mode : null,\n    avg : 0.0,\n    numSamples: 0,\n}\n\n\nlet store = context.get(msg.topic) ?? store0 ;\nif (msg.passThrough ?? false) \n    store = store0 \n//const m = msg.digest ?  digest(msg, store) :  deliverUpdates(msg, store);\nconst mout = digest(msg, store)\nstore.lastMsg = msg ;\ncontext.set(msg.topic, store);  \n\n// tracking pre and post handling\nreturn [[msg && isSet(msg,'track') ? msg : null],\n         msgsOut, \n        [mout && isSet(mout,'track') ? mout : null] ]",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 440,
        "wires": [
            [],
            [
                "a41d7f8ad8e68b4a",
                "422c909b6fd66afc"
            ],
            []
        ]
    },
    {
        "id": "72fe5e49a440e375",
        "type": "function",
        "z": "86219b48706129b6",
        "name": "downsample2",
        "func": "/** rework so it operates on all fields in the payload */\n\nconst utils = global.get(\"utils\");\n\nconst isSet = (o, prop) => Object.hasOwn(o,prop) ? o[prop] : false\n\nfunction deliver(msg, store)\n{\n    store.mode = 'deliverOnChange'\n    if ((msg.writeThrough ?? false) == false && store.lastMsg && msg.payload == store.lastMsg.payload )\n        return null ;\n\n    // msg.payload has changed                \n\n    // red : digest, yellow : update, green : writeThrough    \n    let colour = msg.writeThrough ? 'green' : 'yellow' ; \n    \n    const oldVal =  store.lastMsg ? `${store.lastMsg.payload}=>` : \"\"\n    const logText = `${msg.topic} ${oldVal}${msg.payload}`   \n    node.status({ fill: colour, shape: \"dot\", text: `${logText}` });\n\n    return msg ;  \n}\n// ver 1.0 checked 22-09-2024\n\nfunction digest(msg, store) {\n    store.mode = 'digest'\n    msg.reportOnDiff ??= 1\n    msg.windowSize ??= 10   // arbitrary number\n\n    const valueDiff = store.numSamples ? Math.abs(msg.payload - store.lastAvg) : 0.0;\n    const percentageDiff = store.numSamples ? (msg.payload - store.lastAvg) * 100 * 2 / (msg.payload + store.lastAvg) : 0.0;\n\n    const endTransition = (msg.writeThrough ?? false)\n                || (valueDiff >= msg.reportOnDiff) \n                || (store.numSamples + 1 >= msg.windowSize);  // write every maxGap  \n    const outputAvg = endTransition;\n\n    store.payload = msg.lastPayload = msg.payload;\n    store.avg = (store.avg * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct? \n    store.avg = utils.toFix(store.avg, 2);\n    store.numSamples += 1;\n    msg.numSamples = store.numSamples;\n\n    if (isSet(msg,'track') || endTransition) \n    {\n        const colour = msg.endTransition ? 'red' : 'yellow'\n        node.status({ fill: colour, shape: \"dot\", text: `${msg.topic} ${msg.payload}  avg:${store.avg} num:${store.numSamples} `});\n    }\n    /*\n    node.log(`${msg.topic} ${msg.lastPayload} avg: ${store.avg.toFixed(2)}, `\n        + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n        + `bt ${beginTransition} et ${ endTransition }`);\n    */\n    if (outputAvg) {\n        msg.payload = store.avg;\n        store.numSamples = 0;\n        if (endTransition)\n        {\n            store.lastAvg = store.avg;\n        }\n    }\n    context.set(msg.topic, store);\n    return outputAvg ? msg : null;\n}\n\nconst store0 = {\n    mode : null,\n    lastMsg: null, \n    payload: 0.0,\n    lastPayload : 0.0, \n    avg : 0.0,\n    lastAvg : 0.0,\n    numSamples: 0,\n    beginTransition: true\n}\n\nlet store = context.get(msg.topic) ?? store0 ;\nconst m = msg.digest ?  digest(msg, store) :  deliver(msg, store);\nstore.lastMsg = msg ;\ncontext.set(msg.topic, store);  \n\n// tracking pre and post handling\nreturn [[msg && isSet(msg,'track') ? m : null], [m], [m && isSet(m,'track') ? m : null] ]",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 740,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "fa1228affdf7153f",
        "type": "function",
        "z": "86219b48706129b6",
        "name": "staircase",
        "func": "\nmsg.digest = true\nmsg.windowSize = 5\nmsg.track = false\nmsg.reportOnDiff = .1\n\n//msg.payload = Math.sin(msg.payload * Math.PI/180);\n\n\nlet values  = [0, 1, 2, 3, 4, 5 ,6, 7, 8, 9, 11, 12 ]\nvalues  =     [1.2, 1.4, 3, 3.2, 3.3 ,6, 7, 8, 9, 11, 12 ]\n\n\n// send n + 1 messages for n blocks \n\nconst testLen = 11\nlet msgs = [] \nfor (let i = 0; i < testLen ; i++) \n{\n  msg = {}\n  msg.topic = 'mytopic'\n  msg.reportOnDiff = 1\n  msg.windowSize = 5\n  msg.track = false \n  msg.payload = 2\n  msg.timestamp = i \n  msgs.push(msg) \n}\n\nmsgs[0].passThrough = true \nif (msgs.length > 8) \n{  \n  msgs[4].payload = 6.4 \n  msgs[5].payload = 6.5\n}\n\nmsgs[msgs.length-1].passThrough = true \n//msgs[msgs.length-1].payload = 2 \n\nlet sum = 0 \n\nfor (let i = 1; i < testLen ; i++) \n  sum += msgs[i].payload \n\nconst avg = sum / (msgs.length - 1)\nnode.status({ fill: 'red', shape: \"dot\", text: `avg:${avg} count:${msgs.length-1}`});\n\n\nreturn [msgs]",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 180,
        "y": 440,
        "wires": [
            [
                "c0b60c146d9ecc83",
                "2ce4fc79bd43961e"
            ]
        ]
    },
    {
        "id": "928a53fe18eba879",
        "type": "inject",
        "z": "86219b48706129b6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abc",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 340,
        "wires": [
            [
                "fa1228affdf7153f"
            ]
        ]
    },
    {
        "id": "a685031f5c6a0cf0",
        "type": "function",
        "z": "86219b48706129b6",
        "name": "downsample2 rc1",
        "func": "/** rework so it operates on all fields in the payload */\n\nconst utils = global.get(\"utils\");\n\nconst isSet = (o, prop) => Object.hasOwn(o,prop) ? o[prop] : false\n\nconst msgsOut = []\n\nfunction deliverUpdates(msg, store)   // needs windows\n{\n    store.mode = 'updates'\n    msg.windowSize ??= 10   // arbitrary number\n\n    if ((msg.writeThrough ?? false) == false && store.lastMsg && msg.payload == store.lastMsg.payload )\n        return null ;\n\n    // msg.payload has changed                \n\n    // red : digest, yellow : update, green : writeThrough    \n    let colour = msg.writeThrough ? 'green' : 'yellow' ; \n    \n    const oldVal =  store.lastMsg ? `${store.lastMsg.payload}=>` : \"\"\n    const logText = `${msg.topic} ${oldVal}${msg.payload}`   \n    node.status({ fill: colour, shape: \"dot\", text: `${logText}` });\n    msgsOut.push(msg)\n    return msg ;  \n}\n// ver 1.0 checked 22-09-2024\n\nfunction digestOld(msg, store) \n{\n    store.mode = 'digest'\n    msg.reportOnDiff ??= 1\n    msg.windowSize ??= 10   // arbitrary number\n\n    const beginTransition = store.beginTransition;\n    store.beginTransition = false;\n\n    const valueDiff = store.numSamples ? Math.abs(msg.payload - store.lastAvg) : 0.0;\n    const percentageDiff = store.numSamples ? (msg.payload - store.lastAvg) * 100 * 2 / (msg.payload + store.lastAvg) : 0.0;\n    const valueChange = valueDiff >= msg.reportOnDiff     \n    const endTransition = (msg.writeThrough ?? false)\n                || (valueChange) \n                || (store.numSamples + 1 >= msg.windowSize);  // write every maxGap  \n    const outputAvg = beginTransition || endTransition;\n\n    store.payload = msg.lastPayload = msg.payload;\n    store.avg = (store.avg * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct? \n    store.avg = utils.toFix(store.avg, 2);\n    store.numSamples += 1;\n    msg.numSamples = store.numSamples;\n\n    if (isSet(msg,'track') || endTransition) \n    {\n        const colour = msg.endTransition ? 'red' : 'yellow'\n        node.status({ fill: colour, shape: \"dot\", text: `${msg.topic} ${msg.payload}  avg:${store.avg} num:${store.numSamples} `});\n    }\n    /*\n    node.log(`${msg.topic} ${msg.lastPayload} avg: ${store.avg.toFixed(2)}, `\n        + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n        + `bt ${beginTransition} et ${ endTransition }`);\n    */\n    if (outputAvg) {\n        msg.payload = store.avg;\n        store.numSamples = 0;\n        if (endTransition)\n        {\n            store.lastAvg = store.avg;\n            store.beginTransition = true;\n        }\n    }\n    return outputAvg ? msg : null;\n}\n\n// ver 1.1 22-Mar-2025\n\nfunction digest(msg, store) \n{\n    store.mode = 'digest'\n    msg.reportOnDiff ??= 1\n    msg.windowSize ??= 10   // arbitrary number\n\n    //const beginTransition = store.beginTransition; //\n    //store.beginTransition = false;\n\n    const valueDiff = store.numSamples ? Math.abs(msg.payload - store.lastAvg) : 0.0;\n    const percentageDiff = store.numSamples ? (msg.payload - store.lastAvg) * 100 * 2 / (msg.payload + store.lastAvg) : 0.0;\n    const valueChange = valueDiff >= msg.reportOnDiff     \n\n    const endTransition = (msg.writeThrough ?? false)\n                || (valueChange) \n                || (store.numSamples + 1 >= msg.windowSize);  // write every maxGap  \n\n//    store.payload = msg.lastPayload = msg.payload;\n    store.lastMsg = msg \n    store.avg = (store.avg * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct? \n    store.avg = utils.toFix(store.avg, 2);\n    store.numSamples += 1;\n    msg.numSamples = store.numSamples;\n\n    if (isSet(msg,'track') || endTransition) \n    {\n        const colour = msg.endTransition ? 'red' : 'yellow'\n        node.status({ fill: colour, shape: \"dot\", text: `${msg.topic} ${msg.payload}  avg:${store.avg} num:${store.numSamples} `});\n    }\n    /*\n    node.log(`${msg.topic} ${msg.lastPayload} avg: ${store.avg.toFixed(2)}, `\n        + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n        + `bt ${beginTransition} et ${ endTransition }`);\n    */\n    if (endTransition) {\n        msg.payload = store.avg;\n        store.numSamples = 0;\n        msgsOut.push(msg)\n    }\n}\n\nconst store0 = {\n    mode : null,\n    lastMsg: null, \n    payload: 0.0,\n    lastPayload : 0.0, \n    avg : 0.0,\n    lastAvg : 0.0,\n    numSamples: 0,\n    beginTransition: true\n}\n\nconst store = context.get(msg.topic) ?? store0 ;\nconst m = msg.digest ?  digest(msg, store) :  deliverUpdates(msg, store);\nstore.lastMsg = msg ;\ncontext.set(msg.topic, store);  \n\n// tracking pre and post handling\nreturn [[msg && isSet(msg,'track') ? m : null], msgsOut, [m && isSet(m,'track') ? m : null] ]",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 740,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "ae0986fd35031017",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "in",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 210,
        "y": 600,
        "wires": []
    },
    {
        "id": "a41d7f8ad8e68b4a",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "debug 28",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 380,
        "wires": []
    },
    {
        "id": "2ce4fc79bd43961e",
        "type": "function",
        "z": "86219b48706129b6",
        "name": "avg",
        "func": "\n\nconst init = { sum: 0, count: 0, avg : null, laststamp: 0, totalTime : 0 }\nconst utils = global.get('utils') \nlet data = context.get('data') ?? init \n\n\n//data.sum = 0\nconst tim = msg.timestamp - data.laststamp\nconst val = msg.payload * tim\n\nif (isFinite(val)) \n{\n  data.sum += val \n  data.totalTime += tim\n}\n//  node.error(\"data\" + data);\ndata.laststamp = msg.timestamp \ndata.count = msg.timestamp\n// node.error(\"ts  \" + msg.timestamp); \n\nlet avg =  data.sum / data.totalTime\navg = utils.toFix(avg,3)\nlet sum = utils.toFix(data.sum,3)\nconst passThroughText = (msg.passThrough ?? false) ? 'passThrough'  : '' \nconst logText = `time:${data.totalTime} sum:${sum} avg:${avg} count:${data.count}  ${passThroughText}`\nnode.status({ fill: 'red', shape: \"dot\", text: logText});\n\n\n// do this last \n\nif (msg.passThrough ?? false) //\n{\n  data = init\n  node.error(\"passThrough\");\n}\ncontext.set('data', data) \n\nreturn { topic : 'log', payload : logText };\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 360,
        "wires": [
            [
                "f850177f5f9fc893"
            ]
        ]
    },
    {
        "id": "f850177f5f9fc893",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "in",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 340,
        "wires": []
    },
    {
        "id": "422c909b6fd66afc",
        "type": "function",
        "z": "86219b48706129b6",
        "name": "avg",
        "func": "\n\nconst init = { sum: 0, count: 0, avg : null, laststamp: 0, totalTime : 0 }\nconst utils = global.get('utils') \nlet data = context.get('data') ?? init \n\n\n//data.sum = 0\nconst tim = msg.timestamp - data.laststamp\nconst val = msg.payload * tim\n\nif (isFinite(val)) \n{\n  data.sum += val \n  data.totalTime += tim\n}\n//  node.error(\"data\" + data);\ndata.laststamp = msg.timestamp \ndata.count +=1 \n// node.error(\"ts  \" + msg.timestamp); \n\nlet avg =  data.sum / data.totalTime\navg = utils.toFix(avg,3)\nlet sum = utils.toFix(data.sum,3)\nconst passThroughText = (msg.passThrough ?? false) ? 'passThrough'  : '' \nconst logText = `time:${data.totalTime} sum:${sum} avg:${avg} count:${data.count}  ${passThroughText}`\nnode.status({ fill: 'red', shape: \"dot\", text: logText});\n\n\n// do this last \n\nif (msg.passThrough ?? false) //\n{\n  data = init\n  node.error(\"passThrough\");\n}\ncontext.set('data', data) \n\nreturn { topic : 'log', payload : logText };\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 520,
        "wires": [
            [
                "477f87789ab83554"
            ]
        ]
    },
    {
        "id": "209a8d0ec2aeba4c",
        "type": "inject",
        "z": "86219b48706129b6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abd",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 900,
        "wires": [
            [
                "df6b66fbd823a040"
            ]
        ]
    },
    {
        "id": "8e5f79ca7abfa82d",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "debug 21",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 900,
        "wires": []
    },
    {
        "id": "ef177c6ffb7fe10c",
        "type": "inject",
        "z": "86219b48706129b6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "defd",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 960,
        "wires": [
            [
                "df6b66fbd823a040"
            ]
        ]
    },
    {
        "id": "516a889022170a8b",
        "type": "debug",
        "z": "86219b48706129b6",
        "name": "debug 22",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 960,
        "wires": []
    },
    {
        "id": "df6b66fbd823a040",
        "type": "delay-topic-message",
        "z": "86219b48706129b6",
        "delay": 5,
        "x": 360,
        "y": 900,
        "wires": [
            [
                "8e5f79ca7abfa82d",
                "516a889022170a8b"
            ]
        ]
    },
    {
        "id": "2bde12ee3402add0",
        "type": "comment",
        "z": "86219b48706129b6",
        "name": "Test out delay functions",
        "info": "",
        "x": 160,
        "y": 840,
        "wires": []
    },
    {
        "id": "dda1bcaa405b6302",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "delay",
                "v": "1",
                "vt": "num"
            },
            {
                "p": "digest",
                "v": "true",
                "vt": "bool"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "aa",
        "payload": "909",
        "payloadType": "num",
        "x": 120,
        "y": 160,
        "wires": [
            [
                "81578ee3d71ff690"
            ]
        ]
    },
    {
        "id": "a50dab5414a242a0",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "reset",
                "v": "true",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "*/1 0 * * *",
        "once": true,
        "onceDelay": 0.1,
        "topic": "bb",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 240,
        "wires": [
            [
                "81578ee3d71ff690"
            ]
        ]
    },
    {
        "id": "2270be49ad12dc1b",
        "type": "delay",
        "z": "983d8c26bcee7442",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 400,
        "y": 40,
        "wires": [
            [
                "4b062ed9f476fd2d"
            ]
        ]
    },
    {
        "id": "4b062ed9f476fd2d",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "debug 39",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 40,
        "wires": []
    },
    {
        "id": "36f61a65e8c1ea04",
        "type": "delay-topic-message",
        "z": "983d8c26bcee7442",
        "delay": "2",
        "x": 400,
        "y": 160,
        "wires": [
            [
                "d4bc151f5e5bf4cb"
            ]
        ]
    },
    {
        "id": "d4bc151f5e5bf4cb",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "debug 40",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 160,
        "wires": []
    },
    {
        "id": "58e920283b9c4b45",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "stop",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "stopTimer",
                "v": "true",
                "vt": "bool"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "mytimer",
        "payload": "hello",
        "payloadType": "str",
        "x": 110,
        "y": 60,
        "wires": [
            [
                "81578ee3d71ff690"
            ]
        ]
    },
    {
        "id": "ed1964d4c490ee37",
        "type": "rbe",
        "z": "983d8c26bcee7442",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "b9bc7f2454dab9fa",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "debug 41",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 340,
        "wires": []
    },
    {
        "id": "a4a6ba226ad8eb31",
        "type": "smooth",
        "z": "983d8c26bcee7442",
        "name": "",
        "property": "payload",
        "action": "mean",
        "count": "10",
        "round": "",
        "mult": "multi",
        "reduce": true,
        "x": 400,
        "y": 340,
        "wires": [
            [
                "b9bc7f2454dab9fa"
            ]
        ]
    },
    {
        "id": "51ccb3f116b94f39",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "different value",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 760,
        "y": 640,
        "wires": []
    },
    {
        "id": "30c09a383fd51811",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "delay",
                "v": "1",
                "vt": "num"
            },
            {
                "p": "digest",
                "v": "true",
                "vt": "bool"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "aa",
        "payload": "802",
        "payloadType": "num",
        "x": 120,
        "y": 200,
        "wires": [
            [
                "81578ee3d71ff690"
            ]
        ]
    },
    {
        "id": "9fd29026ae963087",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "debug 45",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 650,
        "y": 260,
        "wires": []
    },
    {
        "id": "770592a223143e5e",
        "type": "function",
        "z": "983d8c26bcee7442",
        "name": "condition values",
        "func": "\nconst sinValues1 = [];\nconst sinValues2 = [];\nconst sinValues3 = [];\nconst sinValues4 = [];\n\nconst sin = msg.payload ;\n\nif (true)\n{    \n    const m = Object.assign(RED.util.cloneMessage(msg), { topic : 'chart1' })\n    sinValues1.push(m);\n\n    const n = Object.assign(RED.util.cloneMessage(msg), { topic: 'chart2', writeThrough : true} )\n    sinValues2.push(n);\n\n    const o = Object.assign(RED.util.cloneMessage(msg), { topic: 'chart3', reportOnDiff : 20, windowSize : 40, digest : true  } )\n    sinValues3.push(o);\n\n    const p = Object.assign(RED.util.cloneMessage(msg), { topic: 'chart4', reportOnDiff: 20, windowSize: 40, digest: true })\n    sinValues4.push(p);\n\n}\nreturn [sinValues1, sinValues2, sinValues3, sinValues4]",
        "outputs": 4,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 640,
        "wires": [
            [
                "6ecc7e7ed071b831",
                "c1262b68c409abc8"
            ],
            [
                "9ae93c7f4cfe45f8"
            ],
            [
                "1dda97c7e4b32cda"
            ],
            []
        ]
    },
    {
        "id": "767f50d1619e4881",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abc",
        "payload": "34",
        "payloadType": "num",
        "x": 210,
        "y": 440,
        "wires": [
            [
                "e8d6d6d3535850e7"
            ]
        ]
    },
    {
        "id": "688b6a566c772c52",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "write through - every value",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 720,
        "wires": []
    },
    {
        "id": "1503c29336ccab3b",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "digest",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 730,
        "y": 800,
        "wires": []
    },
    {
        "id": "f2de1d4ab52a9038",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "30.4 10 secs",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "windowPeriodSecs",
                "v": "10",
                "vt": "num"
            },
            {
                "p": "windowSize",
                "v": "5000",
                "vt": "num"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "fixNumber",
        "payload": "30.4",
        "payloadType": "num",
        "x": 170,
        "y": 860,
        "wires": [
            [
                "6a477d7286614dd4"
            ]
        ]
    },
    {
        "id": "e8d6d6d3535850e7",
        "type": "function",
        "z": "983d8c26bcee7442",
        "name": "generate sin value",
        "func": "\nconst sinValues = [];\n\nconst degreesToRadians = Math.PI / 180;\n\n// Loop from 0 to 180 degrees, incrementing by 10\nfor (let degrees = 0; degrees <= 360; degrees += 10) {\n    // 1. Convert degrees to radians\n    const radians = degrees * degreesToRadians;\n\n    // 2. Calculate the sine value\n    const sin = 100 * Math.sin(radians);\n\n    // 3. Add the sine value to the array\n\n    const m = Object.assign (RED.util.cloneMessage(msg), { payload : sin, degrees : degrees })\n    sinValues.push(m);\n}\n\nreturn [sinValues]",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 500,
        "wires": [
            [
                "8e63039e93edd284"
            ]
        ]
    },
    {
        "id": "c1262b68c409abc8",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "input",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 690,
        "y": 560,
        "wires": []
    },
    {
        "id": "6ecc7e7ed071b831",
        "type": "subflow:9e36a25803eb28ab",
        "z": "983d8c26bcee7442",
        "name": "",
        "x": 550,
        "y": 640,
        "wires": [
            [
                "51ccb3f116b94f39"
            ],
            [],
            []
        ]
    },
    {
        "id": "9ae93c7f4cfe45f8",
        "type": "subflow:9e36a25803eb28ab",
        "z": "983d8c26bcee7442",
        "name": "",
        "x": 550,
        "y": 720,
        "wires": [
            [
                "688b6a566c772c52"
            ],
            [],
            []
        ]
    },
    {
        "id": "1dda97c7e4b32cda",
        "type": "subflow:9e36a25803eb28ab",
        "z": "983d8c26bcee7442",
        "name": "",
        "x": 550,
        "y": 800,
        "wires": [
            [
                "1503c29336ccab3b",
                "11ac0d580ca4dfb5"
            ],
            [],
            []
        ]
    },
    {
        "id": "8a82a2da8519a96d",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "28.4 10 secs",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "windowPeriodSecs",
                "v": "10",
                "vt": "num"
            },
            {
                "p": "windowSize",
                "v": "5000",
                "vt": "num"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "fixNumber",
        "payload": "28.4",
        "payloadType": "num",
        "x": 170,
        "y": 820,
        "wires": [
            [
                "6a477d7286614dd4"
            ]
        ]
    },
    {
        "id": "50ab5a63b66d45a1",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "digest v2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 900,
        "wires": []
    },
    {
        "id": "ac8fa65188c8967c",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "reset",
                "v": "true",
                "vt": "bool"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abc",
        "payload": "0",
        "payloadType": "num",
        "x": 150,
        "y": 560,
        "wires": [
            [
                "770592a223143e5e"
            ]
        ]
    },
    {
        "id": "2ac9962afa568f4e",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "abc 34 (10s)",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "windowPeriod",
                "v": "10000",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abc",
        "payload": "34",
        "payloadType": "num",
        "x": 170,
        "y": 500,
        "wires": [
            [
                "e8d6d6d3535850e7"
            ]
        ]
    },
    {
        "id": "dd66140fd055bfae",
        "type": "debug",
        "z": "983d8c26bcee7442",
        "name": "sin value",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 650,
        "y": 500,
        "wires": []
    },
    {
        "id": "6eb99ebc13513c64",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "30.4 win 10",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "windowSize",
                "v": "10",
                "vt": "num"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "fixNumber",
        "payload": "30.4",
        "payloadType": "num",
        "x": 170,
        "y": 760,
        "wires": [
            [
                "6a477d7286614dd4"
            ]
        ]
    },
    {
        "id": "959ab326681db156",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "18.4 win 10",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            },
            {
                "p": "windowSize",
                "v": "10",
                "vt": "num"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "fixNumber",
        "payload": "18.4",
        "payloadType": "num",
        "x": 170,
        "y": 720,
        "wires": [
            [
                "6a477d7286614dd4"
            ]
        ]
    },
    {
        "id": "11ac0d580ca4dfb5",
        "type": "ui-chart",
        "z": "983d8c26bcee7442",
        "group": "9ee3507d7e391438",
        "name": "",
        "label": "chart",
        "order": 1,
        "chartType": "line",
        "category": "topic",
        "categoryType": "msg",
        "xAxisLabel": "degrees",
        "xAxisProperty": "degrees",
        "xAxisPropertyType": "msg",
        "xAxisType": "linear",
        "xAxisFormat": "",
        "xAxisFormatType": "auto",
        "xmin": "",
        "xmax": "",
        "yAxisLabel": "sin",
        "yAxisProperty": "payload",
        "yAxisPropertyType": "msg",
        "ymin": "",
        "ymax": "",
        "bins": 10,
        "action": "append",
        "stackSeries": false,
        "pointShape": "circle",
        "pointRadius": 4,
        "showLegend": true,
        "removeOlder": "10",
        "removeOlderUnit": "60",
        "removeOlderPoints": "100",
        "colors": [
            "#0095ff",
            "#ff0000",
            "#ff7f0e",
            "#2ca02c",
            "#a347e1",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "textColor": [
            "#666666"
        ],
        "textColorDefault": true,
        "gridColor": [
            "#e5e5e5"
        ],
        "gridColorDefault": true,
        "width": "12",
        "height": "8",
        "className": "",
        "interpolation": "linear",
        "x": 730,
        "y": 1040,
        "wires": [
            []
        ]
    },
    {
        "id": "e8cf998e289eb1ec",
        "type": "function",
        "z": "983d8c26bcee7442",
        "name": "clear",
        "func": "\nreturn { action : 'replace',  payload : { x: 10, y: 15} };\n//return msg ",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 1040,
        "wires": [
            [
                "11ac0d580ca4dfb5"
            ]
        ]
    },
    {
        "id": "5557309ac32e317c",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 300,
        "y": 1040,
        "wires": [
            [
                "e8cf998e289eb1ec"
            ]
        ]
    },
    {
        "id": "808761aa522cee4b",
        "type": "function",
        "z": "983d8c26bcee7442",
        "name": "generate square value",
        "func": "\nconst sinValues = [];\n\n\nconst degreesToRadians = Math.PI / 180;\n\n// Loop from 0 to 180 degrees, incrementing by 10\nfor (let degrees = 0; degrees <= 360; degrees += 10) {\n    // 1. Convert degrees to radians\n    const radians = degrees * degreesToRadians;\n\n    // 2. Calculate the sine value\n    const sin = 100 * Math.sin(radians);\n\n    let square = sin > 70 ? 100 : 0 ;\n    square  =    sin < -70 ? -100 : square ;\n\n    // 3. Add the sine value to the array\n\n    const m = Object.assign (RED.util.cloneMessage(msg), { payload : square, degrees : degrees })\n    sinValues.push(m);\n}\n\nreturn [sinValues]",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 420,
        "wires": [
            [
                "8e63039e93edd284",
                "11ac0d580ca4dfb5"
            ]
        ]
    },
    {
        "id": "d2ea623ce52020d1",
        "type": "inject",
        "z": "983d8c26bcee7442",
        "name": "",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "abc",
        "payload": "34",
        "payloadType": "num",
        "x": 210,
        "y": 380,
        "wires": [
            [
                "808761aa522cee4b"
            ]
        ]
    },
    {
        "id": "39ab00e3aaf23d0e",
        "type": "function",
        "z": "983d8c26bcee7442",
        "name": "downsampleV2.1",
        "func": "/**\n * downsample v2.1 18 Oct 2025\n */\n\n/** rework so it operates on all fields in the payload */\n\n\nfunction toFix(num, precision)\n{\n  return (Math.trunc(num * (10 ** precision)))/ (10 ** precision) ;\n}\n\nconst isSet = (o, prop) => o[prop] ?? false ;\n\nconst store0 = {\n  payload : 0.0,   // last payload\n  mean : 0.0,\n  reportedMean : 0.0,\n  numSamples: 0,\n  begin: true\n}\n\nlet nodeStatus = null ;\n\nfunction deliver(msg)\n{\n  let store = context.get(msg.topic) ?? store0 ;\n  \n  // led indicates messageClass  red : digest, yellow : update, green : writeThrough\n  let colour = msg.writeThrough ? 'green' : 'yellow' ;\n  let statusText = `${msg.topic} ${store.payload}`;\n  if (msg.writeThrough || (msg.payload != store.payload))\n  {\n    statusText = `${statusText}=>${msg.payload}`;\n    store.payload = msg.payload ;\n    context.set(msg.topic, msg);\n    nodeStatus = { fill: colour, shape: \"dot\", text: statusText};\n  }\n  else\n    msg = null ;\n  \n  return msg ;\n}\n// ver 1.0 checked 22-09-2024\n\nfunction digest(msg) {\n  \n  // conditions to reset the store\n\n  let store = context.get(msg.topic);\n  if (store === undefined || msg.reset || isNaN(store.mean) ||  isNaN(store.numSamples))\n    store = store0;\n  \n  const dateNow = Date.now()\n\n  // check to see how much payload has changed\n\n  const percentageDiff = store.numSamples ? (msg.payload - store.reportedMean) * 100 * 2 / (msg.payload + store.lastMean) : 0.0;\n \n  const valueDiff1 = store.numSamples ? Math.abs(msg.payload - store.reportedMean) : 0.0;\n  const valueDiff2 = Math.abs(msg.payload - store.payload)\n  const valueTrigger = Math.max(valueDiff1, valueDiff2) >  (msg.reportOnDiff ?? 0) ;\n  //node.error(`my error message ${msg.degrees} ${msg.payload} ${valueDiff1} ${valueDiff2}`, msg);\n\n  // check if windowPeriod has been reached\n\n  let timeDiff = 0; let timeDiffLog = ''; let timeTrigger = false ;\n  if (msg.windowPeriodSecs)\n  {\n    if (store.timestamp === undefined)\n      store.timestamp = dateNow\n      if (msg.timestamp === undefined)\n        msg.timestamp = dateNow;\n    timeDiff = msg.timestamp - store.timestamp ;\n    timeDiffLog = `Δt:${ Math.round(timeDiff / 1000) }`\n    timeTrigger = timeDiff > (msg.windowPeriodSecs * 1000);\n  }\n\n  // check if window size has been reached \n\n  const windowSizeTrigger = store.numSamples + 1 >= (msg.windowSize ?? -1)\n\n \n  const endTransition = valueTrigger || timeTrigger || windowSizeTrigger ; // write every maxGap\n  \n\n  store.payload = msg.payload;\n  store.mean = (store.mean * store.numSamples + msg.payload) / (store.numSamples + 1);   // correct?\n  const storeMeanView = toFix(store.mean, 2);\n  store.numSamples += 1;\n  msg.numSamples = store.numSamples;\n  \n  const statusText = `${msg.topic} ${msg.payload} mean:${storeMeanView} num:${store.numSamples} ${timeDiffLog}`\n  /*\n   *    node.log(`${msg.topic} ${msg.lastPayload} mean: ${store.mean.toFixed(2)}, `\n   *             + `diff% ${percentageDiff}% diff:${valueDiff} numSamples:${msg.numSamples} `\n   *             + `bt ${beginTransition} et ${ endTransition }`);\n   */\n  if (store.begin || endTransition) {\n    msg.payload = storeMeanView ;\n    store.reportedMean = store.mean ;  // don't need to reset store.mean because numSamples is zero\n    store.numSamples = 0 ;\n    store.timestamp = dateNow ;\n    store.begin = false ;\n  }\n  const colour = endTransition ? 'red' : 'blue'  \n  nodeStatus = { fill: colour, shape: \"dot\", text: statusText};\n  \n  context.set(msg.topic, store);\n  return endTransition ? msg : null;\n}\n\nconst m = msg.digest ?  digest(msg) : deliver(msg);\n\nconst utils = global.get('utils')\nif (nodeStatus)\n{\n  nodeStatus.text = `${utils.getHHMMSSNow()} ${nodeStatus.text}`;\n  node.status(nodeStatus)\n}\nconst msgStatus = nodeStatus ? { topic : 'status' , payload : nodeStatus } : null ;\n\nconst logRecord = null ;\n\nreturn [[m], [m && isSet(m,'track') ? m : null], [logRecord], [msgStatus] ]\n",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 150,
        "y": 1140,
        "wires": [
            [],
            [],
            [],
            []
        ],
        "info": "key process to reduce data"
    },
    {
        "id": "4022c2129e11b456",
        "type": "switch",
        "z": "0b049155917211c7",
        "name": "bridge response",
        "property": "originalTopic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "local\\/bridge\\/response\\/networkmap.*",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": "local\\/bridge\\/response\\/.*",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 160,
        "y": 240,
        "wires": [
            [
                "a3d605b9ae5235a1",
                "2f07922ce4dbc1ad"
            ],
            [
                "155294f4c40197eb"
            ]
        ]
    },
    {
        "id": "f1b1556fc5209203",
        "type": "file",
        "z": "0b049155917211c7",
        "name": "deviceMap write",
        "filename": "/mnt/dietpi_userdata/map/devices.js",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "true",
        "encoding": "utf8",
        "x": 640,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "eba95f0550137e0d",
        "type": "debug",
        "z": "0b049155917211c7",
        "name": "unretain",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 160,
        "wires": []
    },
    {
        "id": "155294f4c40197eb",
        "type": "debug",
        "z": "0b049155917211c7",
        "name": "bridge responses",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 610,
        "y": 300,
        "wires": []
    },
    {
        "id": "a3d605b9ae5235a1",
        "type": "function",
        "z": "0b049155917211c7",
        "name": "extract map",
        "func": "\nmsg.visualtype = msg.payload.type ;\nmsg.payload = msg.payload.data.value ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 240,
        "wires": [
            [
                "f1b1556fc5209203",
                "bcc835aea255e98e"
            ]
        ]
    },
    {
        "id": "6d9def6dbe8948e8",
        "type": "function",
        "z": "0b049155917211c7",
        "name": "retain = false",
        "func": "msg.payload = {};\nif (msg.retain) \n{\n    msg.retain = false ;\n    return msg;\n}\nelse\n    return null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 160,
        "wires": [
            [
                "eba95f0550137e0d"
            ]
        ]
    },
    {
        "id": "547b95c8141f6712",
        "type": "inject",
        "z": "0b049155917211c7",
        "name": "retrieve map",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 580,
        "wires": [
            [
                "7bc3703dda5645a6"
            ]
        ]
    },
    {
        "id": "7bc3703dda5645a6",
        "type": "file in",
        "z": "0b049155917211c7",
        "name": "deviceMap read",
        "filename": "/mnt/dietpi_userdata/map/devices.js",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 380,
        "y": 580,
        "wires": [
            [
                "6f3c72f220a6ab5e"
            ]
        ]
    },
    {
        "id": "6f3c72f220a6ab5e",
        "type": "json",
        "z": "0b049155917211c7",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 130,
        "y": 500,
        "wires": [
            [
                "bcc835aea255e98e"
            ]
        ]
    },
    {
        "id": "bcc835aea255e98e",
        "type": "function",
        "z": "0b049155917211c7",
        "name": "app/response/networkMap",
        "func": "msg.topic = msg.topic.replace('bridge', 'app');\nmsg.topic = msg.topic.replace('request', 'response');\nvar units = msg.payload.nodes;\nvar links = msg.payload.links;\n\nvar nodeMap = {} ;\nfor (let i in units)\n{\n    nodeMap[units[i]['ieeeAddr']] = units[i]['friendlyName'];    \n}\n\n\nvar out=[]; \nlet dict = {};\n\n//out.push({ topic : 'link', payload : links.length});\nfor (let i in links)\n{\n    var src = nodeMap[links[i].sourceIeeeAddr]\n    var tar = nodeMap[links[i].targetIeeeAddr ]\n    var linkText = links[i].lqi + \" \" + src + \" -> \" + tar ;\n    out.push(linkText)\n    //out.push({ topic : 'link', payload : linkText });\n    let key = src   ; // + \"->\" + tar ; \n    dict[key] = links[i] ;\n}\nmsg.payload = dict ;\nreturn(msg);\nreturn([dict]);\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 500,
        "wires": [
            [
                "8b5e624bb5aaa19c",
                "8e6fb5fdc6f0bef1"
            ]
        ]
    },
    {
        "id": "95659a05514705b8",
        "type": "link in",
        "z": "0b049155917211c7",
        "name": "bridge/response",
        "links": [
            "20ef51730ad6d439",
            "73f3bd8747e9b9e9"
        ],
        "x": 45,
        "y": 160,
        "wires": [
            [
                "6d9def6dbe8948e8",
                "4022c2129e11b456"
            ]
        ]
    },
    {
        "id": "0a9719bd77581975",
        "type": "link out",
        "z": "0b049155917211c7",
        "name": "mosquitto out",
        "mode": "link",
        "links": [
            "b059487bc1ff0a2b"
        ],
        "x": 685,
        "y": 100,
        "wires": []
    },
    {
        "id": "aa15016c69354ddd",
        "type": "link in",
        "z": "0b049155917211c7",
        "name": "request/networkmap",
        "links": [
            "0c1d94776d82f5d4"
        ],
        "x": 45,
        "y": 100,
        "wires": [
            [
                "81a53326e4a74368"
            ]
        ]
    },
    {
        "id": "81a53326e4a74368",
        "type": "change",
        "z": "0b049155917211c7",
        "name": "request bridge network map in text",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "bridge/request/networkmap",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\"type\":\"raw\",\"routes\":true}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 320,
        "y": 100,
        "wires": [
            [
                "0a9719bd77581975"
            ]
        ]
    },
    {
        "id": "8b5e624bb5aaa19c",
        "type": "debug",
        "z": "0b049155917211c7",
        "name": "app response",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 580,
        "wires": []
    },
    {
        "id": "8e6fb5fdc6f0bef1",
        "type": "link out",
        "z": "0b049155917211c7",
        "name": "app responses",
        "mode": "link",
        "links": [
            "ae83978daa30c005"
        ],
        "x": 695,
        "y": 500,
        "wires": []
    },
    {
        "id": "d165bd02f725a40e",
        "type": "file in",
        "z": "0b049155917211c7",
        "name": "fetch stored map",
        "filename": "/mnt/dietpi_userdata/map/devices.js",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 630,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "e2294f8d9643f00e",
        "type": "http in",
        "z": "0b049155917211c7",
        "name": "/map",
        "url": "/map",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 90,
        "y": 40,
        "wires": [
            [
                "0b2e219aa1b54a31"
            ]
        ]
    },
    {
        "id": "0b2e219aa1b54a31",
        "type": "change",
        "z": "0b049155917211c7",
        "name": "request bridge network map in graphviz",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "bridge/request/networkmap",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\"type\":\"graphviz\",\"routes\":true}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 40,
        "wires": [
            [
                "0a9719bd77581975",
                "2f07922ce4dbc1ad",
                "8e6fb5fdc6f0bef1",
                "5b55bedef897f381"
            ]
        ]
    },
    {
        "id": "f3fb4d2769b463fb",
        "type": "http response",
        "z": "0b049155917211c7",
        "name": "/map response",
        "statusCode": "",
        "headers": {},
        "x": 620,
        "y": 360,
        "wires": []
    },
    {
        "id": "a4df3453bc7ba8da",
        "type": "template",
        "z": "0b049155917211c7",
        "name": "",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!doctype html>\n<meta charset=\"utf8\">\n<script src=\"/static/viz-standalone.js\"></script>\n<script>\n  \n  let visual = `{{{payload.data.value}}}`;\n\n  Viz.instance().then(function(viz) {\n    document.body.appendChild(viz.renderSVGElement(visual));\n  });\n  \n</script>",
        "output": "str",
        "x": 420,
        "y": 360,
        "wires": [
            [
                "f3fb4d2769b463fb"
            ]
        ]
    },
    {
        "id": "154f1ee8c4c69a62",
        "type": "debug",
        "z": "0b049155917211c7",
        "name": "bridge-debug2",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 260,
        "y": 400,
        "wires": []
    },
    {
        "id": "55db0f5201cd5d76",
        "type": "function",
        "z": "0b049155917211c7",
        "name": "map handler",
        "func": "let queue = context.get('mapRequestQueue');\n\n// is this a response with a network map ? \nif (msg.topic == 'bridge/response/networkmap') {\n\n    if (msg.payload.data.type == 'graphviz'){\n        let payload = msg.payload ;\n\n// we're going to return the original message\n\n        msg = queue.shift();\n        if (msg == undefined)\n            return null ;\n        msg.payload = payload ;\n    }\n    else\n    {\n        node.error(\"no graphviz payload\", msg);\n        return null ;\n    }    \n} \nelse if (msg.topic == 'bridge/request/networkmap')\n{\n    if (msg.req && msg.res) {\n        queue.push(msg);\n    }\n    else\n    {\n        node.error(\"req or res not set\", msg);\n    }\n    return null ;\n}\nelse msg = null ;\n\ncontext.set('mapRequestQueue', queue);\nreturn msg ;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\ncontext.set('mapRequestQueue', []);",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 360,
        "wires": [
            [
                "a4df3453bc7ba8da"
            ]
        ]
    },
    {
        "id": "5b55bedef897f381",
        "type": "debug",
        "z": "0b049155917211c7",
        "name": "debug3",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 720,
        "wires": []
    },
    {
        "id": "8a70386e56a28d02",
        "type": "inject",
        "z": "892c223a74ad0925",
        "name": "bridge health check",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "bridge/request/health_check",
        "payload": "{}",
        "payloadType": "jsonata",
        "x": 170,
        "y": 80,
        "wires": [
            [
                "2b42a705743e033e"
            ]
        ]
    },
    {
        "id": "71fb77d41d8abc20",
        "type": "debug",
        "z": "892c223a74ad0925",
        "name": "requests queued",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 610,
        "y": 160,
        "wires": []
    },
    {
        "id": "ac54334f6b9f55b8",
        "type": "inject",
        "z": "892c223a74ad0925",
        "name": "graphiz network map",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload.type",
                "v": "graphviz",
                "vt": "str"
            },
            {
                "p": "payload.routes",
                "v": "true",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "bridge/request/networkmap",
        "x": 170,
        "y": 120,
        "wires": [
            [
                "2b42a705743e033e"
            ]
        ]
    },
    {
        "id": "bf70a025a355e1da",
        "type": "inject",
        "z": "892c223a74ad0925",
        "name": "raw network map",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            },
            {
                "p": "payload.type",
                "v": "raw",
                "vt": "str"
            },
            {
                "p": "payload.routes",
                "v": "true",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "bridge/request/networkmap",
        "x": 160,
        "y": 160,
        "wires": [
            [
                "2b42a705743e033e"
            ]
        ]
    },
    {
        "id": "69cc50e848ca448c",
        "type": "inject",
        "z": "892c223a74ad0925",
        "name": "OTA update socket",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "bridge/request/device/ota_update/update",
        "payload": "socketXXX",
        "payloadType": "str",
        "x": 170,
        "y": 200,
        "wires": [
            [
                "2b42a705743e033e"
            ]
        ]
    },
    {
        "id": "7a6fc845733a5a89",
        "type": "function",
        "z": "892c223a74ad0925",
        "name": "retain = false",
        "func": "msg.payload = {};\nif (msg.retain) \n{\n    msg.retain = false ;  // looks wrong\n    return msg;\n}\nelse\n    return msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 80,
        "wires": [
            [
                "a91a2376ace8413b"
            ]
        ]
    },
    {
        "id": "a91a2376ace8413b",
        "type": "debug",
        "z": "892c223a74ad0925",
        "name": "debug 1",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 80,
        "wires": []
    },
    {
        "id": "669ba67bd6ee4e50",
        "type": "serial in",
        "z": "892c223a74ad0925",
        "name": "energy-mon-in",
        "serial": "6db0e35f8056298a",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "83e3c80df21d0aae",
                "752b2f75aed1e5c8"
            ]
        ]
    },
    {
        "id": "752b2f75aed1e5c8",
        "type": "debug",
        "z": "892c223a74ad0925",
        "name": "serial out",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 670,
        "y": 460,
        "wires": []
    },
    {
        "id": "83e3c80df21d0aae",
        "type": "function",
        "z": "892c223a74ad0925",
        "name": "energyCalc",
        "func": "\n// to do : send second sample when energy changes\n\n// code improved at St Marks.\n\nconst samplesPerMinute = 15  ;\nconst kWhPeriod =   30 ;   // minutes\nlet maxGapMinutes = 30 ;   // number of minutes between samples. \n\nlet e0 = {\n    amps : 0.0,\n    numSamples : 0,\n    numOfAmpsSamples : 0, \n    sumOfAmpsSamples : 0.0,\n    kWh : 0.0, \n    begin : true\n}\n\nfunction ampsToKW(amps)\n{\n    return(Math.round(amps * 240) / 1000);    // watts to kW \n}\n\nfunction calculatePower(ampsNow) {\n    let e = context.get(\"energy\");\n    if (e === undefined)\n        e = e0;\n\n    //let kWh = null;\n\n    e.sumOfAmpsSamples += ampsNow;\n    e.numOfAmpsSamples += 1;\n    let windowSize = samplesPerMinute * kWhPeriod;\n    if (e.numOfAmpsSamples >= windowSize) {\n        e.kWh = ampsToKW(e.sumOfAmpsSamples / e.numOfAmpsSamples);\n        e.numOfAmpsSamples = 0;\n        e.sumOfAmpsSamples = 0.0;\n    }\n\n    let beginTransition = e.begin;\n    e.begin = false;\n\n    let ampsDiff = e.numSamples ? ampsNow - e.amps : 0.0;\n    let percentageDiff = e.numSamples ? (ampsNow - e.amps) * 100 * 2 / (e.amps + ampsNow) : 0.0;\n\n    let endTransition = (Math.abs(ampsDiff) > 4 || e.numSamples >= 15 * maxGapMinutes);  // write every maxGap  \n    let writeSample = beginTransition || endTransition;\n\n    //let writeSample = percentageDiff > 60;\n    let numSamples1 = e.numSamples;\n    let kW = null;\n\n    let ampsAvg = ((e.amps * e.numSamples) + ampsNow) / (e.numSamples + 1);   // correct? \n    e.amps = ampsAvg;    // store the new average\n    e.numSamples += 1;\n\n    if (writeSample) {\n        kW = ampsToKW(ampsAvg);\n        e.numSamples = 0;\n        e.amps = 0.0;\n\n        if (endTransition)\n            e.begin = true;\n    }\n    if (false)\n        node.warn(\"now \" + ampsNow + \" avg= \" + ampsAvg.toFixed(2) + \", \"\n            + percentageDiff.toFixed(0) + \"%,  amps diff= \" + ampsDiff.toFixed(2)\n            + \" numSamples \" + numSamples1 + \" kWh \" + e.kWh + \" sum \" + e.sumOfAmpsSamples);\n\n    context.set(\"energy\", e) ;\n\n    // push out the last calculation of kWh \n    return kW ? { 'kW': kW, 'kWh': e.kWh, 'numSamples': numSamples1 } : null;\n}\n\n\n// calculate simple moving average\n// https://en.wikipedia.org/wiki/Moving_average\n// it's got a horrible shift in it.\n\nfunction calculateSMA(lastPoint, dataPoints, windowSize) {\n    let dataEmpty = {\n        points: [],\n        sum: 0.0,\n        sma: 0.0\n    }\n    const sma = 0;\n    let data = context.get(dataPoints);\n    if (data === undefined)\n        data = dataEmpty;\n\n    // add last point and remove first point\n    let numPoints = data.points.push(lastPoint); // returns new length\n\n    //let lastSMA = data.sma;\n    if (numPoints <= windowSize) {\n        data.sum += lastPoint;\n        data.sma = data.sum / numPoints;\n    }\n    else {\n        const firstPoint = data.points.shift();\n        numPoints -= 1;\n        data.sma += ((lastPoint - firstPoint) / (numPoints))\n    }\n    context.set(dataPoints, data);\n    return data.sma ;\n}\n\n\nlet ampsNow = parseFloat(msg.payload);  // parse buffer~\nmsg.topic = 'ashp0/energy'\nmsg.payload = calculatePower(ampsNow);\n\nlet kW = ampsToKW(ampsNow);\nlet sma = calculateSMA(kW, 'datapoints', samplesPerMinute * 30)\nif (msg.payload) \n    msg.payload.sma = sma ; \n\nreturn msg.payload ? msg : null ; ",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 420,
        "wires": [
            [
                "577231c552842134"
            ]
        ]
    },
    {
        "id": "e615ae11558e9741",
        "type": "file",
        "z": "892c223a74ad0925",
        "name": "WriteEnergy",
        "filename": "/mnt/dietpi_userdata/node-red/energy4.dat",
        "filenameType": "str",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "none",
        "x": 370,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "577231c552842134",
        "type": "link out",
        "z": "892c223a74ad0925",
        "name": "energy out",
        "mode": "link",
        "links": [
            "b059487bc1ff0a2b"
        ],
        "x": 540,
        "y": 340,
        "wires": []
    },
    {
        "id": "293ae4963a27a257",
        "type": "link out",
        "z": "892c223a74ad0925",
        "name": "MQTT cloud",
        "mode": "link",
        "links": [
            "ae83978daa30c005"
        ],
        "x": 615,
        "y": 640,
        "wires": []
    },
    {
        "id": "99970d5033f5f26f",
        "type": "link out",
        "z": "892c223a74ad0925",
        "name": "ASHP0",
        "mode": "link",
        "links": [
            "f61b76784c425ebd"
        ],
        "x": 615,
        "y": 700,
        "wires": []
    },
    {
        "id": "5049733e750477f4",
        "type": "comment",
        "z": "892c223a74ad0925",
        "name": "Note that the scheduler has been disconnected from ashp",
        "info": "",
        "x": 310,
        "y": 640,
        "wires": []
    },
    {
        "id": "dd793b9131285a2d",
        "type": "file in",
        "z": "892c223a74ad0925",
        "name": "read config file",
        "filename": "/mnt/dietpi_userdata/site-config.yaml",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 340,
        "y": 760,
        "wires": [
            [
                "8e01751ffc91da73"
            ]
        ]
    },
    {
        "id": "8e01751ffc91da73",
        "type": "yaml",
        "z": "892c223a74ad0925",
        "property": "payload",
        "name": "",
        "x": 510,
        "y": 760,
        "wires": [
            [
                "5e632bcd3eb2c3ec"
            ]
        ]
    },
    {
        "id": "e45e88337a59659f",
        "type": "debug",
        "z": "892c223a74ad0925",
        "name": "config",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 690,
        "y": 820,
        "wires": []
    },
    {
        "id": "5e632bcd3eb2c3ec",
        "type": "function",
        "z": "892c223a74ad0925",
        "name": "set config",
        "func": "let config = msg.payload;\nglobal.set(\"site-config-old\", config);\nnode.log('Site config old loaded for ' + config.site);\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 820,
        "wires": [
            [
                "e45e88337a59659f"
            ]
        ]
    },
    {
        "id": "9b111b1a593b741c",
        "type": "inject",
        "z": "892c223a74ad0925",
        "name": "reload",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.0",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 760,
        "wires": [
            [
                "dd793b9131285a2d"
            ]
        ]
    },
    {
        "id": "daa3ae479434d39b",
        "type": "function",
        "z": "892c223a74ad0925",
        "name": "msg store v0",
        "func": "\n/**\n * handle requests for sensor messsage recalls\n */\n\n\nfunction handleMessage(msg, instrumentation)\n{\n  if (msg.topic === undefined) \n    node.red(msg.payload)\n\n  switch(msg.topic)\n  {\n    case 'app/request/refresh' :\n    case 'get/all' :\n      // strip out the keys\n      let ar = Object.values(instrumentation)\n      node.status({ fill: \"green\", shape: \"dot\", text: `fetched ${ar.length} items`});\n      // and replay the stream of messages\n      return [] ;\n      return ar  ;\n\n    case 'clear' :\n      context.set(\"instrumentation\", {});\n      node.status({ fill: \"green\", shape: \"dot\", text: `instrumentation cleared`})\n      return [] ;\n\n    default :\n      if (isValidMessage(msg, instrumentation))\n      {\n        instrumentation[msg.topic] = msg;\n        context.set('instrumentation', instrumentation)\n      }\n      return []\n  }\n}\n\n\n// don't store items that are not objects\n\nfunction isValidMessage(msg, instrumentation)\n{\n  //node.error('abc', msg)\n  if (typeof msg !== 'object')\n  {\n    node.status({ fill: \"red\", shape: \"triange\", text: `rejecting ${msg.topic}, not an object` });\n    return false ;\n  }\n\n  if (msg.payload === undefined)\n  {\n    node.status({ fill: \"red\", shape: \"triange\", text: `rejecting ${msg.topic}, no payload` });\n    return false ;\n  }\n\n  if (!msg.timestamp)\n    msg.timestamp = Date.now()\n\n  return true ;\n}\n\n/**\n *  now timeout some messages\n **/\n\nfunction sensorHousekeeping(msg)\n{\n  const siteConfig = global.get('site-config') ?? {}\n  const sensorsKnown = Object.keys(siteConfig['sensorMap'])\n  const utils = global.get('utils')\n\n  const sensorStatus = utils.sensorStatus(sensorsKnown, instrumentation, 30, Date.now())\n  //node.error(\"my error message 2 \" + JSON.stringify(sensorStatus), msg);\n  let updates = []\n  let numTimeouts = 0\n  //    node.error(\"my error message 1b \" + JSON.stringify(sensorStatus.timedOut2), msg);\n  for (const name of sensorStatus.timedOut2) {\n    const topic = name + \"/temperature\";\n    numTimeouts += 1\n    if (instrumentation[topic] !== undefined) {\n      if (!instrumentation[topic].hasTimedOut) {\n        instrumentation[topic].hasTimedOut = true;\n        //node.error('timeout 2d ' + JSON.stringify(instrumentation[topic]))\n        updates.push(instrumentation[topic])   // push message out to dashboard\n      }\n    }\n  }\n  updates.unshift(msg);   // push current message into ds\n  \n  // save updated timeouts \n  context.set(\"instrumentation\", instrumentation ); // large write... but to memory\n  \n  const numSensors = sensorsKnown.length ;\n  const numTimedOut = sensorStatus.timedOut  ;\n  //node.error(\"my error message 3 \" + JSON.stringify(msg), msg);\n  const texxt = `${msg.topic}, ${numTimeouts} sensors timed out, total ${numSensors}`;\n  //node.status({ fill: \"green\", shape: \"dot\", text : texxt })\n  return updates ;  // send updates for messages\n}\n\n\n// save and store message if validated\nconst instrumentation = context.get(\"instrumentation\") ?? {}\nconst mqtt = handleMessage(msg, instrumentation)\n\nconst dashboardUpdates = [] //sensorHousekeeping()\n\nreturn [mqtt, dashboardUpdates];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 170,
        "y": 880,
        "wires": [
            [],
            []
        ],
        "inputLabels": [
            "data stream"
        ],
        "outputLabels": [
            "message stream",
            "timed out messages"
        ]
    },
    {
        "id": "fd11889651c04edd",
        "type": "function",
        "z": "892c223a74ad0925",
        "name": "calculate b0 v0",
        "func": "\n\n/**\n *\n * ver 1.0\n */\n\nconst timeNow = Date.now()\nconst siteConfig = global.get('site-config') ?? {}\nconst instrumentation = flow.get(\"instrumentation\") ?? {}\nconst utils = global.get('utils')\n\nconst sensorWeight =\n  [\n    { name: 'g3', weight: 1 }, // main entrance \n    { name: 'g4', weight: 1 }, // cu ground\n    { name: 'm0', weight: 2 }, // first floor corridor\n    { name: 'm3', weight: 1 }, // cu front\n  ]\n\n\n// need to move this out to app node that calculate this\n\nfunction calculateBuildingTemperature(instruments, minsTimeout) \n{ \n  const sensorsKnown = Object.keys(siteConfig['sensorMap'])\n  // note messages are stored in instruments\n  // make instrument temperatures easier to access\n  const sensorTemp = ((name) => instruments[name + '/temperature'].payload)\n\n  const sensorsReport = utils.sensorStatus(sensorsKnown, instruments, minsTimeout, timeNow)\n\n  const sensors = sensorWeight\n    // filter the sensorWeight table so only online sensors included\n    .filter((w) => (sensorsReport['online'].includes(w.name)))\n    \n    // create new map of weighted temperatures\n    .map((e) => ({  name: e.name, \n                    t: sensorTemp(e.name), \n                    wt: sensorTemp(e.name) * e.weight, w: e.weight \n                }))\n    // filter out suspect values\n    //.filter((e) => 16 < e.t && e.t < 23 && e.t != 22)\n    \n  const sensorIDs = sensors.map((e) => e.name).join(\",\")\n\n  // calculate weighted average\n  const buildingTemperature = sensors.reduce((sum, e, idx) => (sum + e.wt), 0)\n    / sensors.reduce((sum, e, idx) => (sum + e.w), 0)\n\n  node.status({\n    fill: \"yellow\", shape: \"dot\",\n    text: `${utils.getHHMM(timeNow)} b0:${buildingTemperature.toFixed(1)} [${sensorIDs}]`\n  });\n  return buildingTemperature\n}\n\n/**\n* @param {NodeMessage} msg\n*/\n\nfunction processUpdates(msg) \n{\n  const tokens = msg.topic.split(\"/\")\n  const sensorName = tokens[0]\n  const sensorProperty = tokens[1]\n\n  let b0 = null\n  let setpoint1 = null \n  let setpoint2 = null \n\n  const sensorsSelected = sensorWeight.map((e) => e.name)\n  if (sensorsSelected.includes(sensorName)) \n    if (['temperature'].includes(sensorProperty)) \n  {\n    const bt = calculateBuildingTemperature(instrumentation, 31)\n\n    // create a virtual sensor \n    b0 = {\n      topic:        'b0/temperature',\n      source:       'b0',\n      location:     'building',\n      payload:      Math.round(100 * bt) / 100, // update on 0.01 increments\n      bt0:          Math.round(100 * bt) / 100, // update on 0.01 increments\n      param:        'temperature',  // needed for influx\n      digest:       true,\n      prefix:       'local',        // pretend to be a sensor, albeit virtual, so influx stores\n      reportOnDiff: 0.1,            \n      windowPeriodSecs: 15 * 60 ,   // report every 10 minutes regardless\n      track: true                   // update status text under node\n    }\n    b0 = isNaN(bt) ? null : b0 ;\n  }\n  return b0\n}\n\nconst msgs = processUpdates(msg)\n//node.error(\"exiting dump history\" + JSON.stringify(history));\nreturn msgs",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 880,
        "wires": [
            []
        ]
    }
]